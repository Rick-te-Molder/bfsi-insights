---
import type { Publication } from '../../lib/supabase';
import CardTag from './CardTag.astro';
import {
  formatDate,
  asArray,
  stripSourceFromTitle,
  expandItemThumb,
  getDeepestTags,
  isWithinDays,
  calculateExtraTagCount,
  buildThumbnailUrl,
} from './card-utils';

interface Props {
  item: Publication;
  index?: number;
  mode?: string;
}

const { item, index = 0, mode } = Astro.props as Props;
const isHome = mode === 'home';
const isFirst = Number(index) === 0;

const displayTitle = stripSourceFromTitle(item.title, item.source_name);
const topic = asArray(item.topic) as string[];
const content_type = asArray(item.content_type) as string[];
const audience = item.audience || (item as any).role || '';
const audiences = item.audiences || [];
const industry = item.industry || '';
const industries = item.industries || [];
const geography = item.geography || '';
const geographies = item.geographies || [];
const regulators = item.regulators || [];
const regulations = item.regulations || [];
const obligations = item.obligations || [];
const processes = item.processes || [];

const deepestIndustries = getDeepestTags(industries);
const deepestGeographies = getDeepestTags(geographies);
const deepestProcesses = getDeepestTags(processes);

const extraTagCount = calculateExtraTagCount({
  audiences,
  deepestGeographies,
  deepestIndustries,
  topics: topic,
  contentTypes: content_type,
  regulators,
  regulations,
  obligations,
  deepestProcesses,
});

const isNew = isHome && isWithinDays(item.added_at, 7);
const isUpdated = isHome && !isNew && isWithinDays(item.last_edited_at, 7);
const hasImage = !!item.thumbnail || !!item.thumbnail_path;

const supabaseUrl = buildThumbnailUrl(
  item.thumbnail_path,
  item.thumbnail_bucket,
  import.meta.env.PUBLIC_SUPABASE_URL,
);
const candidates = supabaseUrl ? [supabaseUrl] : expandItemThumb(item.thumbnail);
---

<li
  class="group rounded-2xl border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900/60 p-5 shadow-sm ring-1 ring-neutral-200/40 dark:ring-neutral-800/40 transition-all hover:border-neutral-300 dark:hover:border-neutral-700 hover:ring-neutral-300 dark:hover:ring-neutral-700 hover:bg-neutral-50 dark:hover:bg-neutral-900 relative"
  aria-labelledby={`t-${item.slug}`}
  data-audience={audience}
  data-audiences={audiences.join(',') || ''}
  data-industry={industry}
  data-industries={industries.join(',') || ''}
  data-topic={topic[0] || ''}
  data-topics={(item.topics || []).join(',') || ''}
  data-content_type={content_type[0] || ''}
  data-geography={geography}
  data-geographies={geographies.join(',') || ''}
  data-regulator={regulators.join(',') || ''}
  data-regulation={regulations.join(',') || ''}
  data-obligation={obligations.join(',') || ''}
  data-process={processes.join(',') || ''}
  data-authors={Array.isArray(item.authors) ? item.authors.join(', ') : item.authors || ''}
  data-slug={item.slug}
  data-url={item.url}
  data-source_name={item.source_name || ''}
  data-title={item.title}
  data-thumbnail={item.thumbnail || ''}
  data-summary-medium={item.summary_medium || ''}
  data-date_published={item.published_at || ''}
  data-date_added={item.added_at || ''}
>
  <a
    href={`/${item.slug}`}
    class="absolute inset-0 rounded-2xl focus:outline-none focus:ring-2 focus:ring-sky-500 z-10"
    aria-label={`View details for ${item.title}`}
    tabindex="0"
    data-card-link></a>

  <div class="relative z-20 pointer-events-none flex flex-col h-full">
    <div class="flex items-center gap-2">
      <h3
        id={`t-${item.slug}`}
        class="text-xl font-semibold text-sky-700 dark:text-sky-200 line-clamp-2"
        title={displayTitle}
      >
        {displayTitle}
      </h3>
      {
        isHome && isNew && (
          <span class="ml-1 align-middle rounded-full bg-emerald-100 dark:bg-emerald-400/10 px-2 py-0.5 text-xs font-semibold text-emerald-700 dark:text-emerald-300 ring-1 ring-inset ring-emerald-300 dark:ring-emerald-400/30">
            New
            <span class="sr-only"> - published within the last 7 days</span>
          </span>
        )
      }
      {
        isHome && isUpdated && (
          <span class="ml-1 align-middle rounded-full bg-amber-100 dark:bg-amber-400/10 px-2 py-0.5 text-xs font-semibold text-amber-700 dark:text-amber-300 ring-1 ring-inset ring-amber-300 dark:ring-amber-400/30">
            Updated
            <span class="sr-only"> - modified within the last 7 days</span>
          </span>
        )
      }
    </div>

    <div class="relative mt-1 text-sm text-neutral-700 dark:text-neutral-200">
      <span
        class="date-display"
        data-published={formatDate(item.published_at ?? undefined)}
        data-added={formatDate(item.added_at ?? undefined)}
      >
        <span class="date-label text-neutral-600 dark:text-neutral-400">Published</span>
        <span class="date-value">{formatDate(item.published_at ?? undefined)}</span>
      </span>
      {
        item.source_name && (
          <span class="text-neutral-600 dark:text-neutral-200"> · {item.source_name}</span>
        )
      }
      {item.authors?.length > 0 && <span> · {item.authors[0]}</span>}
    </div>

    <!-- Collapsed view: Thumbnail + short summary -->
    <div class="card-collapsed">
      <!-- Thumbnail area (fixed height) -->
      <div
        class="relative mt-2 w-full h-48 rounded-md border border-neutral-200 dark:border-neutral-800 bg-neutral-100 dark:bg-neutral-800/40 overflow-hidden"
      >
        {
          hasImage ? (
            <>
              <div class="absolute inset-0 rounded-md bg-neutral-800/40" />
              <img
                src={candidates[0]}
                data-next={candidates.slice(1).join('|')}
                alt={`${item.source_name || 'Source'} preview`}
                width={isFirst ? 960 : 640}
                height={isFirst ? 540 : 360}
                loading={isFirst ? 'eager' : 'lazy'}
                fetchpriority={isFirst ? 'high' : 'auto'}
                decoding="async"
                referrerpolicy="no-referrer"
                sizes="(min-width: 1024px) 560px, (min-width: 640px) 480px, 100vw"
                class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-300"
              />
            </>
          ) : (
            <div class="absolute inset-0 flex items-center justify-center">
              <svg
                class="h-10 w-10 text-neutral-700"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                />
              </svg>
            </div>
          )
        }
      </div>

      {
        item.summary_short && (
          <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-300 line-clamp-2">
            {item.summary_short}
          </p>
        )
      }
    </div>

    <!-- Expanded view: Medium summary only -->
    <div class="card-expanded hidden">
      <div
        class="mt-2 max-h-48 overflow-y-auto rounded-md border border-neutral-200 dark:border-neutral-800 bg-neutral-100 dark:bg-neutral-800/40 p-3"
      >
        {
          item.summary_medium ? (
            <p class="text-sm text-neutral-600 dark:text-neutral-300">{item.summary_medium}</p>
          ) : (
            <p class="text-sm text-neutral-400 dark:text-neutral-500 italic">
              No summary available
            </p>
          )
        }
      </div>
    </div>

    <!-- Tags row - pushed to bottom, with expand button inline -->
    <div class="mt-auto pt-3 flex items-end justify-between gap-2">
      <div class="flex flex-wrap items-center gap-1.5">
        {
          audience && (
            <CardTag
              label={audience}
              ariaLabel={`Audience: ${audience}`}
              variant="audience"
              icon="user"
            />
          )
        }
        {
          geography && (
            <CardTag
              label={geography}
              ariaLabel={`Geography: ${geography}`}
              variant="geography"
              icon="globe"
            />
          )
        }
        {
          extraTagCount > 0 && (
            <button
              type="button"
              data-expand-card="true"
              class="card-collapsed-only inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-neutral-200 dark:bg-neutral-700/50 text-neutral-600 dark:text-neutral-400 ring-1 ring-inset ring-neutral-300 dark:ring-neutral-600/30 hover:bg-neutral-300 dark:hover:bg-neutral-600/50 hover:text-neutral-700 dark:hover:text-neutral-300 transition-colors pointer-events-auto"
            >
              +{extraTagCount} more
            </button>
          )
        }
        {
          deepestIndustries.map((i: string) => (
            <CardTag label={i} variant="industry" expandedOnly />
          ))
        }
        {topic.map((t: string) => <CardTag label={t} variant="topic" expandedOnly />)}
        {regulators.map((r: string) => <CardTag label={r} variant="regulator" expandedOnly />)}
        {regulations.map((r: string) => <CardTag label={r} variant="regulation" expandedOnly />)}
        {deepestProcesses.map((p: string) => <CardTag label={p} variant="process" expandedOnly />)}
      </div>
      <!-- Expand/Collapse button - inline with tags, aligned at bottom -->
      <button
        class="shrink-0 inline-flex items-center justify-center gap-1 text-sm text-sky-600 dark:text-sky-300 hover:text-sky-700 dark:hover:text-sky-200 transition-colors px-2 py-0.5 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800/50 focus:outline-none focus:ring-2 focus:ring-sky-500 pointer-events-auto"
        type="button"
        data-expand-card="true"
        aria-expanded="false"
        aria-label="Expand card to show more details"
      >
        <span class="expand-label">Expand</span>
        <span class="collapse-label hidden">Collapse</span>
      </button>
    </div>
  </div>
</li>
