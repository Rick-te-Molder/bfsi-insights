---
export const prerender = true;

import rss from '@astrojs/rss';
import { getAllPublications } from '../lib/supabase';

const publications = await getAllPublications();

const feedTitle = 'BFSI Insights â€“ Latest Publications';
const feedDescription =
  'Agentic AI insights for executives, professionals, and researchers in banking, financial services and insurance.';

const items = [...publications]
  .filter((item) => typeof item.added_at === 'string' && item.added_at.length > 0)
  .sort((a, b) => {
    const da = new Date(a.added_at as string).getTime();
    const db = new Date(b.added_at as string).getTime();
    return db - da;
  })
  .slice(0, 50)
  .map((item) => {
    const categories = [item.audience, item.industry, item.topic].filter(Boolean) as string[];

    const author =
      Array.isArray(item.authors) && item.authors.length > 0 ? String(item.authors[0]) : undefined;

    const noteVal = (item as any).note;
    const description =
      typeof noteVal === 'string' ? noteVal : (item.source_name ?? '').trim() || undefined;

    return {
      title: item.title,
      description,
      link: item.url,
      pubDate: new Date(item.added_at as string),
      categories,
      author,
    };
  });

const feed = rss({
  title: feedTitle,
  description: feedDescription,
  site: new URL('https://www.bfsiinsights.com/'),
  items,
  stylesheet: true,
});

Astro.response.headers.set('Content-Type', 'application/xml; charset=utf-8');
---

{feed}
