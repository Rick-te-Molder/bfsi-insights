---
// Static for performance - rebuilds on article approval
export const prerender = true;

import Base from '../layouts/Base.astro';
import { getAllPublications } from '../lib/supabase';
import type { Publication } from '../lib/supabase';
import { getSupabaseClient } from '../lib/supabase';
import PublicationCard from '../features/publications/PublicationCard.astro';

// Fetch enough publications to ensure we have 6 per persona
const allPublications: Publication[] = await getAllPublications();

// Supabase client for audience metadata
const supabase = getSupabaseClient();
const publicSupabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;

// Load audience types from kb_audience (with fallback for pre-migration builds)
const { data: audienceData, error: audienceError } = supabase
  ? await supabase
      .from('kb_audience')
      .select('value, label')
      .order('sort_order', { ascending: true })
  : { data: null, error: new Error('Missing Supabase env vars') };

// Fallback values if table doesn't exist yet (pre-migration) or returns empty
const fallbackAudiences = [
  { value: 'executive', label: 'Executives' },
  { value: 'functional_specialist', label: 'Functional Specialists' },
  { value: 'engineer', label: 'Engineers' },
  { value: 'researcher', label: 'Researchers' },
];

// Try kb_role as legacy fallback if kb_audience doesn't exist
let finalAudienceData = audienceData;
if (audienceError || !audienceData || audienceData.length === 0) {
  if (supabase) {
    const { data: legacyData } = await supabase
      .from('kb_role')
      .select('value, label')
      .order('sort_order', { ascending: true });
    finalAudienceData = legacyData;
  }
}

const audienceOptions = (
  finalAudienceData && finalAudienceData.length > 0 ? finalAudienceData : fallbackAudiences
).map((a) => ({
  value: a.value,
  label: a.label,
}));

const validAudiences = audienceOptions.map((a) => a.value);

// Get 6 most recent from each audience
// Note: uses p.audiences array (primary) with fallback to p.audience (singular)
const byAudience = validAudiences.reduce<Record<string, Publication[]>>((acc, audience) => {
  acc[audience] = allPublications
    .filter((p) => {
      // Check if audience is in audiences array, or matches singular audience field
      const audiences = p.audiences || [];
      const primaryAudience = p.audience || (p as any).role;
      return audiences.includes(audience) || primaryAudience === audience;
    })
    .slice(0, 6);
  return acc;
}, {});

const audienceOptionsWithCounts = audienceOptions.map((option) => ({
  ...option,
  count: byAudience[option.value]?.length ?? 0,
}));

// Combine all, dedupe
const allByAudience: Publication[] = Object.values(byAudience).flat();
const latest: Publication[] = Array.from(
  new Map(allByAudience.map((item) => [item.id, item])).values(),
);

const expandItemThumb = (t?: string | null) => {
  if (!t) return [];
  if (/\.(webp|png|jpe?g)$/i.test(t)) return [t];
  if (t.startsWith('http://') || t.startsWith('https://')) return [t];
  return [`${t}.webp`, `${t}.png`, `${t}.jpg`];
};
---

<Base title="BFSI Insights">
  {
    (() => {
      const first = latest?.[0];
      if (!first) return null;

      let href = null;
      if (first.thumbnail_path && first.thumbnail_bucket) {
        if (publicSupabaseUrl) {
          href = `${publicSupabaseUrl}/storage/v1/object/public/${first.thumbnail_bucket}/${first.thumbnail_path}`;
        }
      } else if (first.thumbnail) {
        const candidates = expandItemThumb(first.thumbnail);
        href = candidates[0];
      }

      return href ? (
        <Fragment slot="head">
          <link rel="preload" as="image" href={href} />
        </Fragment>
      ) : null;
    })()
  }

  <!-- Hero -->
  <section class="mb-8 text-center">
    <h2 class="text-3xl font-bold tracking-tight">BFSI Insights</h2>
    <p class="mt-2 text-neutral-600 dark:text-neutral-300">
      Agentic AI insights for executives, professionals, and researchers in banking, financial
      services and insurance.
    </p>
  </section>

  <!-- Latest Publications -->
  <section>
    <div class="mb-4 flex items-center justify-between flex-wrap gap-3">
      <h3 class="text-xl font-semibold">Latest</h3>

      <div class="flex items-center gap-3">
        <label for="persona-filter" class="text-sm text-neutral-600 dark:text-neutral-400"
          >Audience view:</label
        >

        <select
          id="persona-filter"
          class="rounded-lg border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-1.5 text-sm text-neutral-700 dark:text-neutral-300 focus:outline-none focus:ring-2 focus:ring-sky-500"
        >
          <option value="all">Everyone ({latest.length})</option>
          {
            audienceOptionsWithCounts.map((a) => (
              <option value={a.value}>
                {a.label} ({a.count})
              </option>
            ))
          }
        </select>

        <a
          href="/publications"
          class="text-sm font-medium link-secondary underline underline-offset-2 focus:outline-none focus:ring-2 focus:ring-sky-500"
        >
          Browse all â†’
        </a>
      </div>
    </div>

    <ul id="publications-grid" class="grid gap-6 sm:grid-cols-2">
      {latest.map((item, idx) => <PublicationCard item={item} index={idx} mode="home" />)}
    </ul>
  </section>

  <script
    id="valid-audiences-data"
    type="application/json"
    set:html={JSON.stringify(validAudiences)}
  />

  <!-- Audience filter -->
  <script type="module">
    // @ts-check
    /**
     * @returns {string[]}
     */
    function getValidAudiences() {
      const el = document.getElementById('valid-audiences-data');
      if (!el || !el.textContent) return [];
      try {
        const parsed = JSON.parse(el.textContent);
        return Array.isArray(parsed) ? parsed.map(String) : [];
      } catch {
        return [];
      }
    }

    /** @param {HTMLSelectElement} filterEl @param {string[]} audiences */
    function applyInitialAudience(filterEl, audiences) {
      const saved = localStorage.getItem('bfsi-audience-preference');
      const fallback = 'executive';
      if (saved && saved !== 'all' && audiences.includes(saved)) return saved;
      localStorage.setItem('bfsi-audience-preference', fallback);
      return fallback;
    }

    /** @param {HTMLElement} gridEl @param {string} audience */
    function filterCards(gridEl, audience) {
      /** @type {HTMLElement[]} */
      const cards = Array.from(gridEl.children).filter((child) => child instanceof HTMLElement);
      cards.forEach((card) => {
        const cardAudience = card.getAttribute('data-audience');
        card.style.display = audience === 'all' || cardAudience === audience ? '' : 'none';
      });
    }

    function initAudienceFilter() {
      const filterEl = document.getElementById('persona-filter');
      if (!(filterEl instanceof HTMLSelectElement)) return;
      const gridEl = document.getElementById('publications-grid');
      if (!(gridEl instanceof HTMLElement)) return;

      const audiences = getValidAudiences();
      filterEl.value = applyInitialAudience(filterEl, audiences);
      filterCards(gridEl, filterEl.value);
      filterEl.addEventListener('change', () => {
        localStorage.setItem('bfsi-audience-preference', filterEl.value);
        filterCards(gridEl, filterEl.value);
      });
    }

    if (document.readyState === 'loading')
      window.addEventListener('DOMContentLoaded', initAudienceFilter);
    else initAudienceFilter();
  </script>

  <!-- Image enhancement -->
  <script type="module">
    // @ts-check
    /**
     * @param {Document | HTMLElement} [root]
     */
    /** @param {HTMLElement | null} placeholder @param {HTMLImageElement} img */
    function hidePlaceholderAndShowImage(placeholder, img) {
      img.classList.remove('opacity-0');
      if (placeholder) placeholder.style.display = 'none';
    }

    /** @param {HTMLElement | null} placeholder @param {HTMLImageElement} img */
    function advanceFallbackImage(placeholder, img) {
      const n = img.dataset?.next ?? '';
      if (n) {
        const parts = n.split('|');
        const nx = parts.shift();
        img.dataset.next = parts.join('|');
        if (nx) {
          img.src = nx;
          return;
        }
      }
      img.style.display = 'none';
      if (placeholder) placeholder.style.display = 'none';
    }

    /** @param {Document | HTMLElement} [root] */
    function enhanceImages(root) {
      const container = root ?? document;
      /** @type {HTMLImageElement[]} */
      const imgs = Array.from(container.querySelectorAll('li.group img')).filter(
        (img) => img instanceof HTMLImageElement,
      );

      imgs.forEach((img) => {
        const placeholder =
          img.previousElementSibling instanceof HTMLElement ? img.previousElementSibling : null;
        const onload = () => hidePlaceholderAndShowImage(placeholder, img);
        const onerror = () => advanceFallbackImage(placeholder, img);
        img.addEventListener('load', onload, { once: true });
        img.addEventListener('error', onerror);
        if (img.complete) (img.naturalWidth > 0 ? onload : onerror)();
      });
    }

    if (document.readyState === 'loading')
      window.addEventListener('DOMContentLoaded', () => enhanceImages());
    else enhanceImages();
  </script>

  <!-- Card expand/collapse -->
  <script>
    import initCardExpand from '../features/publications/card-expand.ts';
    initCardExpand();
  </script>
</Base>
