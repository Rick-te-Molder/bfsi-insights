---
import FilterGroup from './FilterGroup.astro';
import CheckboxChips from './CheckboxChips.astro';
import HierarchicalFilter from './HierarchicalFilter.astro';
import type { TaxonomyItem, FilterValue, FilterConfig } from '../lib/publications-data';

interface Props {
  flatFilters: FilterConfig[];
  values: Record<string, FilterValue[]>;
  industryWithCounts: TaxonomyItem[];
  processWithCounts: TaxonomyItem[];
  geographyWithCounts: TaxonomyItem[];
}

const { flatFilters, values, industryWithCounts, processWithCounts, geographyWithCounts } =
  Astro.props;

const audienceFilter = flatFilters.find((f) => f.column_name === 'audience');
const audienceValues = audienceFilter ? values[audienceFilter.column_name] || [] : [];
const topicFilter = flatFilters.find((f) => f.column_name === 'topic');
const topicValues = topicFilter ? values[topicFilter.column_name] || [] : [];
const contentTypeFilter = flatFilters.find((f) => f.column_name === 'content_type');
const contentTypeValues = contentTypeFilter ? values[contentTypeFilter.column_name] || [] : [];
const otherFilters = flatFilters.filter(
  (f) => !['audience', 'topic', 'content_type'].includes(f.column_name),
);
---

<div id="filter-panel" class="fixed inset-0 z-50 hidden">
  <div id="panel-backdrop" class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>

  <div
    role="dialog"
    aria-modal="true"
    aria-labelledby="panel-title"
    class="absolute inset-0 sm:inset-4 sm:rounded-2xl filter-panel-bg border flex flex-col overflow-hidden"
  >
    <!-- Header -->
    <div
      class="flex items-center justify-between px-4 py-3 border-b border-neutral-200 dark:border-neutral-800"
    >
      <div class="flex items-center gap-3">
        <h3 id="panel-title" class="text-lg font-semibold text-primary">Filters</h3>
        <span id="panel-result-count" class="text-sm text-secondary">
          <span id="panel-count-number" class="font-semibold text-sky-300">0</span> results
        </span>
      </div>
      <button
        id="close-panel"
        class="rounded-lg p-2 text-neutral-500 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors"
        aria-label="Close filters"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Filter groups (scrollable) -->
    <div class="flex-1 overflow-y-auto p-4">
      <div class="max-w-3xl mx-auto space-y-3">
        <!-- Audience Filter -->
        {
          audienceFilter && audienceValues.length > 0 && (
            <FilterGroup title="Audience" filterKey="audience" open>
              <CheckboxChips
                name="filter-audience"
                values={audienceValues}
                display="label"
                checkedClasses="peer-checked:border-amber-500 peer-checked:bg-amber-500/10 peer-checked:text-amber-600 dark:peer-checked:text-amber-300"
              />
            </FilterGroup>
          )
        }

        <!-- Geography Filter -->
        <FilterGroup title="Geography" filterKey="geography">
          <HierarchicalFilter
            filterKey="geography"
            items={geographyWithCounts}
            color="sky"
            emptyMessage="No geography tags yet"
            cascadeClass="geography"
            flattenRoots={['global']}
          />
        </FilterGroup>

        <!-- Industry Filter -->
        <FilterGroup title="Industry" filterKey="industry" open>
          <HierarchicalFilter
            filterKey="industry"
            items={industryWithCounts}
            color="cyan"
            emptyMessage="No industry tags yet"
            cascadeClass="industry"
          />
        </FilterGroup>

        <!-- Topic Filter -->
        {
          topicFilter && topicValues.length > 0 && (
            <FilterGroup title="Topic" filterKey="topic">
              <CheckboxChips
                name="filter-topic"
                values={topicValues}
                display="label"
                checkedClasses="peer-checked:border-violet-500 peer-checked:bg-violet-500/10 peer-checked:text-violet-600 dark:peer-checked:text-violet-300"
              />
            </FilterGroup>
          )
        }

        <!-- Content Type Filter -->
        {
          contentTypeFilter && contentTypeValues.length > 0 && (
            <FilterGroup title="Content Type" filterKey="content_type">
              <CheckboxChips
                name="filter-content_type"
                values={contentTypeValues}
                display="label"
                checkedClasses="peer-checked:border-rose-500 peer-checked:bg-rose-500/10 peer-checked:text-rose-600 dark:peer-checked:text-rose-300"
              />
            </FilterGroup>
          )
        }

        <!-- Process Filter -->
        <FilterGroup title="Process" filterKey="process">
          <HierarchicalFilter
            filterKey="process"
            items={processWithCounts}
            color="emerald"
            emptyMessage="No process tags yet"
            cascadeClass="process"
          />
        </FilterGroup>

        <!-- Other flat filters -->
        {
          otherFilters.map((filter) => {
            const filterValues = values[filter.column_name] || [];
            if (filterValues.length === 0) return null;
            return (
              <FilterGroup title={filter.display_label} filterKey={filter.column_name}>
                <CheckboxChips
                  name={`filter-${filter.column_name}`}
                  values={filterValues}
                  display="value"
                  showCount
                  checkedClasses="peer-checked:border-sky-500 peer-checked:bg-sky-500/10 peer-checked:text-sky-600 dark:peer-checked:text-sky-300"
                />
              </FilterGroup>
            );
          })
        }
      </div>
    </div>

    <!-- Footer -->
    <div
      class="px-4 py-3 border-t border-neutral-200 dark:border-neutral-800 flex items-center justify-between gap-4"
    >
      <button
        id="clear-all-filters"
        class="px-4 py-2 text-sm font-medium text-neutral-500 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white transition-colors"
      >
        Clear all
      </button>
      <button
        id="apply-filters"
        class="px-6 py-2 rounded-lg bg-sky-600 text-sm font-medium text-white hover:bg-sky-500 transition-colors"
      >
        Show results
      </button>
    </div>
  </div>
</div>
