# BFSI Insights Coding Practices

This file contains project-specific coding rules for AI assistants (Windsurf/Cursor).
These rules are learned from bugs, incidents, and code reviews.

---

## Data Consistency

### Pipeline Status Queries (KB-202)
- **Always use `status_code`** (numeric) for pipeline status queries, never `status` (text)
- When querying `ingestion_queue`, always select the `status_code` field
- Status codes are defined in `docs/architecture/pipeline-status-codes.md`:
  - `200` = PENDING_ENRICHMENT
  - `300` = PENDING_REVIEW (items ready for human review)
  - `330` = APPROVED
  - `400` = PUBLISHED
  - `500` = FAILED
  - `540` = REJECTED

### Query Pattern Consistency
- Dashboard and all UI views must use **identical query logic** for the same data
- No client-side filtering that duplicates or contradicts DB-level filters
- When adding a new view of existing data, check how other views query it first

---

## TypeScript / React

### Unused Variables
- Prefix intentionally unused variables with `_` (e.g., `status: _status`)
- Remove truly unused imports/variables rather than prefixing

### React Hooks
- Define `useCallback` handlers **before** `useEffect` hooks that reference them
- Include all dependencies in useEffect/useCallback dependency arrays
- Use `useMemo` for expensive computations, with eslint-disable if needed for impure functions

### Component Props
- Keep prop names consistent across interface and destructuring
- Use `propName: _propName` syntax when prop is required but unused locally

---

## Linting (KB-204)

### Strict Policy: Zero Errors AND Zero Warnings
- Run `npm run lint` in admin-next before every commit
- **Must pass with 0 errors AND 0 warnings**
- Fix all warnings, don't just leave them

### Exception Process
If a warning cannot be fixed (e.g., third-party library issue, intentional pattern):
1. **STOP and ask user for approval** before committing
2. Explain: what the warning is, why it can't be fixed, what the risk is
3. User must explicitly approve skipping the warning
4. If approved, add `eslint-disable` with a comment explaining why

### eslint-disable Rules
- Never add eslint-disable without user approval or clear justification
- Always include a comment explaining why the disable is needed
- Prefer fixing the issue over disabling the rule

---

## Git Workflow

- Never commit directly to main
- Branch naming: `feat/kb-XXX-desc`, `fix/kb-XXX-desc`, `improve/kb-XXX-desc`
- Include Linear issue ID in commits: `fix(KB-XXX): description`
- Create PR immediately after first push to start CI

---

## Adding New Rules

When you encounter a bug or incident:
1. Identify the **root cause pattern** (not just the symptom)
2. Add a rule here that would have prevented it
3. Include the Linear issue ID for context (e.g., KB-202)

---

## Database Schema

### Primary Keys
- **Always use UUID** as primary key for new tables (not serial integers or text slugs)
- Use `gen_random_uuid()` as default value
- Text slugs (like `name`) should be unique constraints, not primary keys
- Example: `id UUID PRIMARY KEY DEFAULT gen_random_uuid()`

### Single Source of Truth
- Define business concepts (audiences, statuses, etc.) in ONE table
- LLM prompts should reference these tables, not hardcode definitions
- When updating a concept, update the source table - prompts pull dynamically

---

## Prompt Engineering (KB-207)

### Agent Registry
- Every agent must be declared in `docs/agents/manifest.yaml`
- Manifest defines required prompts and tables for each agent
- CI validates prompt coverage on every PR

### Prompt Changes
- Every prompt change requires a migration file in `supabase/migrations/`
- Use `INSERT ... ON CONFLICT` pattern for safe updates
- Set `is_current = true` for new version, `false` for old versions
- Include `notes` explaining what changed and why

### Fail-Fast Policy
- Agents must throw errors if required prompts are missing
- No silent fallbacks to hardcoded prompts
- Use `throw new Error('CRITICAL: ...')` pattern from KB-206

### Dynamic Prompts
- Business concept definitions (audiences, taxonomies) should be in DB tables
- Prompts should load definitions from tables, not hardcode them
- Example: `kb_audience` table contains scoring guides loaded by discovery-relevance
