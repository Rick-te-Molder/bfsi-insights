```
# BFSI Insights Coding Practices (.windsurfrules)

Project-specific rules for AI assistants (Windsurf/Cursor).
These rules come from bugs, incidents, and code reviews.

---

## 0. Meta rules

### 0.1 No claims without evidence (hard rule)
Do not say “fixed”, “works”, “tests pass”, “coverage improved”, “CI is green”, or similar **unless** you include quoted evidence from:
- local command output, or
- CI logs.

If you cannot produce evidence, say exactly what is unverified.

### 0.2 Small diffs only (hard rule)
One concern per change/commit.
If multiple concerns exist, split into multiple commits and present them separately.

### 0.3 Verify locally before responding (hard rule)
For `services/agent-api` test/coverage work, include excerpts from:
- `npm run test:coverage -w services/agent-api`
- plus targeted proof for touched files (e.g., `grep` on the coverage table).

For CI workflow edits, paste the literal diff of the workflow change.

---

## 1. Git workflow (no PRs, feature branches)

- Never commit directly to `main`.
- Always work on a feature branch.
- No Pull Requests (do not create PRs).
- Branch naming: chosen by the assistant, must be:
  - short, descriptive, lowercase
  - `/` and `-` only
  - examples: `fix/sonar-lcov`, `feat/replay-tests`, `chore/ci-supabase-retry`

### 1.1 Pre-commit checks (required)
Before every `git commit`, run and confirm:
1. `git branch --show-current` (must not be `main`)
2. `git status --porcelain` (only intended changes)
3. `npm run lint` in `admin-next` (0 errors, 0 warnings)
4. If you touched SIG-gated files: the pre-commit hook must pass (no bypass)

### 1.2 Commit messages
- Use conventional commits: `fix:`, `feat:`, `chore:`, `refactor:`, `test:`
- Add KB references in the body when relevant (optional in subject):
  - `Refs: KB-202`

---

## 2. Data consistency

### 2.1 Pipeline Status Queries (KB-202)
- Always use `status_code` (numeric) for pipeline status queries, never `status` (text).
- Load status codes from `status_lookup` (single source of truth).
- Never hardcode status code values; query `status_lookup` at runtime.
- Docs: `docs/architecture/pipeline-status-codes.md`
- Reference: `services/agent-api/src/lib/status-codes.js`

### 2.2 Query Pattern Consistency
- Dashboard and all UI views must use identical query logic for the same data.
- No client-side filtering that duplicates or contradicts DB-level filters.
- When adding a new view of existing data, check how other views query it first.

---

## 3. TypeScript / React

### 3.1 Unused variables
- Prefix intentionally unused variables with `_` (e.g., `status: _status`).
- Remove truly unused imports/variables rather than prefixing.

### 3.2 React hooks
- Define `useCallback` handlers before `useEffect` hooks that reference them.
- Include all dependencies in dependency arrays.
- Use `useMemo` for expensive computations; only disable lint with justification + comment.

### 3.3 Component props
- Keep prop names consistent across interface and destructuring.
- Use `propName: _propName` when prop is required but unused locally.

---

## 4. Linting (KB-204)

### 4.1 Strict policy: zero errors AND zero warnings
- Run `npm run lint` in `admin-next` before every commit.
- Must pass with 0 errors and 0 warnings.

### 4.2 Exception process
If a warning cannot be fixed:
1. Stop and ask the user for approval before committing.
2. Explain: what the warning is, why it cannot be fixed, and the risk.
3. Only proceed after explicit approval.
4. If approved, add the smallest-scoped `eslint-disable` plus a comment that explains why.

---

## 5. Prompt engineering (KB-207)

### 5.1 Agent registry
- Every agent must be declared in `docs/agents/manifest.yaml`.
- Manifest defines required prompts and tables for each agent.
- CI validates prompt coverage on every run of the relevant workflows.

### 5.2 Prompt changes
- Every prompt change requires a migration in `supabase/migrations/`.
- Use safe update patterns (prefer `INSERT ... ON CONFLICT` where appropriate).
- Set `is_current = true` for the new version and `false` for the old version.
- Include `notes` explaining what changed and why.

### 5.3 Fail-fast
- Agents must throw if required prompts are missing.
- No silent fallbacks to hardcoded prompts.
- Use `throw new Error('CRITICAL: ...')`.

### 5.4 Prompt version migrations (KB-258)
- Always INSERT new rows for prompt versions; never UPDATE existing rows.
- Pattern:
  ```sql
  UPDATE prompt_version
    SET is_current = false
    WHERE agent_name = 'X' AND is_current = true;

  INSERT INTO prompt_version (agent_name, version, prompt_text, is_current, notes)
    VALUES (...);


⸻

6. Taxonomy & tags (KB-219)

Use taxonomy_config for dynamic tag insertion
	•	Never hardcode tag types in approve handlers.
	•	Always query taxonomy_config for junction mappings.

Pattern:

const { data: configs } = await supabase
  .from('taxonomy_config')
  .select('payload_field, junction_table, junction_code_column')
  .eq('is_active', true)
  .not('junction_table', 'is', null);

for (const config of configs) {
  const codes = payload[config.payload_field];
  if (codes?.length) {
    await supabase.from(config.junction_table).insert(...);
  }
}


⸻

7. Database schema

7.1 Primary keys
	•	Always use UUID as primary key for new tables.
	•	Use gen_random_uuid() as default value.
	•	Text slugs are unique constraints, not primary keys.

7.2 Single source of truth
	•	Define business concepts (audiences, statuses, etc.) in one table.
	•	Prompts must reference these tables; do not hardcode definitions.

⸻

8. Code quality (KB-151)

8.1 Boy Scout rule
	•	All touched files must meet SIG guidelines (no exceptions).
	•	Files: < 300 lines.
	•	Functions: < 30 lines (should be < 15).
	•	Pre-commit hook scripts/check-large-files.cjs enforces this for staged files.
	•	Known violations are tracked in the hook’s ALLOW_LIST; touching those files requires refactor to pass.

8.2 When blocked by size violations
	1.	Extract helper functions to separate modules.
	2.	Split large files into multiple focused files.
	3.	Apply single-responsibility.
	4.	Name functions for what they do.

⸻

9. Required “done” response format

When you say you are done, use exactly:
	•	Evidence:
	•	<paste command output / CI log lines>
	•	Diff summary:
	•	<files changed + why>
	•	Remaining risks / unverified:
	•	<explicit list, or “none”>
```