# BFSI Insights Coding Practices (.windsurfrules)

Project-specific rules for AI assistants (Windsurf/Cursor).
These rules exist because bugs, incidents, and CI failures happened.

**Quality System**: This file implements controls from [docs/architecture/quality-system.md](cci:7://file:///Users/micro/projects/bfsi-insights/docs/architecture/quality-system.md:0:0-0:0).

---

## Data Consistency (C4)

### Pipeline Status Queries
- Always use `status_code` (numeric) for pipeline status queries, never `status` (text).
- Load status codes from the `status_lookup` table (single source of truth).
- Never hardcode status code values; query `status_lookup` at runtime.
- Reference: `services/agent-api/src/lib/status-codes.js`
- Docs: `docs/architecture/pipeline-status-codes.md`

### Query Pattern Consistency
- Dashboard and all UI views must use identical query logic for the same data.
- No client-side filtering that duplicates or contradicts DB-level filters.
- When adding a new view of existing data, check how other views query it first.

---

## TypeScript / React

### Unused Variables
- Prefix intentionally unused variables with `_` (e.g., `status: _status`).
- Remove truly unused imports/variables rather than prefixing.

### React Hooks
- Define `useCallback` handlers before `useEffect` hooks that reference them.
- Include all dependencies in dependency arrays.
- Use `useMemo` for expensive computations (eslint-disable only with justification).

### Component Props
- Keep prop names consistent across interface and destructuring.
- Use `propName: _propName` when required but unused locally.

---

## Linting (C5)

### Strict Policy: Zero Errors AND Zero Warnings
- Run `npm run lint -w admin` before every commit.
- Must pass with 0 errors AND 0 warnings.

### Exception Process
If a warning cannot be fixed:
1. Stop and ask user for approval before committing.
2. Explain: warning, why it can't be fixed, risk.
3. If approved: add `eslint-disable` with a comment explaining why.
4. Document in [docs/architecture/quality/exceptions.md](cci:7://file:///Users/micro/projects/bfsi-insights/docs/architecture/quality/exceptions.md:0:0-0:0).

---

## Git Workflow

### Core rules
- Never commit directly to `main`.
- Use feature branches.
- PRs are required for merging into `main`.

### Branch naming
- `feat/kb-XXX-desc`
- `fix/kb-XXX-desc`
- `improve/kb-XXX-desc`
- If no KB exists yet, use `feat/misc-desc` / `fix/misc-desc`.

### Commit message
- Prefer: `fix(KB-XXX): description` / `feat(KB-XXX): description`
- If no KB: `fix: description` / `feat: description`

### PR discipline
- One concern per PR (small diffs only).
- If multiple concerns exist, split into multiple PRs.
- Keep PRs short-lived; rebase when needed.

---

## CI Strategy: Fast vs Slow (C8)

### Fast CI (runs on PRs)
Fast CI is the gate for merging.
It must be quick and deterministic.

Fast CI should include:
- Lint (admin, and any other lint jobs you maintain)
- Unit tests + coverage (especially `services/agent-api`)
- Build checks (e.g., Next/Astro build)
- Typecheck (if separate)

Fast CI must NOT include:
- Supabase CLI jobs that hit network or remote DB
- Schema doc generation
- Long-running integration/E2E
- Heavy scans that are slow/flaky

### Slow CI (runs on main or schedule)
Slow CI can be:
- `push` to `main` (post-merge), and/or
- scheduled (nightly), and/or
- manual (`workflow_dispatch`)

Slow CI can include:
- Supabase lint / remote DB checks
- Schema docs update
- E2E / Playwright
- SonarCloud full analysis if it's slow
- Any job known to be flaky due to external dependencies

### Rules for changes that touch CI
- When editing workflows, explicitly state whether the change affects Fast CI, Slow CI, or both.
- Prefer moving flaky/network-heavy steps to Slow CI rather than "continue-on-error" in Fast CI.

---

## Pre-commit & Local Verification (C2)

### Before every commit
1. Confirm you are on a feature branch (not `main`).
2. Run `npm run lint -w admin` (0 errors, 0 warnings).

### For agent-api test/coverage work
Run and paste relevant excerpts from:
- `npm run test:coverage -w services/agent-api`
- plus a targeted `grep/coverage` proof for the touched files (example: `grep -E "^\s*replay\.js\s+\|"`)

---

## SonarCloud Issue Resolution (C7)

### Before fixing any SonarCloud issue

1. **Extract the Rule ID** from the issue (e.g., S3358, S6759)
2. **Consult the Quick Lookup table** in `docs/architecture/quality/sonarcloud.md`
3. **Read the linked Lesson file** for project-specific fix patterns
4. **Apply the documented pattern**, not a generic fix

### Documentation structure

- **Quick Lookup**: `docs/architecture/quality/sonarcloud.md` 
(Rule ID â†’ Lesson mapping)
- **Lessons**: `docs/architecture/quality/sonar-lessons/*.md` 
(How we fix issues in this codebase)
- **Rules**: `docs/architecture/quality/sonar-rules/*.md` 
(Links to SonarSource docs)

### If no lesson exists

1. Fix the issue using best practices
2. **Create a new lesson** in `docs/architecture/quality/sonar-lessons/`
3. **Add to Quick Lookup table** in `sonarcloud.md`
4. **Add rule file** in `docs/architecture/quality/sonar-rules/
`
---

## Prompt Engineering (C10)

### Agent Registry
- Every agent must be declared in `docs/agents/manifest.yaml`.
- CI validates prompt coverage on every PR.

### Prompt Changes
- Every prompt change requires a migration in `supabase/migrations/`.
- Use `INSERT ... ON CONFLICT` pattern for safe updates when applicable.
- Set `is_current = true` for new version, `false` for old versions.
- Include `notes` explaining what changed and why.

### Fail-Fast Policy
- Agents must throw errors if required prompts are missing.
- No silent fallbacks to hardcoded prompts.
- Use `throw new Error('CRITICAL: ...')` pattern from KB-206.

### Prompt Version Migrations
- Always INSERT new rows for prompt versions, never UPDATE existing rows.
- Pattern:

```sql
UPDATE prompt_version
SET is_current = false
WHERE agent_name = 'X' AND is_current = true;

INSERT INTO prompt_version (
  agent_name,
  version,
  prompt_text,
  is_current,
  notes
)
VALUES (
  'X',
  'vYYYYMMDD-01',
  '... full prompt text ...',
  true,
  'What changed and why'
);