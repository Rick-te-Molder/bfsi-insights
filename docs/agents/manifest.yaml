# Agent Manifest - Single Source of Truth for BFSI Insights Agents
# KB-207: Best-in-class prompt engineering
#
# This file declares all agents and their required prompts/tables.
# CI checks validate that all declared prompts exist in prompt_versions.
#
# Agent Types:
#   - llm: Uses LLM with prompt from prompt_versions
#   - config: Uses JSON config from prompt_versions (not an LLM prompt)
#   - orchestrator: Coordinates other agents, no own prompt
#   - scoring: Uses dynamic prompt built from database tables

agents:
  # =============================================================================
  # DISCOVERY PIPELINE
  # =============================================================================
  
  - name: scorer
    file: services/agent-api/src/agents/scorer.js
    type: scoring
    description: >
      Scores content relevance for each audience type (executive, functional_specialist,
      engineer, researcher). Returns multi-audience scores to determine if content
      should enter the review queue.
    prompt_versions: []  # No static prompt - built dynamically from kb_audience
    tables:
      - kb_audience  # Loads audience definitions (cares_about, doesnt_care_about, scoring_guide)
      - kb_rejection_pattern  # Rejection patterns for pre-filtering
    model: gpt-4o-mini
    owner: system
    
  - name: discoverer
    file: services/agent-api/src/agents/discoverer.js
    type: orchestrator
    description: >
      Orchestrates RSS/sitemap discovery. Fetches sources, filters candidates,
      scores relevance, and inserts into ingestion queue.
    prompt_versions:
      - discoverer-config  # JSON config for exclusion patterns
    tables:
      - kb_source
      - bfsi_industry
      - bfsi_topic
    owner: system

  - name: discover-classics
    file: services/agent-api/src/agents/discover-classics.js
    type: orchestrator
    description: >
      Discovers classic/foundational BFSI content from curated lists.
      One-time seeding of evergreen publications.
    prompt_versions: []
    tables:
      - kb_source
    owner: system

  # =============================================================================
  # ENRICHMENT PIPELINE
  # =============================================================================

  - name: enricher
    file: services/agent-api/src/agents/enricher.js
    type: orchestrator
    description: >
      Full enrichment pipeline for a single queue item.
      Orchestrates: fetch → screener → summarizer → tagger → thumbnailer
    prompt_versions: []  # Orchestrator only
    tables: []
    owner: system

  - name: screener
    file: services/agent-api/src/agents/screener.js
    type: llm
    description: >
      Second-pass relevance filtering after content fetch.
      Validates content is actually relevant before summarization.
    prompt_versions:
      - screener  # LLM prompt for filtering decisions
    tables: []
    model: gpt-4o-mini
    owner: system

  - name: summarizer
    file: services/agent-api/src/agents/summarizer.js
    type: llm
    description: >
      Generates summaries (short, medium, long) and extracts metadata
      (title, authors, published_at). Uses structured output.
    prompt_versions:
      - summarizer  # LLM prompt for summarization
    tables: []
    model: claude-3-5-sonnet  # Uses Anthropic for quality
    owner: system

  - name: tagger
    file: services/agent-api/src/agents/tagger.js
    type: llm
    description: >
      Classifies content with taxonomy codes (industry, topic, geography,
      regulators, regulations, use cases, capabilities, etc.).
    prompt_versions:
      - tagger  # LLM prompt for classification
    tables:
      - taxonomy_config
      - bfsi_industry
      - bfsi_topic
      - bfsi_geography
      - bfsi_regulator
      - bfsi_regulation
      - bfsi_use_case
      - bfsi_capability
      - bfsi_process
    model: gpt-4o
    owner: system

  - name: thumbnailer
    file: services/agent-api/src/agents/thumbnailer.js
    type: config
    description: >
      Captures webpage screenshots for thumbnails using Playwright.
      Config specifies viewport size, timeout, wait time.
    prompt_versions:
      - thumbnailer  # JSON config (not LLM prompt)
    tables: []
    owner: system

  # =============================================================================
  # IMPROVEMENT PIPELINE
  # =============================================================================

  - name: improver
    file: services/agent-api/src/agents/improver.js
    type: orchestrator
    description: >
      Analyzes missed discoveries to classify why we missed them and generates
      improvement suggestions for sources, patterns, and scoring. Part of the
      user feedback reinforcement system (KB-214).
    prompt_versions: []  # No LLM prompt - uses rule-based classification
    tables:
      - missed_discovery
      - kb_source
      - ingestion_queue
    owner: system

# =============================================================================
# PROMPT COVERAGE REQUIREMENTS
# =============================================================================
# 
# The following prompts MUST exist in prompt_versions with is_current=true:
#
# LLM Prompts (type: llm):
#   - screener (second-pass filter)
#   - summarizer (summary generation)
#   - tagger (taxonomy classification)
#
# Config (type: config):
#   - discoverer-config (JSON exclusion patterns)
#   - thumbnailer (JSON viewport config)
#
# Dynamic (type: scoring):
#   - scorer loads from kb_audience table, not prompt_versions
#
# =============================================================================

# Schema for prompt_versions validation
required_prompts:
  - agent_name: screener
    type: llm
    required: true
    
  - agent_name: summarizer
    type: llm
    required: true
    
  - agent_name: tagger
    type: llm
    required: true
    
  - agent_name: discoverer-config
    type: config
    required: true
    
  - agent_name: thumbnailer
    type: config
    required: false  # Optional - agent has sensible defaults

# Tables that must have data for agents to function
required_tables:
  - table: kb_audience
    min_rows: 4
    description: Audience definitions with prompt content
    
  - table: kb_source
    min_rows: 1
    description: Content sources for discovery
    
  - table: bfsi_industry
    min_rows: 1
    description: Industry taxonomy codes
    
  - table: bfsi_topic
    min_rows: 1
    description: Topic taxonomy codes
