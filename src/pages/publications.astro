---
export const prerender = true;

import Base from '../layouts/Base.astro';
import { loadPublicationsData } from '../lib/publications-data';
import PublicationCard from '../features/publications/PublicationCard.astro';
import FloatingFilterButton from '../components/FloatingFilterButton.astro';
import BackToTopButton from '../components/BackToTopButton.astro';
import FilterPanel from '../components/FilterPanel.astro';
import SearchBar from '../components/SearchBar.astro';
import EmptyState from '../components/EmptyState.astro';
import LoadingSkeleton from '../components/LoadingSkeleton.astro';

const {
  publications,
  filters,
  flatFilters,
  values,
  industryWithCounts,
  processWithCounts,
  geographyWithCounts,
} = await loadPublicationsData();

const expandItemThumb = (t: string | undefined) => {
  if (!t) return [];
  return /\.(webp|png|jpe?g)$/i.test(t) ? [t] : [`${t}.webp`, `${t}.png`, `${t}.jpg`];
};
---

<Base title="Publications Â· BFSI Insights">
  {
    (() => {
      const first = publications?.[0];
      if (!first) return null;

      let href = null;
      if (first.thumbnail_path && first.thumbnail_bucket) {
        href = `${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/${first.thumbnail_bucket}/${first.thumbnail_path}`;
      } else if (first.thumbnail) {
        const candidates = expandItemThumb(first.thumbnail);
        href = candidates[0];
      }

      return href ? (
        <Fragment slot="head">
          <link rel="preload" as="image" href={href} />
        </Fragment>
      ) : null;
    })()
  }

  <!-- Header -->
  <section class="mb-4">
    <div class="flex items-center justify-between">
      <h2 class="text-2xl font-semibold tracking-tight">Publications</h2>
      <a
        href="/"
        class="text-sm font-medium text-sky-200 underline underline-offset-2 focus:outline-none focus:ring-2 focus:ring-sky-500"
      >
        Home
      </a>
    </div>
    <p id="count" class="mt-1 text-sm text-neutral-400" aria-live="polite"></p>
  </section>

  <SearchBar />

  <!-- Hidden select elements for backward compatibility with filter logic -->
  <div class="hidden">
    {
      filters.map((filter) => (
        <select id={`f-${filter.column_name}`} data-filter={filter.column_name}>
          <option value="">All</option>
        </select>
      ))
    }
  </div>

  <FilterPanel
    flatFilters={flatFilters}
    values={values}
    industryWithCounts={industryWithCounts}
    processWithCounts={processWithCounts}
    geographyWithCounts={geographyWithCounts}
  />

  <!-- Publications list -->
  <section>
    <EmptyState totalCount={publications.length} />
    <LoadingSkeleton />

    <ul id="list" class="grid gap-6 sm:grid-cols-2 opacity-0 transition-opacity duration-300">
      {publications.map((item, idx) => <PublicationCard item={item} index={idx} />)}
    </ul>

    <!-- Pagination -->
    <div id="pagination-container" class="mt-8 flex flex-col items-center gap-4">
      <p id="pagination-count" class="text-sm text-neutral-400"></p>
      <button
        id="load-more-btn"
        class="rounded-md bg-sky-600 px-6 py-2.5 text-sm font-medium text-white transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 focus:ring-offset-neutral-950 disabled:cursor-not-allowed disabled:opacity-50"
      >
        Show more publications
      </button>
    </div>
  </section>

  <FloatingFilterButton />
  <BackToTopButton />

  <script>
    import initImageEnhancement from '../features/publications/image-enhancement.ts';
    initImageEnhancement();
  </script>

  <script>
    import initMultiSelectFilters from '../features/publications/multi-select-filters.ts';
    initMultiSelectFilters();
  </script>

  <script>
    import { initAllHierarchyCascades } from '../features/publications/hierarchy-cascade.ts';
    initAllHierarchyCascades();
  </script>

  <script>
    import initCardExpand from '../features/publications/card-expand.ts';
    initCardExpand();
  </script>
</Base>
