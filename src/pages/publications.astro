---
// Static for performance - rebuilds on article approval
export const prerender = true;

import Base from '../layouts/Base.astro';
import { getAllPublications } from '../lib/supabase';
import type { Publication } from '../lib/supabase';
import { createClient } from '@supabase/supabase-js';
import PublicationCard from '../features/publications/PublicationCard.astro';

// Fetch all publications
const publications: Publication[] = await getAllPublications();

// Supabase client for dynamic filter config
const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
);

// Load filter configuration
const { data: filterConfig } = await supabase
  .from('ref_filter_config')
  .select('column_name, display_label, sort_order')
  .eq('enabled', true)
  .order('sort_order');

const filters = filterConfig || [];
const primaryFilters = filters.filter((filter) =>
  ['role', 'industry'].includes(filter.column_name),
);
const advancedFiltersList = filters.filter(
  (filter) => !['role', 'industry'].includes(filter.column_name),
);

// Build filter value lists + counts (handles both single values and arrays)
const createValuesWithCounts = (field: keyof Publication) => {
  const counts = new Map<string, number>();

  publications.forEach((p) => {
    const val = p[field];
    if (Array.isArray(val)) {
      // Handle array fields (regulators, regulations, industries, topics, etc.)
      val.forEach((v) => {
        if (v) counts.set(String(v), (counts.get(String(v)) || 0) + 1);
      });
    } else if (val) {
      counts.set(String(val), (counts.get(String(val)) || 0) + 1);
    }
  });

  return Array.from(counts.entries())
    .map(([value, count]) => ({
      value,
      count,
      label: `${value} (${count})`,
    }))
    .sort((a, b) => a.value.localeCompare(b.value));
};

const values: Record<string, Array<{ value: string; count: number; label: string }>> = {};
filters.forEach((filter) => {
  values[filter.column_name] = createValuesWithCounts(filter.column_name as keyof Publication);
});

const expandItemThumb = (t: string | undefined) => {
  if (!t) return [];
  return /\.(webp|png|jpe?g)$/i.test(t) ? [t] : [`${t}.webp`, `${t}.png`, `${t}.jpg`];
};
---

<Base title="Publications · BFSI Insights">
  {
    (() => {
      const first = publications?.[0];
      if (!first) return null;

      let href = null;
      if (first.thumbnail_path && first.thumbnail_bucket) {
        href = `${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/${first.thumbnail_bucket}/${first.thumbnail_path}`;
      } else if (first.thumbnail) {
        const candidates = expandItemThumb(first.thumbnail);
        href = candidates[0];
      }

      return href ? (
        <Fragment slot="head">
          <link rel="preload" as="image" href={href} />
        </Fragment>
      ) : null;
    })()
  }

  <!-- Header -->
  <section class="mb-6">
    <div class="flex items-center justify-between">
      <h2 class="text-2xl font-semibold tracking-tight">Publications</h2>
      <div class="flex items-center gap-3">
        <a
          href="/"
          class="text-sm font-medium text-sky-200 underline underline-offset-2 focus:outline-none focus:ring-2 focus:ring-sky-500"
        >
          Home
        </a>
      </div>
    </div>

    <p class="mt-1 text-sm text-neutral-300">
      Filter publications by attributes to find relevant items. Topic filters now live under “More
      filters”.
    </p>

    <p id="count" class="mt-1 text-xs text-neutral-300" aria-live="polite"></p>
  </section>

  <!-- Desktop Filters -->
  <section class="mb-6 hidden sm:grid gap-3 sm:grid-cols-2">
    <!-- Search with loading indicator and suggestions -->
    <div class="hidden sm:col-span-2 sm:flex flex-col gap-1 text-sm relative">
      <label for="q" class="text-neutral-300">Search</label>
      <div class="relative">
        <svg
          class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-neutral-500 pointer-events-none"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input
          id="q"
          type="search"
          placeholder="Search by title, author, or source…"
          autocomplete="off"
          class="w-full rounded-md border border-neutral-700 bg-neutral-900 pl-10 pr-10 py-2 text-base placeholder:text-neutral-500 focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition-colors"
        />
        <!-- Loading spinner (hidden by default) -->
        <div
          id="search-spinner"
          class="absolute right-3 top-1/2 -translate-y-1/2 hidden"
          aria-hidden="true"
        >
          <svg class="animate-spin h-4 w-4 text-sky-400" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </div>
      </div>
      <!-- Search suggestions dropdown -->
      <div
        id="search-suggestions"
        class="absolute top-full left-0 right-0 mt-1 bg-neutral-900 border border-neutral-700 rounded-md shadow-lg z-30 hidden"
      >
        <div id="search-history" class="py-1"></div>
      </div>
    </div>

    <!-- First three primary filters -->
    {
      primaryFilters.map((filter) => {
        const filterValues = values[filter.column_name] || [];
        const isRole = filter.column_name === 'role';

        return (
          <label class="flex flex-col gap-1 text-sm">
            <span class="text-neutral-300">
              {filter.display_label}
              <span class="text-neutral-500">({filterValues.length})</span>
            </span>

            <select
              id={`f-${filter.column_name}`}
              class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-1.5"
            >
              <option value={isRole ? 'all' : ''}>
                {isRole ? `Everyone (${publications.length})` : 'All'}
              </option>

              {filterValues.map((v) => (
                <option value={v.value}>{v.label}</option>
              ))}
            </select>
          </label>
        );
      })
    }

    <!-- Advanced Filters Toggle -->
    <div class="sm:col-span-2">
      <button
        id="toggle-advanced-filters"
        type="button"
        class="flex items-center gap-2 text-sm text-neutral-400 hover:text-neutral-200 transition-colors"
        aria-expanded="false"
        aria-controls="advanced-filters"
      >
        <svg
          id="advanced-filters-icon"
          class="w-4 h-4 transition-transform"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"
          ></path>
        </svg>
        <span>More filters</span>
      </button>

      <div id="advanced-filters" class="hidden mt-3 grid gap-3 sm:grid-cols-2">
        {
          advancedFiltersList.map((filter) => {
            const filterValues = values[filter.column_name] || [];

            return (
              <label class="flex flex-col gap-1 text-sm">
                <span class="text-neutral-300">
                  {filter.display_label}
                  <span class="text-neutral-500">({filterValues.length})</span>
                </span>

                <select
                  id={`f-${filter.column_name}`}
                  class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-1.5"
                >
                  <option value="">All</option>
                  {filterValues.map((v) => (
                    <option value={v.value}>{v.label}</option>
                  ))}
                </select>
              </label>
            );
          })
        }
      </div>
    </div>

    <!-- Clear -->
    <div class="sm:col-span-2 flex justify-end">
      <button
        id="clear-filters"
        class="rounded-md border border-neutral-700 px-4 py-1.5 text-sm text-neutral-200 hover:bg-neutral-800 transition-colors"
      >
        Clear all
      </button>
    </div>
  </section>

  <!-- Mobile sticky search bar -->
  <section
    class="mb-4 sm:hidden sticky top-0 z-40 -mx-4 px-4 py-3 bg-neutral-950/95 backdrop-blur-sm border-b border-neutral-800/50"
  >
    <!-- Search input always visible -->
    <div class="relative mb-3">
      <svg
        class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-neutral-500 pointer-events-none"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
      <input
        id="m-q-sticky"
        type="search"
        placeholder="Search publications…"
        autocomplete="off"
        class="w-full rounded-lg border border-neutral-700 bg-neutral-900 pl-10 pr-10 py-2.5 text-base placeholder:text-neutral-500 focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition-colors"
      />
      <!-- Mobile loading spinner -->
      <div
        id="mobile-search-spinner"
        class="absolute right-3 top-1/2 -translate-y-1/2 hidden"
        aria-hidden="true"
      >
        <svg class="animate-spin h-4 w-4 text-sky-400" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
      </div>
      <!-- Mobile search suggestions -->
      <div
        id="mobile-search-suggestions"
        class="absolute top-full left-0 right-0 mt-1 bg-neutral-900 border border-neutral-700 rounded-md shadow-lg z-50 hidden"
      >
        <div id="mobile-search-history" class="py-1"></div>
      </div>
    </div>

    <!-- Filter button and count -->
    <div class="flex items-center gap-2">
      <button
        id="open-sheet"
        class="flex-1 rounded-lg border border-neutral-700 bg-neutral-900 px-4 py-2 text-sm font-medium text-neutral-200 hover:bg-neutral-800 flex items-center justify-center gap-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
          ></path>
        </svg>
        <span>Filters</span>
        <span
          id="filter-count"
          class="hidden ml-1 px-1.5 py-0.5 text-xs font-semibold bg-sky-500 text-white rounded-full"
        ></span>
      </button>

      <div id="count-mobile" class="text-xs text-neutral-400 whitespace-nowrap" aria-live="polite">
      </div>
    </div>

    <div id="chips" class="mt-2 flex flex-wrap gap-2 empty:hidden"></div>
  </section>

  <!-- Mobile filter sheet -->
  <div id="filter-sheet" class="fixed inset-0 z-50 hidden sm:hidden">
    <div id="sheet-backdrop" class="absolute inset-0 bg-black/70"></div>

    <div
      role="dialog"
      aria-modal="true"
      aria-labelledby="sheet-title"
      class="absolute bottom-0 left-0 right-0 max-h-[85vh] overflow-auto rounded-t-2xl border border-neutral-800 bg-neutral-950 p-4"
    >
      <div class="mx-auto max-w-2xl">
        <div class="flex items-center justify-between">
          <h3 id="sheet-title" class="text-lg font-semibold">Filters</h3>
          <button
            id="close-sheet"
            class="rounded p-2 text-neutral-300 hover:text-white"
            aria-label="Close"
          >
            ✕
          </button>
        </div>

        <!-- Mobile search -->
        <label class="flex flex-col gap-1 mt-3 text-sm">
          <span class="text-neutral-300">Search</span>

          <input
            id="m-q"
            type="search"
            placeholder="Search title, summary, source, authors…"
            class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-2"
          />
        </label>

        <!-- Mobile filters -->
        <div class="mt-3 grid gap-3">
          {
            filters.map((filter) => {
              const filterValues = values[filter.column_name] || [];
              const isRole = filter.column_name === 'role';

              return (
                <label class="flex flex-col gap-1 text-sm">
                  <span class="text-neutral-300">{filter.display_label}</span>

                  <select
                    id={`m-f-${filter.column_name}`}
                    class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-2"
                  >
                    <option value={isRole ? 'all' : ''}>
                      {isRole ? `Everyone (${publications.length})` : 'All'}
                    </option>

                    {filterValues.map((v) => (
                      <option value={v.value}>{v.label}</option>
                    ))}
                  </select>
                </label>
              );
            })
          }
        </div>

        <div class="mt-4 flex items-center justify-between">
          <button
            id="m-clear"
            class="rounded-md border border-neutral-700 px-3 py-2 text-sm text-neutral-200 hover:bg-neutral-800"
          >
            Clear all
          </button>

          <button
            id="m-apply"
            class="rounded-md bg-sky-600 px-4 py-2 text-sm font-medium text-white hover:bg-sky-500"
          >
            Apply
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Publications list -->
  <section>
    <div
      id="empty"
      class="hidden rounded-md border border-neutral-800 bg-neutral-900/60 p-4 text-sm text-neutral-300"
      role="status"
      aria-live="polite"
    >
      No publications match the selected filters.
    </div>

    <ul id="list" class="grid gap-6 sm:grid-cols-2">
      {publications.map((item, idx) => <PublicationCard item={item} index={idx} />)}
    </ul>

    <!-- Pagination -->
    <div id="pagination-container" class="mt-8 flex flex-col items-center gap-4">
      <p id="pagination-count" class="text-sm text-neutral-400"></p>

      <button
        id="load-more-btn"
        class="rounded-md bg-sky-600 px-6 py-2.5 text-sm font-medium text-white transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 focus:ring-offset-neutral-950 disabled:cursor-not-allowed disabled:opacity-50"
      >
        Show more publications
      </button>
    </div>
  </section>

  <!-- Back to Top -->
  <button
    id="back-to-top"
    aria-label="Back to top"
    class="fixed bottom-6 right-6 z-50 flex h-12 w-12 items-center justify-center rounded-full bg-sky-600 text-white shadow-lg opacity-0 pointer-events-none transition-opacity duration-300 hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 focus:ring-offset-neutral-950"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="2.5"
      stroke="currentColor"
      class="h-6 w-6"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5"></path>
    </svg>
  </button>

  <!-- Image enhancement -->
  <script type="module">
    // @ts-check
    /**
     * @param {Document | HTMLElement} [root]
     */
    function enhanceImages(root) {
      const container = root ?? document;
      /** @type {HTMLImageElement[]} */
      const imgs = Array.from(container.querySelectorAll('li.group img')).filter(
        (img) => img instanceof HTMLImageElement,
      );

      imgs.forEach((img) => {
        const placeholder = img.previousElementSibling;

        const onload = () => {
          img.classList.remove('opacity-0');
          if (placeholder && placeholder instanceof HTMLElement) placeholder.style.display = 'none';
        };

        const onerror = () => {
          const n = img.dataset?.next ?? '';
          if (n) {
            const parts = n.split('|');
            const nx = parts.shift();
            img.dataset.next = parts.join('|');
            if (nx) {
              img.src = nx;
              return;
            }
          }
          img.style.display = 'none';
          if (placeholder && placeholder instanceof HTMLElement) placeholder.style.display = 'none';
        };

        img.addEventListener('load', onload, { once: true });
        img.addEventListener('error', onerror);

        if (img.complete) {
          if (img.naturalWidth > 0) onload();
          else onerror();
        }
      });
    }

    if (document.readyState !== 'loading') enhanceImages();
    else window.addEventListener('DOMContentLoaded', () => enhanceImages());
  </script>

  <!-- Filters JS -->
  <script>
    import initPublicationFilters from '../features/publications/publication-filters.ts';
    initPublicationFilters();
  </script>

  <!-- Back to Top interaction -->
  <script type="module">
    // @ts-check
    const backToTopBtn = document.getElementById('back-to-top');

    if (backToTopBtn instanceof HTMLButtonElement) {
      let isVisible = false;
      const SHOW_THRESHOLD = 400;

      const toggleVisibility = () => {
        const shouldShow = window.scrollY > SHOW_THRESHOLD;
        if (shouldShow !== isVisible) {
          isVisible = shouldShow;

          if (isVisible) {
            backToTopBtn.classList.remove('opacity-0', 'pointer-events-none');
            backToTopBtn.classList.add('opacity-100', 'pointer-events-auto');
          } else {
            backToTopBtn.classList.remove('opacity-100', 'pointer-events-auto');
            backToTopBtn.classList.add('opacity-0', 'pointer-events-none');
          }
        }
      };

      /** @type {number | null} */
      let rafId = null;
      window.addEventListener(
        'scroll',
        () => {
          if (rafId === null) {
            rafId = requestAnimationFrame(() => {
              toggleVisibility();
              rafId = null;
            });
          }
        },
        { passive: true },
      );

      backToTopBtn.addEventListener('click', () => {
        const startPosition = window.scrollY;
        const distance = startPosition;
        const duration = Math.min(800 + distance * 0.3, 1200);
        /** @type {number | null} */
        let startTime = null;

        /**
         * @param {number} t
         */
        const easeInOutCubic = (t) => (t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2);

        /**
         * @param {number} currentTime
         */
        const animateScroll = (currentTime) => {
          if (startTime === null) startTime = currentTime;

          const elapsed = currentTime - (startTime ?? currentTime);
          const progress = Math.min(elapsed / duration, 1);
          const eased = easeInOutCubic(progress);

          window.scrollTo(0, startPosition - distance * eased);

          if (progress < 1) requestAnimationFrame(animateScroll);
        };

        requestAnimationFrame(animateScroll);
      });

      toggleVisibility();
    }
  </script>
</Base>
