---
export const prerender = true;

import Base from '../layouts/Base.astro';
import { supabase } from '../lib/supabase';

// ------------------------------------------------------------
// Load data
// ------------------------------------------------------------
const { data: sources, error } = await supabase
  .from('ref_source')
  .select('name, domain, description, category, tier')
  .eq('show_on_external_page', true)
  .order('tier', { ascending: false }) // premium / high-value first
  .order('name');

if (error) {
  console.error('Failed to fetch external resources:', error);
}

// ------------------------------------------------------------
// Category normalization
// ------------------------------------------------------------
const CATEGORY_MAP: Record<string, string> = {
  'strategy-consulting': 'Industry Research',
  big4: 'Industry Research',
  regulator: 'Regulatory Bodies',
  research: 'Academic Research',
};

// ------------------------------------------------------------
// Transform raw Supabase rows → view model
// ------------------------------------------------------------
const externalResources = (sources ?? []).map((s) => ({
  name: s.name,
  url: s.domain ? `https://${s.domain}` : '',
  description: s.description ?? '',
  category: CATEGORY_MAP[s.category] ?? 'Other',
}));

// ------------------------------------------------------------
// Group by category
// ------------------------------------------------------------
const grouped: Record<string, typeof externalResources> = {};

for (const res of externalResources) {
  if (!grouped[res.category]) grouped[res.category] = [];
  grouped[res.category].push(res);
}

const categories = Object.keys(grouped).sort();
---

<Base title="Sources · BFSI Insights">
  <div class="mx-auto max-w-4xl px-4 py-8">
    <header class="mb-8">
      <h1 class="text-3xl font-bold tracking-tight">Sources</h1>
      <p class="mt-2 text-neutral-300">
        Curated external sources and high-quality content platforms for BFSI and agentic AI.
      </p>
    </header>

    <div class="space-y-10">
      {
        categories.map((category) => (
          <section>
            <h2 class="mb-4 text-xl font-semibold text-neutral-200">{category}</h2>
            <div class="space-y-4">
              {grouped[category].map((res) => (
                <div class="rounded-lg border border-neutral-800 bg-neutral-900/40 p-4 transition-colors hover:border-neutral-700">
                  <h3 class="font-medium">
                    <a
                      href={res.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-sky-300 underline-offset-2 hover:underline"
                    >
                      {res.name} →
                    </a>
                  </h3>
                  <p class="mt-1 text-sm text-neutral-300">{res.description}</p>
                </div>
              ))}
            </div>
          </section>
        ))
      }
    </div>
  </div>
</Base>
