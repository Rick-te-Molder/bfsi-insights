---
import Base from '../layouts/Base.astro';
import resources from '../data/resources/resources.json';

const latest = [...resources].sort((a, b) => b.date_added.localeCompare(a.date_added)).slice(0, 6);

const isNew = (item) => (Date.now() - new Date(item.date_added)) / 86400000 <= 7;
const isUpdated = (item) => {
  if (!item.last_edited) return false;
  const d = (Date.now() - new Date(item.last_edited)) / 86400000;
  return d <= 7 && !isNew(item);
};
const fmt = (iso) =>
  iso
    ? new Date(iso).toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' })
    : '';
const asArr = (v) => (Array.isArray(v) ? v : v ? [v] : []);

const externalThumb = (u) =>
  u ? `https://image.thum.io/get/nojs/width/600/crop/600/${encodeURIComponent(u)}` : null;

const localThumbs = (slug) =>
  slug ? [`/thumbs/${slug}.webp`, `/thumbs/${slug}.jpg`, `/thumbs/${slug}.png`] : [];

const expandItemThumb = (t) => {
  if (!t) return [];
  return /\.(webp|png|jpe?g)$/i.test(t) ? [t] : [`${t}.webp`, `${t}.png`, `${t}.jpg`];
};
---

<Base title="BFSI Insights">
  <section class="mb-8 text-center">
    <h2 class="text-3xl font-bold tracking-tight">BFSI Insights</h2>
    <p class="mt-2 text-neutral-400">
      Agentic AI insights for executives and professionals in banking, financial services and
      insurance.
    </p>
  </section>

  <section>
    <div class="mb-4 flex items-center justify-between">
      <h3 class="text-xl font-semibold">Latest</h3>
      <a
        href="/resources"
        class="text-sm font-medium text-sky-400 underline-offset-2 hover:underline focus:outline-none focus:ring-2 focus:ring-sky-500"
        >Browse all resources →</a
      >
    </div>
    <ul class="grid gap-4 sm:grid-cols-2">
      {
        latest.map((item) => {
          const topic = asArr(item.topic);
          const content_type = asArr(item.content_type);
          return (
            <li class="rounded-2xl border border-neutral-800 bg-neutral-900/60 p-4 shadow-sm transition hover:border-neutral-700">
              <div class="flex items-center gap-2">
                <a
                  href={item.url}
                  class="text-base font-medium text-sky-400 underline-offset-2 hover:underline focus:outline-none focus:ring-2 focus:ring-sky-500"
                >
                  {item.title}
                </a>
                {isNew(item) && (
                  <span class="ml-1 align-middle rounded-full bg-emerald-400/10 px-2 py-0.5 text-xs font-semibold text-emerald-300 ring-1 ring-inset ring-emerald-400/30">
                    New
                  </span>
                )}
                {isUpdated(item) && (
                  <span class="ml-1 align-middle rounded-full bg-amber-400/10 px-2 py-0.5 text-xs font-semibold text-amber-300 ring-1 ring-inset ring-amber-400/30">
                    Updated
                  </span>
                )}
              </div>

              <div class="mt-1 flex items-center gap-2 text-sm text-neutral-400">
                <span>{fmt(item.date_added)}</span>
                {item.source_name && <span>{item.source_name}</span>}
                {item.authors?.length && <span>· {item.authors[0]}</span>}
              </div>

              <div class="mt-3 grid grid-cols-3 gap-3 items-start">
                <div class="col-span-2">
                  {item.note && <p class="text-sm text-neutral-300 line-clamp-3">{item.note}</p>}
                  <div class="mt-2 flex flex-wrap items-center gap-2">
                    {topic.length ? (
                      <span class="rounded-md border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-xs text-neutral-300">
                        {topic[0]}
                      </span>
                    ) : null}
                    {content_type.length ? (
                      <span class="rounded-md border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-xs text-neutral-300">
                        {content_type[0]}
                      </span>
                    ) : null}
                  </div>
                </div>
                <div class="col-span-1">
                  <div class="relative">
                    <div class="ml-auto h-24 w-full rounded-md border border-neutral-800 bg-neutral-800/40" />
                    {(() => {
                      const candidates = [
                        ...expandItemThumb(item.thumbnail),
                        ...localThumbs(item.slug),
                        ...(externalThumb(item.url) ? [externalThumb(item.url)] : []),
                      ];
                      return candidates.length ? (
                        <img
                          src={candidates[0]}
                          data-next={candidates.slice(1).join('|')}
                          alt={`${item.source_name || 'Source'} preview`}
                          width="320"
                          height="180"
                          loading="lazy"
                          decoding="async"
                          referrerpolicy="no-referrer"
                          class="ml-auto h-24 w-full rounded-md border border-neutral-800 object-cover opacity-0"
                          onload="this.classList.remove('opacity-0'); this.previousElementSibling.style.display='none'"
                          onerror="const n=this.dataset.next||''; if(n){ const parts=n.split('|'); const nx=parts.shift(); this.dataset.next=parts.join('|'); if(nx){ this.src=nx; return; } } this.style.display='none'"
                        />
                      ) : null;
                    })()}
                  </div>
                </div>
              </div>
            </li>
          );
        })
      }
    </ul>
  </section>
</Base>
