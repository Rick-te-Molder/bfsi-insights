---
// Static for performance - rebuilds on article approval
export const prerender = true;

import Base from '../layouts/Base.astro';
import { getAllPublications } from '../lib/supabase';
import { createClient } from '@supabase/supabase-js';
import PublicationCard from '../features/publications/PublicationCard.astro';
import fs from 'node:fs';

// Fetch enough publications to ensure we have 6 per persona
const allPublications = await getAllPublications();

// Supabase client for role metadata
const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
);

// Load roles from kb_role
const { data: rolesData, error: rolesError } = await supabase
  .from('kb_role')
  .select('value, label')
  .order('sort_order', { ascending: true });

if (rolesError) {
  throw new Error(`Failed to load roles from kb_role: ${rolesError.message}`);
}

if (!rolesData || rolesData.length === 0) {
  throw new Error('kb_role returned no roles; expected at least executive/professional/researcher');
}

const roleOptions = rolesData.map((r) => ({
  value: r.value,
  label: r.label,
}));

const validRoles = roleOptions.map((r) => r.value);

// Get 6 most recent from each persona
const byRole = Object.fromEntries(
  validRoles.map((role) => [role, allPublications.filter((p) => p.role === role).slice(0, 6)]),
);

const roleOptionsWithCounts = roleOptions.map((option) => ({
  ...option,
  count: byRole[option.value]?.length ?? 0,
}));

// Combine all, dedupe
const allByPersona = Object.values(byRole).flat();
const latest = Array.from(new Map(allByPersona.map((item) => [item.id, item])).values());

// Thumbnails
const thumbsDirUrl = new URL('../../public/thumbs/', import.meta.url);
let thumbFiles: string[] = [];

try {
  const dirPath = thumbsDirUrl.pathname;
  thumbFiles = fs.readdirSync(dirPath).filter((f) => /\.(webp|png|jpe?g)$/i.test(f));
} catch {
  thumbFiles = [];
}

const findLocalThumbs = (slug: string) => {
  if (!slug) return [];
  const extPriority: Record<string, number> = {
    '.png': 0,
    '.webp': 1,
    '.jpg': 2,
    '.jpeg': 2,
  };
  const getExt = (f: string) => (f.match(/\.[^.]+$/)?.[0] || '').toLowerCase();

  const files = thumbFiles.filter((f) => f.includes(slug));
  files.sort((a, b) => {
    const pa = extPriority[getExt(a)] ?? 99;
    const pb = extPriority[getExt(b)] ?? 99;
    if (pa !== pb) return pa - pb;
    return a.localeCompare(b);
  });

  return files.map((f) => `/thumbs/${f}`);
};

const expandItemThumb = (t: string | undefined) => {
  if (!t) return [];
  if (/\.(webp|png|jpe?g)$/i.test(t)) return [t];
  if (t.startsWith('http://') || t.startsWith('https://')) return [t];
  return [`${t}.webp`, `${t}.png`, `${t}.jpg`];
};
---

<Base title="BFSI Insights">
  {
    (() => {
      const first = latest?.[0];
      if (!first) return null;

      const candidates = [...findLocalThumbs(first.slug), ...expandItemThumb(first.thumbnail)];
      const href = candidates[0];

      return href ? (
        <Fragment slot="head">
          <link rel="preload" as="image" href={href} />
        </Fragment>
      ) : null;
    })()
  }

  <!-- Hero -->
  <section class="mb-8 text-center">
    <h2 class="text-3xl font-bold tracking-tight">BFSI Insights</h2>
    <p class="mt-2 text-neutral-300">
      Agentic AI insights for executives, professionals, and researchers in banking, financial
      services and insurance.
    </p>
  </section>

  <!-- Latest Publications -->
  <section>
    <div class="mb-4 flex items-center justify-between flex-wrap gap-3">
      <h3 class="text-xl font-semibold">Latest</h3>

      <div class="flex items-center gap-3">
        <label for="persona-filter" class="text-sm text-neutral-400">View for:</label>

        <select
          id="persona-filter"
          class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-1.5 text-sm text-neutral-300 focus:outline-none focus:ring-2 focus:ring-sky-500"
        >
          <option value="all">Everyone ({latest.length})</option>
          {
            roleOptionsWithCounts.map((r) => (
              <option value={r.value}>
                {r.label} ({r.count})
              </option>
            ))
          }
        </select>

        <a
          href="/publications"
          class="text-sm font-medium text-sky-200 underline underline-offset-2 focus:outline-none focus:ring-2 focus:ring-sky-500"
        >
          Browse all â†’
        </a>
      </div>
    </div>

    <ul id="publications-grid" class="grid gap-6 sm:grid-cols-2">
      {latest.map((item, idx) => <PublicationCard item={item} index={idx} mode="home" />)}
    </ul>
  </section>

  <!-- Persona filter -->
  <script define:vars={{ validRoles }}>
    const filterEl = document.getElementById('persona-filter');
    const gridEl = document.getElementById('publications-grid');

    if (!filterEl || !gridEl) {
      console.error('Filter or grid not found');
    } else {
      const saved = localStorage.getItem('bfsi-persona-preference');
      const defaultPersona = 'executive';

      const specificRoles = validRoles;

      if (saved && saved !== 'all' && specificRoles.includes(saved)) {
        filterEl.value = saved;
      } else {
        filterEl.value = defaultPersona;
        localStorage.setItem('bfsi-persona-preference', defaultPersona);
      }

      filterPublications();

      filterEl.addEventListener('change', () => {
        localStorage.setItem('bfsi-persona-preference', filterEl.value);
        filterPublications();
      });

      function filterPublications() {
        const persona = filterEl.value;

        const allCards = Array.from(gridEl.children);

        allCards.forEach((card) => {
          const cardRole = card.getAttribute('data-role');

          if (persona === 'all' || cardRole === persona) {
            card.style.display = '';
          } else {
            card.style.display = 'none';
          }
        });
      }
    }
  </script>

  <!-- Image enhancement -->
  <script>
    function enhanceImages(root) {
      const container = root || document;
      const imgs = Array.from(container.querySelectorAll('li.group img'));

      imgs.forEach((img) => {
        const placeholder = img.previousElementSibling;

        const onload = () => {
          img.classList.remove('opacity-0');
          if (placeholder && placeholder instanceof HTMLElement) placeholder.style.display = 'none';
        };

        const onerror = () => {
          const n = img.dataset?.next || '';
          if (n) {
            const parts = n.split('|');
            const nx = parts.shift();
            img.dataset.next = parts.join('|');
            if (nx) {
              img.src = nx;
              return;
            }
          }
          img.style.display = 'none';
          if (placeholder && placeholder instanceof HTMLElement) placeholder.style.display = 'none';
        };

        img.addEventListener('load', onload, { once: true });
        img.addEventListener('error', onerror);

        if (img.complete) {
          if (img.naturalWidth > 0) onload();
          else onerror();
        }
      });
    }

    if (document.readyState !== 'loading') enhanceImages();
    else window.addEventListener('DOMContentLoaded', () => enhanceImages());
  </script>
</Base>
