---
import Base from '../layouts/Base.astro';
import { getAllResources } from '../lib/supabase';
import ResourceCard from '../features/resources/ResourceCard.astro';
import fs from 'node:fs';

// Fetch enough resources to ensure we have 6 per persona
const allResources = await getAllResources();

// Group by persona for efficient filtering
const byPersona = {
  all: allResources.slice(0, 6),
  executive: allResources.filter((r) => r.role === 'executive').slice(0, 6),
  professional: allResources.filter((r) => r.role === 'professional').slice(0, 6),
  academic: allResources.filter((r) => r.role === 'academic').slice(0, 6),
};

// Default to 'all' for server-side render
const latest = byPersona.all;

const externalThumb = (u: string | undefined) =>
  u ? `https://image.thum.io/get/nojs/width/600/crop/600/${encodeURIComponent(u)}` : null;

const thumbsDirUrl = new URL('../../public/thumbs/', import.meta.url);
let thumbFiles: string[] = [];
try {
  const dirPath = thumbsDirUrl.pathname;
  thumbFiles = fs.readdirSync(dirPath).filter((f) => /\.(webp|png|jpe?g)$/i.test(f));
} catch {
  thumbFiles = [];
}
const findLocalThumbs = (slug: string) => {
  if (!slug) return [];
  const extPriority: Record<string, number> = { '.png': 0, '.webp': 1, '.jpg': 2, '.jpeg': 2 };
  const getExt = (f: string) => (f.match(/\.[^.]+$/)?.[0] || '').toLowerCase();
  const files = thumbFiles.filter((f) => f.includes(slug));
  files.sort((a, b) => {
    const pa = extPriority[getExt(a)] ?? 99;
    const pb = extPriority[getExt(b)] ?? 99;
    if (pa !== pb) return pa - pb;
    return a.localeCompare(b);
  });
  return files.map((f) => `/thumbs/${f}`);
};

const expandItemThumb = (t: string | undefined) => {
  if (!t) return [];
  return /\.(webp|png|jpe?g)$/i.test(t) ? [t] : [`${t}.webp`, `${t}.png`, `${t}.jpg`];
};
---

<Base title="BFSI Insights">
  {
    (() => {
      const first = latest?.[0];
      if (!first) return null;
      const candidates = [
        ...findLocalThumbs(first.slug),
        ...expandItemThumb(first.thumbnail),
        ...(externalThumb(first.url) ? [externalThumb(first.url)] : []),
      ];
      const href = candidates[0];
      return href ? (
        <Fragment slot="head">
          <link rel="preload" as="image" href={href} />
        </Fragment>
      ) : null;
    })()
  }
  <section class="mb-8 text-center">
    <h2 class="text-3xl font-bold tracking-tight">BFSI Insights</h2>
    <p class="mt-2 text-neutral-300">
      Agentic AI insights for executives and professionals in banking, financial services and
      insurance.
    </p>
  </section>

  <section>
    <div class="mb-4 flex items-center justify-between flex-wrap gap-3">
      <h3 class="text-xl font-semibold">Latest</h3>
      <div class="flex items-center gap-3">
        <label for="persona-filter" class="text-sm text-neutral-400">View for:</label>
        <select
          id="persona-filter"
          class="rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-1.5 text-sm text-neutral-300 focus:outline-none focus:ring-2 focus:ring-sky-500"
        >
          <option value="all">Everyone</option>
          <option value="executive">Executives</option>
          <option value="professional">Professionals</option>
          <option value="academic">Researchers</option>
        </select>
        <a
          href="/resources"
          class="text-sm font-medium text-sky-200 underline underline-offset-2 focus:outline-none focus:ring-2 focus:ring-sky-500"
          >Browse all →</a
        >
      </div>
    </div>
    <ul id="resources-grid" class="grid gap-6 sm:grid-cols-2">
      {latest.map((item, idx) => <ResourceCard item={item} index={idx} mode="home" />)}
    </ul>
  </section>

  <script define:vars={{ byPersona }}>
    // Persona filter that fetches 6 most recent items per persona
    const filter = document.getElementById('persona-filter');
    const grid = document.getElementById('resources-grid');

    // Debug: Log available resources per persona
    console.log('Persona resources:', {
      all: byPersona.all?.length || 0,
      executive: byPersona.executive?.length || 0,
      professional: byPersona.professional?.length || 0,
      academic: byPersona.academic?.length || 0,
    });

    // Restore saved preference
    const saved = localStorage.getItem('bfsi-persona-preference');
    if (saved && ['all', 'executive', 'professional', 'academic'].includes(saved)) {
      filter.value = saved;
      filterResources(); // Apply saved filter
    }

    // Handle filter change
    filter.addEventListener('change', () => {
      localStorage.setItem('bfsi-persona-preference', filter.value);
      filterResources();
    });

    function filterResources() {
      const persona = filter.value;
      const resources = byPersona[persona] || byPersona.all;

      console.log(`Filtering to ${persona}:`, resources.length, 'items');

      if (resources.length === 0) {
        grid.innerHTML = `
          <li class="col-span-2 rounded-lg border border-neutral-800 bg-neutral-900/60 p-8 text-center text-neutral-400">
            No resources available for this audience yet. Check back soon!
          </li>
        `;
        return;
      }

      // Re-render cards for selected persona
      grid.innerHTML = resources
        .map(
          (item) => `
          <li class="group rounded-2xl border border-neutral-800 bg-neutral-900/60 p-5 shadow-sm ring-1 ring-neutral-800/40 transition-all hover:border-neutral-700 hover:ring-neutral-700 hover:bg-neutral-900 relative"
              data-role="${item.role || ''}">
            <a href="/resources/${item.slug}" class="block">
              <h3 class="text-xl font-semibold text-sky-200 group-hover:text-sky-100">
                ${item.title}
              </h3>
              <p class="mt-1 text-sm text-neutral-400">
                ${item.source_name || ''} • ${new Date(item.publication_date).toLocaleDateString('en-GB', { year: 'numeric', month: 'short' })}
              </p>
              ${item.summary_short ? `<p class="mt-3 text-sm text-neutral-300 line-clamp-3">${item.summary_short}</p>` : ''}
              <div class="mt-3 flex flex-wrap gap-2 text-xs">
                ${item.role ? `<span class="rounded-full bg-purple-500/10 px-2 py-1 text-purple-300">${item.role}</span>` : ''}
                ${item.content_type ? `<span class="rounded-full bg-blue-500/10 px-2 py-1 text-blue-300">${item.content_type}</span>` : ''}
              </div>
            </a>
          </li>
        `,
        )
        .join('');
    }
  </script>

  <script>
    function enhanceImages(root) {
      const container = root || document;
      const imgs = Array.from(container.querySelectorAll('li.group img'));
      imgs.forEach((img) => {
        const placeholder = img.previousElementSibling;
        const onload = () => {
          img.classList.remove('opacity-0');
          if (placeholder && placeholder instanceof HTMLElement) {
            placeholder.style.display = 'none';
          }
        };
        const onerror = () => {
          const n = img.dataset?.next || '';
          if (n) {
            const parts = n.split('|');
            const nx = parts.shift();
            if (nx) {
              img.dataset.next = parts.join('|');
              img.src = nx;
              return;
            }
          }
          img.style.display = 'none';
          if (placeholder && placeholder instanceof HTMLElement) {
            placeholder.style.display = 'none';
          }
        };
        img.addEventListener('load', onload, { once: true });
        img.addEventListener('error', onerror);
        if (img.complete) {
          if (img.naturalWidth > 0) {
            onload();
          } else {
            onerror();
          }
        }
      });
    }

    if (document.readyState !== 'loading') {
      enhanceImages();
    } else {
      window.addEventListener('DOMContentLoaded', () => enhanceImages());
    }
  </script>
</Base>
