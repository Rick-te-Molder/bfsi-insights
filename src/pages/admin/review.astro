---
export const prerender = true;

import Base from '../../layouts/Base.astro';
---

<Base title="Review Queue">
  <div class="mx-auto max-w-7xl px-4 py-8">
    <header class="mb-8">
      <div class="flex items-start justify-between">
        <div>
          <h1 class="text-4xl font-bold">üìã Review Queue</h1>
          <p class="mt-2 text-neutral-300">Approve or reject discovered publications</p>
        </div>
        <div class="flex gap-3">
          <select
            id="persona-filter"
            class="rounded-lg border border-neutral-700 bg-neutral-900 px-4 py-2 text-sm text-neutral-300"
          >
            <option value="all">All Personas</option>
            <option value="executive">Executive</option>
            <option value="professional">Professional</option>
            <option value="academic">Academic</option>
          </select>
          <select
            id="sort-filter"
            class="rounded-lg border border-neutral-700 bg-neutral-900 px-4 py-2 text-sm text-neutral-300"
          >
            <option value="quality">Sort by Quality</option>
            <option value="date">Sort by Date</option>
          </select>
        </div>
      </div>

      <div id="stats" class="mt-4 flex gap-4 text-sm"></div>
    </header>

    <div
      id="loading"
      class="rounded-lg border border-neutral-800 bg-neutral-900/60 p-8 text-center"
    >
      <p class="text-neutral-400">‚è≥ Loading...</p>
    </div>

    <div id="error" class="hidden rounded-lg border border-red-500/20 bg-red-500/5 p-8 text-center">
      <p class="text-red-300"></p>
    </div>

    <div
      id="unenriched-notice"
      class="hidden mb-8 rounded-lg border border-amber-500/20 bg-amber-500/5 p-4"
    >
      <p class="text-amber-300"><span id="unenriched-count"></span> items need enrichment</p>
      <code class="mt-2 inline-block rounded bg-neutral-800 px-3 py-2 text-sm">
        node scripts/enrich.mjs
      </code>
    </div>

    <div id="items-container" class="space-y-6"></div>
  </div>

  <script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
    );

    async function loadQueue() {
      const loading = document.getElementById('loading');
      const errorBox = document.getElementById('error');
      const statsDiv = document.getElementById('stats');
      const unenrichedNotice = document.getElementById('unenriched-notice');
      const container = document.getElementById('items-container');

      if (!loading || !errorBox || !statsDiv || !unenrichedNotice || !container) {
        return;
      }

      try {
        const sessionRes = await supabase.auth.getSession();
        const session = sessionRes?.data?.session;

        if (!session) {
          window.location.href = '/login';
          return;
        }

        const result = await supabase
          .from('ingestion_queue')
          .select('*')
          .eq('status', 'enriched')
          .order('fetched_at', { ascending: false });

        if (result.error) throw result.error;

        loading.classList.add('hidden');
        const pending = result.data || [];

        const enriched = pending.filter(
          (x) => x.payload && x.payload.summary && x.payload.summary.short,
        );
        const notEnriched = pending.filter(
          (x) => !(x.payload && x.payload.summary && x.payload.summary.short),
        );

        // Stats
        statsDiv.innerHTML = `
          <span class="rounded-full bg-sky-500/10 px-3 py-1 text-sky-300">
            ${enriched.length} ready to review
          </span>
          <span class="rounded-full bg-amber-500/10 px-3 py-1 text-amber-300">
            ${notEnriched.length} awaiting enrichment
          </span>
        `;

        if (notEnriched.length > 0) {
          const unenrichedCount = document.getElementById('unenriched-count');
          if (unenrichedCount) {
            unenrichedCount.textContent = '‚è≥ ' + notEnriched.length;
          }
          unenrichedNotice.classList.remove('hidden');
        }

        if (enriched.length === 0) {
          container.innerHTML =
            '<div class="rounded-lg border border-neutral-800 bg-neutral-900/60 p-8 text-center"><p class="text-neutral-400">‚ú® Queue is empty!</p></div>';
          return;
        }

        // Debug: Log first item to check data structure
        console.log('üîç Debug - First item:', enriched[0]);
        console.log('üîç Debug - First item.id:', enriched[0].id, '| Type:', typeof enriched[0].id);

        container.innerHTML = enriched
          .map(
            (item) => `
            <article class="rounded-xl border border-neutral-800 bg-neutral-900/60 p-6 transition hover:border-neutral-700" data-item-id="${item.id}">
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                  <h2 class="text-2xl font-semibold text-sky-200">${item.payload.title}</h2>
                  <div class="mt-2 flex flex-wrap gap-2 text-sm text-neutral-400">
                    <span>üîó ${item.payload.source}</span>
                    <span>üìÖ ${new Date(item.payload.published_at).toLocaleDateString()}</span>
                  </div>
                  ${
                    item.payload.summary.short
                      ? `<p class="mt-4 text-neutral-300">${item.payload.summary.short}</p>`
                      : ''
                  }
                  <a href="${
                    item.url
                  }" target="_blank" rel="noopener noreferrer" class="mt-4 inline-block text-sm text-sky-400 hover:text-sky-300">View original ‚Üí</a>
                </div>

                <div class="flex flex-col gap-2">
                  <button class="approve-btn rounded-lg bg-emerald-600 px-6 py-2 font-semibold text-white hover:bg-emerald-500 transition" data-id="${
                    item.id
                  }">‚úì Approve</button>
                  <button class="reject-btn rounded-lg bg-red-600 px-6 py-2 font-semibold text-white hover:bg-red-500 transition" data-id="${
                    item.id
                  }">‚úó Reject</button>
                </div>
              </div>
            </article>
          `,
          )
          .join('');

        container.addEventListener('click', async (e) => {
          const target = e.target;
          if (!(target instanceof HTMLElement)) return;

          // Approve
          if (target.classList.contains('approve-btn')) {
            const id = target.dataset.id;
            if (!id) return;

            const article = document.querySelector('[data-item-id="' + id + '"]');
            if (!(article instanceof HTMLElement)) return;

            // Get current user for audit trail
            const session = (await supabase.auth.getSession()).data.session;
            const userId = session?.user?.id;

            console.log('Approving item:', { id, userId });

            // Update status directly (no RPC function needed)
            const { data, error, count } = await supabase
              .from('ingestion_queue')
              .update({
                status: 'approved',
                approved_at: new Date().toISOString(),
                reviewer: userId,
              })
              .eq('id', id)
              .eq('status', 'enriched')
              .select();

            console.log('Update result:', { data, error, count });

            if (error) {
              alert('Approval failed: ' + error.message);
              console.error('Approval error:', error);
              return;
            }

            if (!data || data.length === 0) {
              alert('Approval failed: Item not found or already processed');
              console.error('No rows updated. Item may not be in enriched status.');
              return;
            }

            article.classList.add('opacity-50');
            target.textContent = '‚úì Approved! (Run publish script)';
            target.setAttribute('disabled', 'true');
            setTimeout(() => article.remove(), 1500);
          }

          // Reject
          if (target.classList.contains('reject-btn')) {
            const id = target.dataset.id;
            if (!id) return;

            const reason = window.prompt('Reason for rejection (optional):');
            if (reason === null) return;

            const article = document.querySelector('[data-item-id="' + id + '"]');
            if (!(article instanceof HTMLElement)) return;

            // Get current user for audit trail
            const session = (await supabase.auth.getSession()).data.session;
            const userId = session?.user?.id;

            // Update status directly
            const { error } = await supabase
              .from('ingestion_queue')
              .update({
                status: 'rejected',
                rejection_reason: reason || null,
                reviewed_at: new Date().toISOString(),
                reviewer: userId,
              })
              .eq('id', id)
              .eq('status', 'enriched');

            if (error) {
              alert('Rejection failed: ' + error.message);
              console.error('Rejection error:', error);
              return;
            }

            article.classList.add('opacity-50');
            target.textContent = '‚úó Rejected';
            target.setAttribute('disabled', 'true');
            setTimeout(() => article.remove(), 1000);
          }
        });
      } catch (err) {
        if (loading) loading.classList.add('hidden');
        if (errorBox) {
          errorBox.classList.remove('hidden');
          const p = errorBox.querySelector('p');
          const msg = err instanceof Error ? err.message : 'Failed to load queue';
          if (p) p.textContent = msg;
        }
      }
    }

    loadQueue();
  </script>
</Base>
