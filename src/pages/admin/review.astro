---
// Static page with client-side real-time data fetching
export const prerender = true;

import Base from '../../layouts/Base.astro';
import PublicationModal from '../../features/publications/PublicationModal.astro';
---

<Base title="Review Queue">
  <div class="mx-auto max-w-7xl px-4 py-8">
    <!-- Header -->
    <header class="mb-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold">Review Dashboard</h1>
          <p class="mt-1 text-neutral-400">Preview and approve publications</p>
        </div>
        <div class="flex gap-3">
          <a
            href="/admin/publications"
            class="rounded-lg border border-neutral-700 px-4 py-2 text-sm font-medium text-neutral-300 hover:bg-neutral-800 transition-colors"
          >
            üìÑ Published
          </a>
          <a
            href="/admin/sources"
            class="rounded-lg border border-neutral-700 px-4 py-2 text-sm font-medium text-neutral-300 hover:bg-neutral-800 transition-colors"
          >
            üì° Sources
          </a>
          <a
            href="/admin/prompts"
            class="rounded-lg border border-neutral-700 px-4 py-2 text-sm font-medium text-neutral-300 hover:bg-neutral-800 transition-colors"
          >
            üìù Prompts
          </a>
          <a
            href="/admin/add"
            class="rounded-lg bg-sky-600 px-4 py-2 text-sm font-medium text-white hover:bg-sky-500 transition-colors"
          >
            ‚ûï Add URL
          </a>
          <button
            id="trigger-build"
            class="rounded-lg border border-emerald-500/40 bg-emerald-500/10 px-4 py-2 text-sm font-medium text-emerald-200 hover:bg-emerald-500/20 transition-colors"
            type="button"
          >
            üöÄ Trigger Build
          </button>
        </div>
      </div>
      <div id="stats" class="mt-4 flex items-center gap-4"></div>
      <p id="build-status" class="mt-2 text-xs text-neutral-400"></p>
    </header>

    <!-- Loading State -->
    <div
      id="loading"
      class="rounded-xl border border-neutral-800 bg-neutral-900/60 p-12 text-center"
    >
      <div class="text-4xl mb-3">‚è≥</div>
      <p class="text-neutral-400">Loading review queue...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden rounded-xl border border-red-500/20 bg-red-500/5 p-8 text-center">
      <p class="text-red-300"></p>
    </div>

    <!-- Empty State -->
    <div
      id="empty-state"
      class="hidden rounded-xl border border-neutral-800 bg-neutral-900/60 p-12 text-center"
    >
      <div class="text-5xl mb-4">‚ú®</div>
      <h2 class="text-2xl font-semibold text-neutral-200 mb-2">Queue is empty!</h2>
      <p class="text-neutral-400">All items have been reviewed. Check back later.</p>
    </div>

    <!-- Unenriched Notice -->
    <div
      id="unenriched-notice"
      class="hidden mb-6 rounded-xl border border-amber-500/20 bg-amber-500/5 p-4"
    >
      <p class="text-amber-300"><span id="unenriched-count"></span> items awaiting enrichment</p>
    </div>

    <!-- Main Review Area -->
    <div id="review-area" class="hidden">
      <!-- Navigation -->
      <div id="nav-container" class="flex items-center justify-center gap-4 mb-6">
        <button
          id="prev-btn"
          class="rounded-lg border border-neutral-700 bg-neutral-800 px-4 py-2 text-sm text-neutral-300 hover:bg-neutral-700 disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
        >
          ‚Üê Previous
        </button>
        <div id="dots-container" class="flex gap-1.5"></div>
        <button
          id="next-btn"
          class="rounded-lg border border-neutral-700 bg-neutral-800 px-4 py-2 text-sm text-neutral-300 hover:bg-neutral-700 disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
        >
          Next ‚Üí
        </button>
      </div>

      <!-- Two-column layout: Card Preview + Admin Panel -->
      <div class="grid grid-cols-1 xl:grid-cols-[1fr,400px] gap-6">
        <!-- Left: Card Preview (exactly as published) -->
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-neutral-400 uppercase tracking-wide">
              üì∞ Card Preview (as it will appear)
            </h2>
            <span id="viewing-indicator" class="text-sm text-neutral-500"></span>
          </div>

          <!-- Publication Card Container -->
          <ul id="card-preview" class="space-y-0"></ul>
        </div>

        <!-- Right: Admin Panel -->
        <div id="admin-panel" class="space-y-4"></div>
      </div>
    </div>
  </div>

  <!-- Modal for preview -->
  <PublicationModal />

  <script>
    import { createClient } from '@supabase/supabase-js';
    import initPublicationModal from '../../features/publications/publication-modal';

    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
    );

    // State
    let items = [];
    let currentIndex = 0;
    let industryMap = new Map();
    let topicMap = new Map();
    let existingVendors = new Set();
    let existingOrgs = new Set();
    let processing = false;

    // DOM Elements
    const loading = document.getElementById('loading');
    const errorBox = document.getElementById('error');
    const emptyState = document.getElementById('empty-state');
    const statsDiv = document.getElementById('stats');
    const unenrichedNotice = document.getElementById('unenriched-notice');
    const reviewArea = document.getElementById('review-area');
    const cardPreview = document.getElementById('card-preview');
    const adminPanel = document.getElementById('admin-panel');
    const viewingIndicator = document.getElementById('viewing-indicator');
    const dotsContainer = document.getElementById('dots-container');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const buildBtn = document.getElementById('trigger-build');
    const buildStatus = document.getElementById('build-status');

    // Initialize modal
    initPublicationModal();

    // Format date helper
    const formatDate = (iso) => {
      if (!iso) return '';
      return new Date(iso).toLocaleDateString('en-GB', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      });
    };

    // Trigger build handler
    if (buildBtn instanceof HTMLButtonElement && buildStatus) {
      buildBtn.addEventListener('click', async () => {
        buildBtn.disabled = true;
        buildBtn.textContent = '‚è≥ Triggering‚Ä¶';
        try {
          const response = await fetch('https://bfsi-insights.onrender.com/api/trigger-build', {
            method: 'POST',
          });
          const data = await response.json().catch(() => ({}));
          if (!response.ok || !data.ok) throw new Error(data.message || 'Build hook failed');
          buildBtn.textContent = '‚úÖ Build queued';
          setTimeout(() => {
            buildBtn.textContent = 'üöÄ Trigger Build';
            buildBtn.disabled = false;
          }, 5000);
        } catch (err) {
          buildBtn.textContent = 'üöÄ Trigger Build';
          buildBtn.disabled = false;
          buildStatus.textContent = `‚ö†Ô∏è ${err instanceof Error ? err.message : 'Failed'}`;
        }
      });
    }

    // Navigation
    function updateNavigation() {
      if (prevBtn) prevBtn.disabled = currentIndex === 0;
      if (nextBtn) nextBtn.disabled = currentIndex >= items.length - 1;
      if (viewingIndicator) viewingIndicator.textContent = `${currentIndex + 1} of ${items.length}`;

      // Update dots
      if (dotsContainer) {
        dotsContainer.innerHTML = items
          .map(
            (_, i) => `
          <button class="w-2.5 h-2.5 rounded-full transition-colors ${i === currentIndex ? 'bg-sky-500' : 'bg-neutral-700 hover:bg-neutral-600'}" data-index="${i}"></button>
        `,
          )
          .join('');
      }
    }

    prevBtn?.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        renderCurrentItem();
      }
    });

    nextBtn?.addEventListener('click', () => {
      if (currentIndex < items.length - 1) {
        currentIndex++;
        renderCurrentItem();
      }
    });

    dotsContainer?.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (btn && btn.dataset.index) {
        currentIndex = parseInt(btn.dataset.index, 10);
        renderCurrentItem();
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (processing) return;
      if (e.key === 'ArrowLeft' && currentIndex > 0) {
        currentIndex--;
        renderCurrentItem();
      } else if (e.key === 'ArrowRight' && currentIndex < items.length - 1) {
        currentIndex++;
        renderCurrentItem();
      } else if (e.key === 'a' && !e.metaKey && !e.ctrlKey) {
        e.preventDefault();
        handleApprove();
      } else if (e.key === 'r' && !e.metaKey && !e.ctrlKey) {
        e.preventDefault();
        handleReject();
      } else if (e.key === 'p' && !e.metaKey && !e.ctrlKey) {
        e.preventDefault();
        const previewBtn = cardPreview?.querySelector('[data-open-modal]');
        if (previewBtn) previewBtn.click();
      }
    });

    // Render the card preview (styled exactly like published cards)
    function renderCardPreview(item) {
      const payload = item.payload || {};
      const summary = payload.summary || {};
      const industryCodes = (payload.industry_codes || []).filter((c) => c && c !== 'null');
      const topicCodes = (payload.topic_codes || []).filter((c) => c && c !== 'null');

      // Resolve thumbnail
      let thumbnailUrl = payload.thumbnail || null;
      if (!thumbnailUrl && payload.thumbnail_path && payload.thumbnail_bucket) {
        thumbnailUrl = `${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/${payload.thumbnail_bucket}/${payload.thumbnail_path}`;
      }

      // Generate tags HTML
      const tagsHtml = [
        ...industryCodes.slice(0, 2).map(
          (code) => `
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-blue-500/10 text-blue-300 ring-1 ring-inset ring-blue-500/20">
            ${industryMap.get(code) || code}
          </span>
        `,
        ),
        ...topicCodes.slice(0, 2).map(
          (code) => `
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-purple-500/10 text-purple-300 ring-1 ring-inset ring-purple-500/20">
            ${topicMap.get(code) || code}
          </span>
        `,
        ),
      ].join('');

      return `
        <li class="group rounded-2xl border border-neutral-800 bg-neutral-900/60 p-5 shadow-sm ring-1 ring-neutral-800/40 transition-all hover:border-neutral-700 hover:ring-neutral-700 hover:bg-neutral-900 relative"
            data-item-id="${item.id}"
            data-title="${(payload.title || '').replace(/"/g, '&quot;')}"
            data-url="${item.url}"
            data-summary-medium="${(summary.medium || '').replace(/"/g, '&quot;')}">
          
          <a href="/admin/preview?id=${item.id}" class="absolute inset-0 rounded-2xl focus:outline-none focus:ring-2 focus:ring-sky-500 z-10" data-card-link></a>
          
          <div class="relative z-20 pointer-events-none flex flex-col h-full">
            <h3 class="text-xl font-semibold text-sky-200 line-clamp-2">${payload.title || 'Untitled'}</h3>
            
            <div class="relative mt-1 text-sm text-neutral-200">
              ${payload.published_at ? `<span><span class="text-neutral-400">Published</span> ${formatDate(payload.published_at)}</span>` : ''}
            </div>
            
            <div class="relative mt-2 w-full rounded-md border border-neutral-800 bg-neutral-800/40" style="aspect-ratio: 16 / 9; overflow: hidden;">
              ${
                thumbnailUrl
                  ? `
                <img src="${thumbnailUrl}" alt="Preview" class="absolute inset-0 w-full h-full object-cover" loading="lazy" />
              `
                  : `
                <div class="absolute inset-0 flex items-center justify-center">
                  <svg class="h-10 w-10 text-neutral-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </div>
              `
              }
            </div>
            
            ${summary.short ? `<p class="mt-2 text-sm text-neutral-300 line-clamp-2">${summary.short}</p>` : ''}
            
            <div class="mt-auto pt-3 flex items-start justify-between gap-2">
              <div class="flex flex-wrap items-center gap-1.5 flex-1 min-w-0">
                ${tagsHtml}
              </div>
              <button class="relative z-30 flex-shrink-0 inline-flex items-center gap-1 text-xs text-sky-300 hover:text-sky-200 transition-colors px-2 py-0.5 rounded hover:bg-neutral-800/50 pointer-events-auto" type="button" data-open-modal="true">
                <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                Preview
              </button>
            </div>
          </div>
        </li>
      `;
    }

    // Render the admin panel
    function renderAdminPanel(item) {
      const payload = item.payload || {};
      const summary = payload.summary || {};
      const industryCodes = (payload.industry_codes || []).filter((c) => c && c !== 'null');
      const topicCodes = (payload.topic_codes || []).filter((c) => c && c !== 'null');
      const vendorNames = (payload.vendor_names || []).filter((n) => n && n !== 'null');
      const orgNames = (payload.organization_names || []).filter((n) => n && n !== 'null');

      // Summary validation
      const shortLen = summary.short?.length || 0;
      const mediumLen = summary.medium?.length || 0;
      const longLen = summary.long?.length || 0;
      const shortValid = shortLen >= 120 && shortLen <= 150;
      const mediumValid = mediumLen >= 250 && mediumLen <= 300;
      const longValid = longLen >= 500 && longLen <= 600;

      // Entity status
      const vendorStatus = vendorNames.map((name) => ({
        name,
        isNew: !existingVendors.has(name.toLowerCase()),
      }));
      const orgStatus = orgNames.map((name) => ({
        name,
        isNew: !existingOrgs.has(name.toLowerCase()),
      }));

      return `
        <!-- Edit Title -->
        <div class="rounded-xl border border-neutral-800 bg-neutral-900/60 p-4">
          <h3 class="text-sm font-semibold text-neutral-400 uppercase tracking-wide mb-2">Edit Title</h3>
          <input 
            type="text" 
            id="edit-title" 
            value="${(payload.title || '').replace(/"/g, '&quot;')}"
            class="w-full rounded-lg border border-neutral-700 bg-neutral-800 px-3 py-2 text-sm text-neutral-100 focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
          />
          <p class="text-xs text-neutral-500 mt-1">Edit before approving</p>
        </div>

        <!-- Actions -->
        <div class="rounded-xl border border-neutral-800 bg-neutral-900/60 p-4 space-y-3">
          <h3 class="text-sm font-semibold text-neutral-400 uppercase tracking-wide">Actions</h3>
          <button id="approve-btn" class="w-full rounded-lg bg-emerald-600 px-4 py-3 text-lg font-semibold text-white hover:bg-emerald-500 transition-colors">
            ‚úì Approve & Publish
          </button>
          <button id="reject-btn" class="w-full rounded-lg bg-red-600/80 px-4 py-2.5 font-medium text-white hover:bg-red-600 transition-colors">
            ‚úó Reject
          </button>
          <button id="reenrich-btn" class="w-full rounded-lg border border-amber-500/50 bg-amber-500/10 px-4 py-2 text-sm font-medium text-amber-300 hover:bg-amber-500/20 transition-colors">
            üîÑ Re-enrich
          </button>
        </div>

        <!-- Quality Metrics -->
        <div class="rounded-xl border border-neutral-800 bg-neutral-900/60 p-4">
          <h3 class="text-sm font-semibold text-neutral-400 uppercase tracking-wide mb-3">Quality Metrics</h3>
          <div class="space-y-2 text-sm">
            <div class="flex items-center justify-between">
              <span class="text-neutral-400">Short <span class="text-neutral-500">(120-150)</span></span>
              <span class="${shortValid ? 'text-emerald-400' : 'text-amber-400'}">${shortValid ? '‚úì' : '‚ö†Ô∏è'} ${shortLen}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-neutral-400">Medium <span class="text-neutral-500">(250-300)</span></span>
              <span class="${mediumValid ? 'text-emerald-400' : 'text-amber-400'}">${mediumValid ? '‚úì' : '‚ö†Ô∏è'} ${mediumLen}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-neutral-400">Long <span class="text-neutral-500">(500-600)</span></span>
              <span class="${longValid ? 'text-emerald-400' : 'text-amber-400'}">${longValid ? '‚úì' : '‚ö†Ô∏è'} ${longLen}</span>
            </div>
            ${
              payload.relevance_confidence
                ? `
            <div class="flex items-center justify-between">
              <span class="text-neutral-400">AI Confidence</span>
              <span class="text-emerald-400">${(payload.relevance_confidence * 100).toFixed(0)}%</span>
            </div>
            `
                : ''
            }
          </div>
        </div>

        <!-- Tags -->
        <div class="rounded-xl border border-neutral-800 bg-neutral-900/60 p-4">
          <h3 class="text-sm font-semibold text-neutral-400 uppercase tracking-wide mb-3">Tags</h3>
          <div class="space-y-2 text-xs">
            <div class="flex items-start justify-between gap-2">
              <span class="text-neutral-500 shrink-0">Industries</span>
              <div class="flex flex-wrap gap-1 justify-end">
                ${
                  industryCodes.length > 0
                    ? industryCodes
                        .map(
                          (code) =>
                            `<span class="px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-300">${industryMap.get(code) || code}</span>`,
                        )
                        .join('')
                    : '<span class="text-neutral-600">‚Äî</span>'
                }
              </div>
            </div>
            <div class="flex items-start justify-between gap-2">
              <span class="text-neutral-500 shrink-0">Topics</span>
              <div class="flex flex-wrap gap-1 justify-end">
                ${
                  topicCodes.length > 0
                    ? topicCodes
                        .map(
                          (code) =>
                            `<span class="px-1.5 py-0.5 rounded bg-purple-500/10 text-purple-300">${topicMap.get(code) || code}</span>`,
                        )
                        .join('')
                    : '<span class="text-neutral-600">‚Äî</span>'
                }
              </div>
            </div>
            <div class="flex items-start justify-between gap-2">
              <span class="text-neutral-500 shrink-0">Persona</span>
              <div class="flex flex-wrap gap-1 justify-end">
                ${
                  Object.keys(payload.persona_scores || {}).length > 0
                    ? Object.entries(payload.persona_scores || {})
                        .map(
                          ([p, s]) =>
                            `<span class="px-1.5 py-0.5 rounded bg-emerald-500/10 text-emerald-300">${p} ${Math.round(s * 100)}%</span>`,
                        )
                        .join('')
                    : '<span class="text-neutral-600">‚Äî</span>'
                }
              </div>
            </div>
            <div class="flex items-start justify-between gap-2">
              <span class="text-neutral-500 shrink-0">Geography</span>
              <div class="flex flex-wrap gap-1 justify-end">
                ${
                  (payload.geography_codes || []).length > 0
                    ? (payload.geography_codes || [])
                        .map(
                          (code) =>
                            `<span class="px-1.5 py-0.5 rounded bg-sky-500/10 text-sky-300">${code}</span>`,
                        )
                        .join('')
                    : '<span class="text-neutral-600">‚Äî</span>'
                }
              </div>
            </div>
            <div class="flex items-start justify-between gap-2">
              <span class="text-neutral-500 shrink-0">Regulators</span>
              <div class="flex flex-wrap gap-1 justify-end">
                ${
                  (payload.regulator_codes || []).length > 0
                    ? (payload.regulator_codes || [])
                        .map(
                          (code) =>
                            `<span class="px-1.5 py-0.5 rounded bg-amber-500/10 text-amber-300">${code}</span>`,
                        )
                        .join('')
                    : '<span class="text-neutral-600">‚Äî</span>'
                }
              </div>
            </div>
            <div class="flex items-start justify-between gap-2">
              <span class="text-neutral-500 shrink-0">Regulations</span>
              <div class="flex flex-wrap gap-1 justify-end">
                ${
                  (payload.regulation_codes || []).length > 0
                    ? (payload.regulation_codes || [])
                        .map(
                          (code) =>
                            `<span class="px-1.5 py-0.5 rounded bg-orange-500/10 text-orange-300">${code}</span>`,
                        )
                        .join('')
                    : '<span class="text-neutral-600">‚Äî</span>'
                }
              </div>
            </div>
            <div class="flex items-start justify-between gap-2">
              <span class="text-neutral-500 shrink-0">Vendors</span>
              <div class="flex flex-wrap gap-1 justify-end">
                ${
                  vendorNames.length > 0
                    ? vendorNames
                        .map(
                          (name) =>
                            `<span class="px-1.5 py-0.5 rounded bg-teal-500/10 text-teal-300">${name}</span>`,
                        )
                        .join('')
                    : '<span class="text-neutral-600">‚Äî</span>'
                }
              </div>
            </div>
            <div class="flex items-start justify-between gap-2">
              <span class="text-neutral-500 shrink-0">Organizations</span>
              <div class="flex flex-wrap gap-1 justify-end">
                ${
                  orgNames.length > 0
                    ? orgNames
                        .map(
                          (name) =>
                            `<span class="px-1.5 py-0.5 rounded bg-pink-500/10 text-pink-300">${name}</span>`,
                        )
                        .join('')
                    : '<span class="text-neutral-600">‚Äî</span>'
                }
              </div>
            </div>
          </div>
        </div>

        <!-- Entity Curation -->
        ${
          vendorStatus.length > 0 || orgStatus.length > 0
            ? `
        <div class="rounded-xl border border-amber-500/20 bg-amber-500/5 p-4">
          <h3 class="text-sm font-semibold text-amber-300 uppercase tracking-wide mb-3">üè∑Ô∏è Taxonomy Curation</h3>
          ${
            vendorStatus.length > 0
              ? `
          <div class="mb-3">
            <span class="text-xs text-neutral-400">AI/Tech Vendors</span>
            <div class="flex flex-wrap gap-2 mt-1">
              ${vendorStatus
                .map(
                  (v) => `
                <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md cursor-pointer transition ${v.isNew ? 'bg-emerald-500/10 border border-emerald-500/30 hover:bg-emerald-500/20' : 'bg-neutral-800 border border-neutral-700'}">
                  <input type="checkbox" class="vendor-checkbox rounded border-neutral-600 bg-neutral-800 text-emerald-500" data-name="${v.name}" ${v.isNew ? 'checked' : ''} />
                  <span class="text-sm ${v.isNew ? 'text-emerald-300' : 'text-neutral-400'}">${v.name}</span>
                  ${v.isNew ? '<span class="text-xs px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-400">NEW</span>' : '<span class="text-xs text-neutral-500">exists</span>'}
                </label>
              `,
                )
                .join('')}
            </div>
          </div>
          `
              : ''
          }
          ${
            orgStatus.length > 0
              ? `
          <div>
            <span class="text-xs text-neutral-400">BFSI Organizations</span>
            <div class="flex flex-wrap gap-2 mt-1">
              ${orgStatus
                .map(
                  (o) => `
                <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md cursor-pointer transition ${o.isNew ? 'bg-sky-500/10 border border-sky-500/30 hover:bg-sky-500/20' : 'bg-neutral-800 border border-neutral-700'}">
                  <input type="checkbox" class="org-checkbox rounded border-neutral-600 bg-neutral-800 text-sky-500" data-name="${o.name}" ${o.isNew ? 'checked' : ''} />
                  <span class="text-sm ${o.isNew ? 'text-sky-300' : 'text-neutral-400'}">${o.name}</span>
                  ${o.isNew ? '<span class="text-xs px-1.5 py-0.5 rounded bg-sky-500/20 text-sky-400">NEW</span>' : '<span class="text-xs text-neutral-500">exists</span>'}
                </label>
              `,
                )
                .join('')}
            </div>
          </div>
          `
              : ''
          }
        </div>
        `
            : ''
        }
      `;
    }

    // Render current item
    function renderCurrentItem() {
      if (!items.length) return;
      const item = items[currentIndex];
      if (cardPreview) cardPreview.innerHTML = renderCardPreview(item);
      if (adminPanel) adminPanel.innerHTML = renderAdminPanel(item);
      updateNavigation();
      bindActionButtons();
    }

    // Bind action buttons
    function bindActionButtons() {
      document.getElementById('approve-btn')?.addEventListener('click', handleApprove);
      document.getElementById('reject-btn')?.addEventListener('click', handleReject);
      document.getElementById('reenrich-btn')?.addEventListener('click', handleReenrich);
    }

    // Handle approve
    async function handleApprove() {
      const item = items[currentIndex];
      if (!item || processing) return;

      processing = true;
      const btn = document.getElementById('approve-btn');
      if (btn) btn.textContent = '‚è≥ Publishing...';

      // Get edited title
      const titleInput = document.getElementById('edit-title');
      const editedTitle = titleInput?.value?.trim() || item.payload?.title;

      // Collect selected entities
      const selectedVendors = [...document.querySelectorAll('.vendor-checkbox:checked')]
        .map((cb) => cb.dataset.name)
        .filter(Boolean);
      const selectedOrgs = [...document.querySelectorAll('.org-checkbox:checked')]
        .map((cb) => cb.dataset.name)
        .filter(Boolean);

      try {
        // Update title in queue item if changed
        // IMPORTANT: Fetch fresh payload to avoid overwriting re-enriched data
        if (editedTitle !== item.payload?.title) {
          const { data: freshItem, error: fetchError } = await supabase
            .from('ingestion_queue')
            .select('payload')
            .eq('id', item.id)
            .single();
          if (fetchError) throw fetchError;

          const { error: updateError } = await supabase
            .from('ingestion_queue')
            .update({
              payload: { ...freshItem.payload, title: editedTitle },
            })
            .eq('id', item.id);
          if (updateError) throw updateError;
        }

        const { error } = await supabase.rpc('approve_from_queue', {
          p_queue_id: item.id,
          p_approved_vendors: selectedVendors,
          p_approved_organizations: selectedOrgs,
        });
        if (error) throw error;

        // Remove from list
        items = items.filter((_, i) => i !== currentIndex);
        if (currentIndex >= items.length) currentIndex = Math.max(0, items.length - 1);

        if (items.length === 0) {
          reviewArea?.classList.add('hidden');
          emptyState?.classList.remove('hidden');
        } else {
          renderCurrentItem();
        }
        updateStats();
      } catch (err) {
        const msg =
          err?.message || err?.error_description || JSON.stringify(err) || 'Unknown error';
        alert('Approve failed: ' + msg);
        console.error('Approve error:', err);
        if (btn) btn.textContent = '‚úì Approve & Publish';
      } finally {
        processing = false;
      }
    }

    // Handle reject
    async function handleReject() {
      const item = items[currentIndex];
      if (!item || processing) return;

      const reason = window.prompt('Reason for rejection (optional):');
      if (reason === null) return;

      processing = true;
      const btn = document.getElementById('reject-btn');
      if (btn) btn.textContent = '‚è≥ Rejecting...';

      try {
        const session = (await supabase.auth.getSession()).data.session;
        const { error } = await supabase
          .from('ingestion_queue')
          .update({
            status: 'rejected',
            rejection_reason: reason || null,
            reviewed_at: new Date().toISOString(),
            reviewer: session?.user?.id,
          })
          .eq('id', item.id);
        if (error) throw error;

        items = items.filter((_, i) => i !== currentIndex);
        if (currentIndex >= items.length) currentIndex = Math.max(0, items.length - 1);

        if (items.length === 0) {
          reviewArea?.classList.add('hidden');
          emptyState?.classList.remove('hidden');
        } else {
          renderCurrentItem();
        }
        updateStats();
      } catch (err) {
        alert('Reject failed: ' + (err instanceof Error ? err.message : 'Unknown error'));
        if (btn) btn.textContent = '‚úó Reject';
      } finally {
        processing = false;
      }
    }

    // Handle re-enrich
    async function handleReenrich() {
      const item = items[currentIndex];
      if (!item || processing) return;

      processing = true;
      const btn = document.getElementById('reenrich-btn');
      if (btn) btn.textContent = '‚è≥ Enriching...';

      try {
        // Get current session for auth header
        const {
          data: { session: currentSession },
        } = await supabase.auth.getSession();
        if (!currentSession) throw new Error('Not authenticated');

        // Call Edge Function (handles status reset + agent API call securely)
        const response = await supabase.functions.invoke('trigger-enrichment', {
          body: { queue_id: item.id },
        });

        if (response.error) {
          throw new Error(response.error.message || 'Edge function failed');
        }

        // Show success and reload
        if (btn) btn.textContent = '‚úì Done!';

        // Wait a moment then reload to show updated item
        setTimeout(async () => {
          await loadQueue();
          // Find the same item (might have new index)
          const newIndex = items.findIndex((i) => i.id === item.id);
          if (newIndex >= 0) {
            currentIndex = newIndex;
            renderCurrentItem();
          }
        }, 1000);
      } catch (err) {
        alert('Re-enrich failed: ' + (err instanceof Error ? err.message : 'Unknown error'));
        console.error('Re-enrich error:', err);
        if (btn) btn.textContent = 'üîÑ Re-enrich';
      } finally {
        processing = false;
      }
    }

    // Update stats
    function updateStats() {
      if (statsDiv) {
        statsDiv.innerHTML = `
          <span class="rounded-full bg-sky-500/10 px-3 py-1 text-sky-300">${items.length} ready to review</span>
        `;
      }
    }

    // Load data
    async function loadQueue() {
      try {
        const sessionRes = await supabase.auth.getSession();
        if (!sessionRes?.data?.session) {
          window.location.href = '/login';
          return;
        }

        const [queueResult, industriesResult, topicsResult, vendorsResult, orgsResult] =
          await Promise.all([
            supabase
              .from('ingestion_queue')
              .select('*')
              .eq('status', 'enriched')
              .order('fetched_at', { ascending: false }),
            supabase.from('bfsi_industry').select('code, name').order('sort_order'),
            supabase.from('bfsi_topic').select('code, name').order('sort_order'),
            supabase.from('ag_vendor').select('id, name'),
            supabase.from('bfsi_organization').select('id, organization_name'),
          ]);

        if (queueResult.error) throw queueResult.error;

        industryMap = new Map((industriesResult.data || []).map((i) => [i.code, i.name]));
        topicMap = new Map((topicsResult.data || []).map((t) => [t.code, t.name]));
        existingVendors = new Set((vendorsResult.data || []).map((v) => v.name.toLowerCase()));
        existingOrgs = new Set(
          (orgsResult.data || []).map((o) => o.organization_name.toLowerCase()),
        );

        const pending = queueResult.data || [];
        items = pending.filter((x) => x.payload?.summary?.short);
        const notEnriched = pending.filter((x) => !x.payload?.summary?.short);

        loading?.classList.add('hidden');

        // Stats
        if (statsDiv) {
          statsDiv.innerHTML = `
            <span class="rounded-full bg-sky-500/10 px-3 py-1 text-sky-300">${items.length} ready to review</span>
            <span class="rounded-full bg-amber-500/10 px-3 py-1 text-amber-300">${notEnriched.length} awaiting enrichment</span>
          `;
        }

        if (notEnriched.length > 0) {
          const unenrichedCount = document.getElementById('unenriched-count');
          if (unenrichedCount) unenrichedCount.textContent = '‚è≥ ' + notEnriched.length;
          unenrichedNotice?.classList.remove('hidden');
        }

        if (items.length === 0) {
          emptyState?.classList.remove('hidden');
        } else {
          reviewArea?.classList.remove('hidden');
          renderCurrentItem();
        }
      } catch (err) {
        loading?.classList.add('hidden');
        if (errorBox) {
          errorBox.classList.remove('hidden');
          const p = errorBox.querySelector('p');
          if (p) p.textContent = err instanceof Error ? err.message : 'Failed to load queue';
        }
      }
    }

    loadQueue();
  </script>
</Base>
