---
// Static page with client-side real-time data fetching
export const prerender = true;

import Base from '../../layouts/Base.astro';
---

<Base title="Review Queue">
  <div class="mx-auto max-w-7xl px-4 py-8">
    <header class="mb-8">
      <div class="flex items-start justify-between">
        <div>
          <h1 class="text-4xl font-bold">Review Queue</h1>
          <p class="mt-2 text-neutral-300">Approve or reject discovered publications</p>
        </div>
        <div class="flex gap-3">
          <a
            href="/admin/add"
            class="rounded-lg bg-sky-600 px-4 py-2 text-sm font-medium text-white hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/20"
          >
            ‚ûï Add URL
          </a>
          <button
            id="trigger-build"
            class="rounded-lg border border-emerald-500/40 bg-emerald-500/10 px-4 py-2 text-sm font-medium text-emerald-200 hover:bg-emerald-500/20 focus:outline-none focus:ring-2 focus:ring-emerald-500/30"
            type="button"
          >
            Trigger Build
          </button>
        </div>
      </div>

      <div id="stats" class="mt-4 flex gap-4 text-sm"></div>
      <p id="build-status" class="mt-2 text-xs text-neutral-400"></p>
    </header>

    <div
      id="loading"
      class="rounded-lg border border-neutral-800 bg-neutral-900/60 p-8 text-center"
    >
      <p class="text-neutral-400">‚è≥ Loading...</p>
    </div>

    <div id="error" class="hidden rounded-lg border border-red-500/20 bg-red-500/5 p-8 text-center">
      <p class="text-red-300"></p>
    </div>

    <div
      id="unenriched-notice"
      class="hidden mb-8 rounded-lg border border-amber-500/20 bg-amber-500/5 p-4"
    >
      <p class="text-amber-300"><span id="unenriched-count"></span> items need enrichment</p>
      <code class="mt-2 inline-block rounded bg-neutral-800 px-3 py-2 text-sm">
        node scripts/enrich.mjs
      </code>
    </div>

    <div id="items-container" class="space-y-6"></div>
  </div>

  <script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
    );

    async function loadQueue() {
      const loading = document.getElementById('loading');
      const errorBox = document.getElementById('error');
      const statsDiv = document.getElementById('stats');
      const unenrichedNotice = document.getElementById('unenriched-notice');
      const container = document.getElementById('items-container');
      const buildBtn = document.getElementById('trigger-build');
      const buildStatus = document.getElementById('build-status');

      if (!loading || !errorBox || !statsDiv || !unenrichedNotice || !container) {
        return;
      }

      if (buildBtn instanceof HTMLButtonElement && buildStatus) {
        buildBtn.addEventListener('click', async () => {
          buildBtn.disabled = true;
          buildBtn.textContent = '‚è≥ Triggering‚Ä¶';
          buildStatus.textContent = '';
          buildStatus.className = 'mt-2 text-xs text-neutral-400';
          try {
            const response = await fetch('https://bfsi-insights.onrender.com/api/trigger-build', {
              method: 'POST',
            });
            const data = await response.json().catch(() => ({}));
            if (!response.ok || !data.ok) {
              throw new Error(data.message || 'Build hook failed');
            }
            buildBtn.textContent = '‚úÖ Build queued';
            buildStatus.textContent = 'Cloudflare rebuild requested successfully.';
          } catch (err) {
            if (buildBtn instanceof HTMLButtonElement) {
              buildBtn.textContent = 'üöÄ Trigger Build';
              buildBtn.disabled = false;
            }
            buildStatus.textContent = `‚ö†Ô∏è ${err instanceof Error ? err.message : 'Failed to trigger build'}`;
            buildStatus.className = 'mt-2 text-xs text-amber-300';
            return;
          }

          setTimeout(() => {
            if (buildBtn instanceof HTMLButtonElement) {
              buildBtn.textContent = 'üöÄ Trigger Build';
              buildBtn.disabled = false;
            }
            buildStatus.textContent = '';
            buildStatus.className = 'mt-2 text-xs text-neutral-400';
          }, 5000);
        });
      }

      try {
        const sessionRes = await supabase.auth.getSession();
        const session = sessionRes?.data?.session;

        if (!session) {
          window.location.href = '/login';
          return;
        }

        // Load taxonomy for code-to-label mapping and existing entities for duplicate detection
        const [queueResult, industriesResult, topicsResult, vendorsResult, orgsResult] =
          await Promise.all([
            supabase
              .from('ingestion_queue')
              .select('*')
              .eq('status', 'enriched')
              .order('fetched_at', { ascending: false }),
            supabase.from('bfsi_industry').select('code, name').order('sort_order'),
            supabase.from('bfsi_topic').select('code, name').order('sort_order'),
            supabase.from('ag_vendor').select('id, name'),
            supabase.from('bfsi_organization').select('id, organization_name'),
          ]);

        if (queueResult.error) throw queueResult.error;

        // Create lookup maps
        const industryMap = new Map((industriesResult.data || []).map((i) => [i.code, i.name]));
        const topicMap = new Map((topicsResult.data || []).map((t) => [t.code, t.name]));

        // Existing entities for duplicate detection (lowercase for case-insensitive matching)
        const existingVendors = new Set(
          (vendorsResult.data || []).map((v) => v.name.toLowerCase()),
        );
        const existingOrgs = new Set(
          (orgsResult.data || []).map((o) => o.organization_name.toLowerCase()),
        );

        loading.classList.add('hidden');
        const pending = queueResult.data || [];

        const enriched = pending.filter(
          (x) => x.payload && x.payload.summary && x.payload.summary.short,
        );
        const notEnriched = pending.filter(
          (x) => !(x.payload && x.payload.summary && x.payload.summary.short),
        );

        // Stats
        statsDiv.innerHTML = `
          <span class="rounded-full bg-sky-500/10 px-3 py-1 text-sky-300">
            ${enriched.length} ready to review
          </span>
          <span class="rounded-full bg-amber-500/10 px-3 py-1 text-amber-300">
            ${notEnriched.length} awaiting enrichment
          </span>
        `;

        if (notEnriched.length > 0) {
          const unenrichedCount = document.getElementById('unenriched-count');
          if (unenrichedCount) {
            unenrichedCount.textContent = '‚è≥ ' + notEnriched.length;
          }
          unenrichedNotice.classList.remove('hidden');
        }

        if (enriched.length === 0) {
          container.innerHTML =
            '<div class="rounded-lg border border-neutral-800 bg-neutral-900/60 p-8 text-center"><p class="text-neutral-400">‚ú® Queue is empty!</p></div>';
          return;
        }

        container.innerHTML = enriched
          .map((item) => {
            const payload = item.payload;
            const summary = payload.summary || {};
            const personaScores = payload.persona_scores || {};
            const industryCodes = payload.industry_codes || [];
            const topicCodes = payload.topic_codes || [];
            const vendorNames = payload.vendor_names || [];
            const organizationNames = payload.organization_names || [];

            // Check which entities are new vs existing
            const vendorStatus = vendorNames.map((name) => ({
              name,
              isNew: !existingVendors.has(name.toLowerCase()),
            }));
            const orgStatus = organizationNames.map((name) => ({
              name,
              isNew: !existingOrgs.has(name.toLowerCase()),
            }));

            // Validate summary lengths
            const shortLen = summary.short?.length || 0;
            const mediumLen = summary.medium?.length || 0;
            const longLen = summary.long?.length || 0;

            const shortValid = shortLen >= 120 && shortLen <= 150;
            const mediumValid = mediumLen >= 250 && mediumLen <= 300;
            const longValid = longLen >= 500 && longLen <= 600;

            // Resolve Thumbnail URL
            // Priority: 1. Payload full URL (new agent), 2. Payload path (new agent), 3. Legacy local path
            let thumbnailUrl = null;
            if (payload.thumbnail) {
              thumbnailUrl = payload.thumbnail;
            } else if (payload.thumbnail_path && payload.thumbnail_bucket) {
              // Fallback construction if full URL missing
              thumbnailUrl = `${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/${payload.thumbnail_bucket}/${payload.thumbnail_path}`;
            } else if (item.thumbnail) {
              // Legacy/Manual column
              thumbnailUrl = item.thumbnail.startsWith('http')
                ? item.thumbnail
                : `/thumbs/${item.thumbnail}`;
            }

            // Prepare role from persona scores (highest scoring persona)
            const topPersona = Object.entries(personaScores).sort(
              ([, a], [, b]) => Number(b) - Number(a),
            )[0];
            const role = topPersona ? topPersona[0] : '';

            return `
            <li class="group rounded-xl border border-neutral-800 bg-neutral-900/60 transition hover:border-neutral-700" 
              data-item-id="${item.id}"
              data-role="${role}"
              data-industry="${industryCodes.length > 0 ? industryMap.get(industryCodes[0]) || industryCodes[0] : ''}"
              data-topic="${topicCodes.length > 0 ? topicMap.get(topicCodes[0]) || topicCodes[0] : ''}"
              data-content_type=""
              data-geography=""
              data-slug=""
              data-url="${item.url}"
              data-summary-medium="${(summary.medium || '').replace(/"/g, '&quot;')}"
              data-authors=""
              data-source_name="">
              <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="sr-only">${payload.title}</a>
              <div class="flex gap-6 p-6">
                <!-- Thumbnail -->
                ${
                  thumbnailUrl
                    ? `
                <div class="flex-shrink-0">
                  <img src="${thumbnailUrl}" alt="Thumbnail" class="w-48 h-32 object-cover rounded-lg border border-neutral-700" loading="lazy" />
                </div>
                `
                    : ''
                }
                
                <!-- Main Content -->
                <div class="flex-1 min-w-0">
                  <!-- Header -->
                  <div class="flex items-start justify-between gap-4">
                    <div class="flex-1">
                      <h2 class="text-2xl font-semibold text-sky-200 break-words">${payload.title}</h2>
                      <div class="mt-2 flex flex-wrap gap-2 text-sm text-neutral-400">
                        <span>üìÖ ${new Date(payload.published_at).toLocaleDateString()}</span>
                        <span>‚Ä¢</span>
                        <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="text-sky-400 hover:text-sky-300 hover:underline">View original ‚Üí</a>
                      </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex flex-col gap-2 flex-shrink-0">
                      <button class="preview-btn inline-flex items-center justify-center gap-1 rounded-lg border border-neutral-600 bg-neutral-800 px-6 py-2 font-medium text-neutral-300 hover:bg-neutral-700 transition whitespace-nowrap" type="button" data-open-modal="true">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        Preview
                      </button>
                      <button class="approve-btn rounded-lg bg-emerald-600 px-6 py-2 font-semibold text-white hover:bg-emerald-500 transition whitespace-nowrap" data-id="${item.id}">‚úì Approve</button>
                      <button class="reject-btn rounded-lg bg-red-600 px-6 py-2 font-semibold text-white hover:bg-red-500 transition whitespace-nowrap" data-id="${item.id}">‚úó Reject</button>
                    </div>
                  </div>

                  <!-- Summaries -->
                  <div class="mt-4 space-y-3">
                    <div>
                      <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs font-semibold text-neutral-400 uppercase">Short Summary</span>
                        <span class="text-xs ${shortValid ? 'text-emerald-400' : 'text-amber-400'}">
                          ${shortValid ? '‚úì' : '‚ö†Ô∏è'} ${shortLen} chars
                        </span>
                      </div>
                      <p class="text-neutral-300">${summary.short || 'N/A'}</p>
                    </div>
                    
                    <details class="group">
                      <summary class="cursor-pointer text-sm font-medium text-neutral-400 hover:text-neutral-300 list-none flex items-center gap-2">
                        <span class="transform transition-transform group-open:rotate-90">‚ñ∂</span>
                        Medium Summary
                        <span class="text-xs ${mediumValid ? 'text-emerald-400' : 'text-amber-400'}">
                          ${mediumValid ? '‚úì' : '‚ö†Ô∏è'} ${mediumLen} chars
                        </span>
                      </summary>
                      <p class="mt-2 text-neutral-300 text-sm">${summary.medium || 'N/A'}</p>
                    </details>
                    
                    <details class="group">
                      <summary class="cursor-pointer text-sm font-medium text-neutral-400 hover:text-neutral-300 list-none flex items-center gap-2">
                        <span class="transform transition-transform group-open:rotate-90">‚ñ∂</span>
                        Long Summary
                        <span class="text-xs ${longValid ? 'text-emerald-400' : 'text-amber-400'}">
                          ${longValid ? '‚úì' : '‚ö†Ô∏è'} ${longLen} chars
                        </span>
                      </summary>
                      <p class="mt-2 text-neutral-300 text-sm">${summary.long || 'N/A'}</p>
                    </details>
                  </div>

                  <!-- Tags -->
                  <div class="mt-4 space-y-2">
                    ${
                      industryCodes.length > 0
                        ? `
                    <div>
                      <span class="text-xs font-semibold text-neutral-400 uppercase">Industries</span>
                      <div class="flex flex-wrap gap-2 mt-1">
                        ${industryCodes
                          .map((code) => {
                            const name = industryMap.get(code) || code;
                            return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-blue-500/10 border border-blue-500/20 text-xs text-blue-300">
                            <span class="font-mono text-blue-400">${code}</span>
                            <span class="text-blue-200">${name}</span>
                          </span>`;
                          })
                          .join('')}
                      </div>
                    </div>
                    `
                        : ''
                    }
                    
                    ${
                      topicCodes.length > 0
                        ? `
                    <div>
                      <span class="text-xs font-semibold text-neutral-400 uppercase">Topics</span>
                      <div class="flex flex-wrap gap-2 mt-1">
                        ${topicCodes
                          .map((code) => {
                            const name = topicMap.get(code) || code;
                            return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-purple-500/10 border border-purple-500/20 text-xs text-purple-300">
                            <span class="font-mono text-purple-400">${code}</span>
                            <span class="text-purple-200">${name}</span>
                          </span>`;
                          })
                          .join('')}
                      </div>
                    </div>
                    `
                        : ''
                    }
                  </div>

                  <!-- Entity Curation (Vendors & Organizations) -->
                  ${
                    vendorStatus.length > 0 || orgStatus.length > 0
                      ? `
                  <div class="mt-4 p-4 rounded-lg border border-amber-500/20 bg-amber-500/5">
                    <div class="flex items-center gap-2 mb-3">
                      <span class="text-xs font-semibold text-amber-300 uppercase">üè∑Ô∏è Taxonomy Curation</span>
                      <span class="text-xs text-neutral-400">(Select entities to add to database)</span>
                    </div>
                    
                    ${
                      vendorStatus.length > 0
                        ? `
                    <div class="mb-3">
                      <span class="text-xs font-medium text-neutral-400">AI/Tech Vendors</span>
                      <div class="flex flex-wrap gap-2 mt-1">
                        ${vendorStatus
                          .map(
                            (v) => `
                          <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md cursor-pointer transition
                            ${v.isNew ? 'bg-emerald-500/10 border border-emerald-500/30 hover:bg-emerald-500/20' : 'bg-neutral-800 border border-neutral-700'}">
                            <input type="checkbox" 
                              class="vendor-checkbox rounded border-neutral-600 bg-neutral-800 text-emerald-500 focus:ring-emerald-500/30"
                              data-item-id="${item.id}"
                              data-entity-type="vendor"
                              data-entity-name="${v.name}"
                              ${v.isNew ? 'checked' : ''}
                            />
                            <span class="text-sm ${v.isNew ? 'text-emerald-300' : 'text-neutral-400'}">${v.name}</span>
                            ${v.isNew ? '<span class="text-xs px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-400">NEW</span>' : '<span class="text-xs text-neutral-500">exists</span>'}
                          </label>
                        `,
                          )
                          .join('')}
                      </div>
                    </div>
                    `
                        : ''
                    }
                    
                    ${
                      orgStatus.length > 0
                        ? `
                    <div>
                      <span class="text-xs font-medium text-neutral-400">BFSI Organizations</span>
                      <div class="flex flex-wrap gap-2 mt-1">
                        ${orgStatus
                          .map(
                            (o) => `
                          <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md cursor-pointer transition
                            ${o.isNew ? 'bg-sky-500/10 border border-sky-500/30 hover:bg-sky-500/20' : 'bg-neutral-800 border border-neutral-700'}">
                            <input type="checkbox"
                              class="org-checkbox rounded border-neutral-600 bg-neutral-800 text-sky-500 focus:ring-sky-500/30"
                              data-item-id="${item.id}"
                              data-entity-type="organization"
                              data-entity-name="${o.name}"
                              ${o.isNew ? 'checked' : ''}
                            />
                            <span class="text-sm ${o.isNew ? 'text-sky-300' : 'text-neutral-400'}">${o.name}</span>
                            ${o.isNew ? '<span class="text-xs px-1.5 py-0.5 rounded bg-sky-500/20 text-sky-400">NEW</span>' : '<span class="text-xs text-neutral-500">exists</span>'}
                          </label>
                        `,
                          )
                          .join('')}
                      </div>
                    </div>
                    `
                        : ''
                    }
                  </div>
                  `
                      : ''
                  }

                  <!-- Persona Scores -->
                  ${
                    Object.keys(personaScores).length > 0
                      ? `
                  <div class="mt-4">
                    <span class="text-xs font-semibold text-neutral-400 uppercase">Persona Relevance</span>
                    <div class="flex gap-4 mt-2">
                      ${Object.entries(personaScores)
                        .map(
                          ([persona, score]) => `
                        <div class="flex items-center gap-2">
                          <span class="text-sm text-neutral-400 capitalize">${persona}:</span>
                          <div class="flex items-center gap-1">
                            <div class="w-24 h-2 bg-neutral-800 rounded-full overflow-hidden">
                              <div class="h-full bg-gradient-to-r from-sky-500 to-emerald-500 rounded-full" style="width: ${(score * 100).toFixed(0)}%"></div>
                            </div>
                            <span class="text-sm font-medium text-neutral-300">${(score * 100).toFixed(0)}%</span>
                          </div>
                        </div>
                      `,
                        )
                        .join('')}
                    </div>
                  </div>
                  `
                      : ''
                  }

                  <!-- Quality Indicators -->
                  <div class="mt-4 flex items-center gap-4 text-xs">
                    ${
                      payload.relevance_confidence
                        ? `
                    <div class="flex items-center gap-1">
                      <span class="text-neutral-400">AI Confidence:</span>
                      <span class="font-medium text-emerald-300">${(payload.relevance_confidence * 100).toFixed(0)}%</span>
                    </div>
                    `
                        : ''
                    }
                    <div class="flex items-center gap-1">
                      <span class="text-neutral-400">Tags:</span>
                      <span class="font-medium ${industryCodes.length + topicCodes.length >= 2 ? 'text-emerald-300' : 'text-amber-300'}">
                        ${industryCodes.length + topicCodes.length >= 2 ? '‚úì' : '‚ö†Ô∏è'} ${industryCodes.length + topicCodes.length} total
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </li>
          `;
          })
          .join('');

        // Handle approve/reject buttons
        container.addEventListener('click', async (e) => {
          const target = e.target;
          if (!(target instanceof HTMLElement)) return;

          // Approve - auto-publishes to kb_publication
          if (target.classList.contains('approve-btn')) {
            const id = target.dataset.id;
            if (!id) return;

            const article = document.querySelector('[data-item-id="' + id + '"]');
            if (!(article instanceof HTMLElement)) return;

            article.classList.add('opacity-60');
            target.textContent = '‚è≥ Publishing...';

            // Collect selected entities for taxonomy curation
            const selectedVendors = [];
            const selectedOrgs = [];

            article.querySelectorAll('.vendor-checkbox:checked').forEach((cb) => {
              if (cb instanceof HTMLInputElement && cb.dataset.entityName) {
                selectedVendors.push(cb.dataset.entityName);
              }
            });

            article.querySelectorAll('.org-checkbox:checked').forEach((cb) => {
              if (cb instanceof HTMLInputElement && cb.dataset.entityName) {
                selectedOrgs.push(cb.dataset.entityName);
              }
            });

            // Call SQL function which:
            // 1. Inserts into kb_publication
            // 2. Creates taxonomy relationships
            // 3. Upserts approved vendors and organizations
            // 4. Marks as approved
            const { error } = await supabase.rpc('approve_from_queue', {
              p_queue_id: id,
              p_approved_vendors: selectedVendors,
              p_approved_organizations: selectedOrgs,
            });

            if (error) {
              article.classList.remove('opacity-60');
              target.textContent = '‚úì Approve';
              alert('Publication failed: ' + error.message);
              return;
            }

            // Show count of entities added
            const entityMsg = [];
            if (selectedVendors.length > 0) entityMsg.push(`${selectedVendors.length} vendors`);
            if (selectedOrgs.length > 0) entityMsg.push(`${selectedOrgs.length} orgs`);
            const entityNote = entityMsg.length > 0 ? ` (+${entityMsg.join(', ')})` : '';

            article.classList.add('opacity-50');
            target.textContent = `‚úì Published!${entityNote}`;
            target.setAttribute('disabled', 'true');
            setTimeout(() => article.remove(), 2000);
          }

          // Reject
          if (target.classList.contains('reject-btn')) {
            const id = target.dataset.id;
            if (!id) return;

            const reason = window.prompt('Reason for rejection (optional):');
            if (reason === null) return;

            const article = document.querySelector('[data-item-id="' + id + '"]');
            if (!(article instanceof HTMLElement)) return;

            // Get current user for audit trail
            const session = (await supabase.auth.getSession()).data.session;
            const userId = session?.user?.id;

            // Update status directly
            const { error } = await supabase
              .from('ingestion_queue')
              .update({
                status: 'rejected',
                rejection_reason: reason || null,
                reviewed_at: new Date().toISOString(),
                reviewer: userId,
              })
              .eq('id', id)
              .eq('status', 'enriched');

            if (error) {
              alert('Rejection failed: ' + error.message);
              return;
            }

            article.classList.add('opacity-50');
            target.textContent = '‚úó Rejected';
            target.setAttribute('disabled', 'true');
            setTimeout(() => article.remove(), 1000);
          }
        });
      } catch (err) {
        if (loading) loading.classList.add('hidden');
        if (errorBox) {
          errorBox.classList.remove('hidden');
          const p = errorBox.querySelector('p');
          const msg = err instanceof Error ? err.message : 'Failed to load queue';
          if (p) p.textContent = msg;
        }
      }
    }

    loadQueue();
  </script>
</Base>
