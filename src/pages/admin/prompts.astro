---
// Static page with client-side database interactions
export const prerender = true;

import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="Prompts" activeSection="prompts">
  <!-- Page Header -->
  <header class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold">Prompt Management</h1>
      <p class="mt-1 text-sm text-neutral-500 dark:text-neutral-400">
        Configure and version AI agent prompts
      </p>
    </div>
    <button
      id="add-prompt-btn"
      class="rounded-lg bg-sky-600 px-4 py-2 text-sm font-medium text-white hover:bg-sky-500 self-start sm:self-auto"
      type="button">+ New Version</button
    >
  </header>

  <div id="stats" class="mb-6 flex gap-4 text-sm"></div>

  <div class="mb-6">
    <select
      id="filter-agent"
      class="rounded-lg border border-neutral-700 bg-neutral-800 px-3 py-2 text-sm text-neutral-300"
    >
      <option value="">All Agents</option>
    </select>
  </div>

  <div id="loading" class="rounded-xl border border-neutral-800 bg-neutral-900/60 p-12 text-center">
    <div class="text-4xl mb-3">⏳</div>
    <p class="text-neutral-400">Loading prompts...</p>
  </div>

  <div id="error" class="hidden rounded-xl border border-red-500/20 bg-red-500/5 p-8 text-center">
    <p class="text-red-300"></p>
  </div>

  <div id="prompts-container" class="hidden space-y-4"></div>

  <div
    id="prompt-modal"
    class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 p-4"
  >
    <div
      class="w-full max-w-4xl rounded-xl border border-neutral-700 bg-neutral-900 p-6 max-h-[90vh] overflow-y-auto"
    >
      <div class="flex items-center justify-between mb-6">
        <h2 id="modal-title" class="text-xl font-semibold">New Prompt Version</h2>
        <button id="close-modal" class="text-neutral-400 hover:text-white text-2xl">&times;</button>
      </div>

      <form id="prompt-form" class="space-y-4">
        <input type="hidden" id="edit-id" />
        <input type="hidden" id="view-only" />

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-neutral-300 mb-1">Agent *</label>
            <select
              id="prompt-agent"
              required
              class="w-full rounded-lg border border-neutral-700 bg-neutral-800 px-3 py-2 text-white"
            >
              <option value="relevance-filter">Relevance Filter</option>
              <option value="content-summarizer">Content Summarizer</option>
              <option value="taxonomy-tagger">Taxonomy Tagger</option>
              <option value="discovery-filter">Discovery Filter</option>
              <option value="discovery-relevance">Discovery Relevance</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-neutral-300 mb-1">Version *</label>
            <input
              type="text"
              id="prompt-version"
              required
              class="w-full rounded-lg border border-neutral-700 bg-neutral-800 px-3 py-2 text-white"
              placeholder="v2.0"
            />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-neutral-300 mb-1">Model</label>
            <select
              id="prompt-model"
              class="w-full rounded-lg border border-neutral-700 bg-neutral-800 px-3 py-2 text-white"
            >
              <option value="gpt-4o-mini">GPT-4o-mini</option>
              <option value="gpt-4o">GPT-4o</option>
              <option value="gpt-4-turbo">GPT-4-turbo</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-neutral-300 mb-1">Stage</label>
            <select
              id="prompt-stage"
              class="w-full rounded-lg border border-neutral-700 bg-neutral-800 px-3 py-2 text-white"
            >
              <option value="discovery">Discovery</option>
              <option value="enrichment">Enrichment</option>
              <option value="evaluation">Evaluation</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-neutral-300 mb-1">Prompt Text *</label>
          <textarea
            id="prompt-text"
            required
            rows="12"
            class="w-full rounded-lg border border-neutral-700 bg-neutral-800 px-3 py-2 text-white font-mono text-sm"
            placeholder="You are an expert..."></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-neutral-300 mb-1">Notes</label>
          <input
            type="text"
            id="prompt-notes"
            class="w-full rounded-lg border border-neutral-700 bg-neutral-800 px-3 py-2 text-white"
            placeholder="Changes in this version..."
          />
        </div>

        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" id="prompt-current" class="rounded border-neutral-600" />
          <span class="text-sm text-neutral-300">Set as current version</span>
        </label>

        <div class="flex gap-3 pt-4">
          <button
            type="submit"
            id="submit-btn"
            class="rounded-lg bg-sky-600 px-6 py-2 font-medium text-white hover:bg-sky-500"
            >Save Prompt</button
          >
          <button
            type="button"
            id="cancel-btn"
            class="rounded-lg border border-neutral-700 px-6 py-2 font-medium text-neutral-300 hover:bg-neutral-800"
            >Cancel</button
          >
        </div>
      </form>
    </div>
  </div>
  <script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
    );

    interface Prompt {
      id: number;
      agent_name: string;
      version: string;
      prompt_text: string;
      model_id: string | null;
      stage: string | null;
      is_current: boolean;
      created_at: string;
      notes: string | null;
    }

    let prompts: Prompt[] = [];
    const $ = (id: string) => document.getElementById(id);

    async function init(): Promise<void> {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) {
        globalThis.location.href = '/admin/login';
        return;
      }
      loadPrompts();
      bindEvents();
    }

    async function loadPrompts(): Promise<void> {
      const { data, error } = await supabase
        .from('prompt_versions')
        .select('*')
        .order('agent_name')
        .order('created_at', { ascending: false });

      if (error) {
        $('loading')!.classList.add('hidden');
        $('error')!.classList.remove('hidden');
        $('error')!.querySelector('p')!.textContent = error.message;
        return;
      }
      prompts = data || [];
      populateAgentFilter();
      renderPrompts();
      renderStats();
    }

    function populateAgentFilter(): void {
      const agents = [...new Set(prompts.map((p) => p.agent_name))];
      const filter = $('filter-agent') as HTMLSelectElement;
      filter.innerHTML =
        '<option value="">All Agents</option>' +
        agents.map((a) => `<option value="${a}">${a}</option>`).join('');
    }

    function renderStats(): void {
      const total = prompts.length;
      const agents = new Set(prompts.map((p) => p.agent_name)).size;
      const current = prompts.filter((p) => p.is_current).length;
      $('stats')!.innerHTML = `
        <span class="rounded-full bg-neutral-800 px-3 py-1">${total} versions</span>
        <span class="rounded-full bg-purple-500/20 text-purple-300 px-3 py-1">${agents} agents</span>
        <span class="rounded-full bg-emerald-500/20 text-emerald-300 px-3 py-1">${current} active</span>
      `;
    }

    function renderPrompts(): void {
      $('loading')!.classList.add('hidden');
      $('prompts-container')!.classList.remove('hidden');

      const filterVal = ($('filter-agent') as HTMLSelectElement).value;
      const filtered = filterVal ? prompts.filter((p) => p.agent_name === filterVal) : prompts;

      const grouped = filtered.reduce(
        (acc, p) => {
          if (!acc[p.agent_name]) acc[p.agent_name] = [];
          acc[p.agent_name].push(p);
          return acc;
        },
        {} as Record<string, Prompt[]>,
      );

      $('prompts-container')!.innerHTML = Object.entries(grouped)
        .map(
          ([agent, versions]) => `
        <div class="rounded-xl border border-neutral-800 bg-neutral-900/60 overflow-hidden">
          <div class="px-4 py-3 bg-neutral-800/50 border-b border-neutral-800 flex items-center justify-between">
            <h3 class="font-semibold text-white">${agent}</h3>
            <span class="text-xs text-neutral-400">${versions.length} version${versions.length > 1 ? 's' : ''}</span>
          </div>
          <div class="divide-y divide-neutral-800">
            ${versions.map((p) => renderPromptRow(p)).join('')}
          </div>
        </div>
      `,
        )
        .join('');

      document.querySelectorAll('.set-current-btn').forEach((btn) => {
        btn.addEventListener('click', handleSetCurrent);
      });
      document.querySelectorAll('.view-btn').forEach((btn) => {
        btn.addEventListener('click', handleView);
      });
      document.querySelectorAll('.edit-btn').forEach((btn) => {
        btn.addEventListener('click', handleEdit);
      });
    }

    function renderPromptRow(p: Prompt): string {
      return `
        <div class="px-4 py-3 hover:bg-neutral-800/30">
          <div class="flex items-center justify-between mb-1">
            <div class="flex items-center gap-3">
              <span class="font-mono text-sm text-sky-400">${p.version}</span>
              ${p.is_current ? '<span class="rounded-full bg-emerald-500/20 text-emerald-300 px-2 py-0.5 text-xs">Current</span>' : ''}
              ${p.model_id ? `<span class="text-xs text-neutral-500">${p.model_id}</span>` : ''}
            </div>
            <div class="flex items-center gap-2">
              ${!p.is_current ? `<button type="button" class="set-current-btn text-emerald-400 hover:text-emerald-300 text-xs cursor-pointer" data-id="${p.id}">Set Current</button>` : ''}
              <button type="button" class="view-btn text-sky-400 hover:text-sky-300 text-xs cursor-pointer" data-id="${p.id}">View</button>
              <button type="button" class="edit-btn text-amber-400 hover:text-amber-300 text-xs cursor-pointer" data-id="${p.id}">Edit</button>
            </div>
          </div>
          <div class="text-xs text-neutral-500">${new Date(p.created_at).toLocaleDateString()} ${p.notes ? `• ${p.notes}` : ''}</div>
        </div>
      `;
    }

    async function handleSetCurrent(e: Event): Promise<void> {
      const id = Number.parseInt((e.currentTarget as HTMLButtonElement).dataset.id!, 10);
      const prompt = prompts.find((p) => p.id === id);
      if (!prompt) return;

      await supabase
        .from('prompt_versions')
        .update({ is_current: false })
        .eq('agent_name', prompt.agent_name);
      await supabase.from('prompt_versions').update({ is_current: true }).eq('id', id);
      loadPrompts();
    }

    function handleView(e: Event): void {
      const id = Number.parseInt((e.currentTarget as HTMLButtonElement).dataset.id!, 10);
      const p = prompts.find((pr) => pr.id === id);
      if (!p) return;
      openModal(p, true);
    }

    function handleEdit(e: Event): void {
      const id = Number.parseInt((e.currentTarget as HTMLButtonElement).dataset.id!, 10);
      const p = prompts.find((pr) => pr.id === id);
      if (!p) return;
      openModal(p, false);
    }

    function openModal(p: Prompt | null, viewOnly: boolean): void {
      ($('modal-title') as HTMLElement).textContent = p
        ? viewOnly
          ? `${p.agent_name} - ${p.version}`
          : 'Edit Prompt'
        : 'New Prompt Version';
      ($('edit-id') as HTMLInputElement).value = p ? String(p.id) : '';
      ($('view-only') as HTMLInputElement).value = viewOnly ? '1' : '';
      ($('prompt-agent') as HTMLSelectElement).value = p?.agent_name || 'relevance-filter';
      ($('prompt-agent') as HTMLSelectElement).disabled = !!p;
      ($('prompt-version') as HTMLInputElement).value = p?.version || '';
      ($('prompt-version') as HTMLInputElement).disabled = !!p;
      ($('prompt-model') as HTMLSelectElement).value = p?.model_id || 'gpt-4o-mini';
      ($('prompt-model') as HTMLSelectElement).disabled = viewOnly;
      ($('prompt-stage') as HTMLSelectElement).value = p?.stage || 'enrichment';
      ($('prompt-stage') as HTMLSelectElement).disabled = viewOnly;
      ($('prompt-text') as HTMLTextAreaElement).value = p?.prompt_text || '';
      ($('prompt-text') as HTMLTextAreaElement).disabled = viewOnly;
      ($('prompt-notes') as HTMLInputElement).value = p?.notes || '';
      ($('prompt-notes') as HTMLInputElement).disabled = viewOnly;
      ($('prompt-current') as HTMLInputElement).checked = p?.is_current || false;
      ($('prompt-current') as HTMLInputElement).disabled = viewOnly;
      ($('submit-btn') as HTMLButtonElement).classList.toggle('hidden', viewOnly);
      $('prompt-modal')!.classList.remove('hidden');
      $('prompt-modal')!.classList.add('flex');
    }

    function closeModal(): void {
      $('prompt-modal')!.classList.add('hidden');
      $('prompt-modal')!.classList.remove('flex');
      document
        .querySelectorAll('#prompt-form input, #prompt-form select, #prompt-form textarea')
        .forEach((el) => {
          (el as HTMLInputElement).disabled = false;
        });
    }

    async function handleSubmit(e: Event): Promise<void> {
      e.preventDefault();
      if (($('view-only') as HTMLInputElement).value === '1') return;

      const editId = ($('edit-id') as HTMLInputElement).value;
      const agentName = ($('prompt-agent') as HTMLSelectElement).value;
      const isCurrent = ($('prompt-current') as HTMLInputElement).checked;

      const data = {
        agent_name: agentName,
        version: ($('prompt-version') as HTMLInputElement).value,
        model_id: ($('prompt-model') as HTMLSelectElement).value,
        stage: ($('prompt-stage') as HTMLSelectElement).value,
        prompt_text: ($('prompt-text') as HTMLTextAreaElement).value,
        notes: ($('prompt-notes') as HTMLInputElement).value || null,
        is_current: isCurrent,
      };

      if (isCurrent) {
        await supabase
          .from('prompt_versions')
          .update({ is_current: false })
          .eq('agent_name', agentName);
      }

      const { error } = editId
        ? await supabase.from('prompt_versions').update(data).eq('id', Number.parseInt(editId, 10))
        : await supabase.from('prompt_versions').insert(data);

      if (error) {
        alert('Failed to save: ' + error.message);
      } else {
        closeModal();
        loadPrompts();
      }
    }

    function bindEvents(): void {
      $('add-prompt-btn')?.addEventListener('click', () => openModal(null, false));
      $('close-modal')?.addEventListener('click', closeModal);
      $('cancel-btn')?.addEventListener('click', closeModal);
      $('prompt-modal')?.addEventListener('click', (e) => {
        if (e.target === $('prompt-modal')) closeModal();
      });
      ($('prompt-form') as HTMLFormElement)?.addEventListener('submit', handleSubmit);
      $('filter-agent')?.addEventListener('change', renderPrompts);
    }

    init();
  </script>
</AdminLayout>
