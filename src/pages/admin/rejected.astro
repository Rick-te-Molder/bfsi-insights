---
export const prerender = false;

import Base from '../../layouts/Base.astro';
---

<Base title="Rejected Items">
  <div class="mx-auto max-w-7xl px-4 py-8">
    <header class="mb-8">
      <h1 class="text-4xl font-bold">üóëÔ∏è Rejected Items</h1>
      <p class="mt-2 text-neutral-300">Review and restore previously rejected publications</p>
      <div id="stats" class="mt-4 flex gap-4 text-sm">
        <a
          href="/admin/review"
          class="rounded-full bg-sky-500/10 px-3 py-1 text-sky-300 hover:bg-sky-500/20"
        >
          ‚Üê Back to review queue
        </a>
      </div>
    </header>

    <div
      id="loading"
      class="rounded-lg border border-neutral-800 bg-neutral-900/60 p-8 text-center"
    >
      <p class="text-neutral-400">‚è≥ Loading...</p>
    </div>

    <div id="error" class="hidden rounded-lg border border-red-500/20 bg-red-500/5 p-8 text-center">
      <p class="text-red-300"></p>
    </div>

    <div id="items-container" class="space-y-6"></div>
  </div>

  <script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
    );

    async function loadRejected() {
      const loading = document.getElementById('loading');
      const errorBox = document.getElementById('error');
      const statsDiv = document.getElementById('stats');
      const container = document.getElementById('items-container');

      if (!loading || !errorBox || !statsDiv || !container) return;

      try {
        // Auth check
        const sessionRes = await supabase.auth.getSession();
        const session = sessionRes && sessionRes.data && sessionRes.data.session;

        if (!session) {
          window.location.href = '/login';
          return;
        }

        // Load rejected items
        const result = await supabase
          .from('ingestion_queue')
          .select('*')
          .eq('status', 'rejected')
          .order('reviewed_at', { ascending: false });

        if (result.error) throw result.error;

        const rejected = result.data || [];
        loading.classList.add('hidden');

        // Count in header
        statsDiv.innerHTML += `
          <span class="rounded-full bg-red-500/10 px-3 py-1 text-red-300">
            ${rejected.length} rejected items
          </span>
        `;

        if (rejected.length === 0) {
          container.innerHTML = `
            <div class="rounded-lg border border-neutral-800 bg-neutral-900/60 p-8 text-center">
              <p class="text-neutral-400">‚ú® No rejected items!</p>
            </div>
          `;
          return;
        }

        // Render
        container.innerHTML = rejected
          .map(
            (item) => `
            <article class="rounded-xl border border-red-800/40 bg-neutral-900/60 p-6 transition hover:border-red-700/60" data-item-id="${item.id}">
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                  <h2 class="text-2xl font-semibold text-neutral-200">${item.payload.title}</h2>
                  <div class="mt-2 flex flex-wrap gap-2 text-sm text-neutral-400">
                    <span>üîó ${item.payload.source}</span>
                    <span>üìÖ ${new Date(item.payload.published_at).toLocaleDateString()}</span>
                    <span class="text-red-400">‚úñ Rejected: ${new Date(item.reviewed_at).toLocaleDateString()}</span>
                  </div>
                  ${
                    item.rejection_reason
                      ? `<div class="mt-3 rounded-lg bg-red-500/10 border border-red-500/20 px-4 py-2">
                           <p class="text-sm font-medium text-red-300">Rejection reason:</p>
                           <p class="text-sm text-red-200">${item.rejection_reason}</p>
                         </div>`
                      : ''
                  }
                  <a href="${item.url}" target="_blank" rel="noopener noreferrer"
                     class="mt-4 inline-block text-sm text-sky-400 hover:text-sky-300">
                     View original ‚Üí
                  </a>
                </div>
                <div class="flex flex-col gap-2">
                  <button class="restore-btn rounded-lg bg-emerald-600 px-6 py-2 font-semibold text-white hover:bg-emerald-500 transition" data-id="${item.id}">
                    ‚Ü∫ Restore
                  </button>
                </div>
              </div>
            </article>
          `,
          )
          .join('');

        // Restore handler
        container.addEventListener('click', async (e) => {
          const target = e.target;
          if (!(target instanceof HTMLElement)) return;
          if (!target.classList.contains('restore-btn')) return;

          const id = target.dataset.id;
          if (!id) return;

          const note = window.prompt('Optional note for restoration (why you changed your mind):');
          if (note === null) return;

          const article = document.querySelector(`[data-item-id="${id}"]`);
          if (!(article instanceof HTMLElement)) return;

          try {
            const rpcResult = await supabase.rpc('restore_from_rejection', {
              p_queue_id: id,
              p_note: note || null,
            });

            if (rpcResult.error) {
              window.alert('Error: ' + rpcResult.error.message);
              return;
            }

            article.classList.add('opacity-50');
            target.textContent = '‚úì Restored!';
            target.disabled = true;

            setTimeout(() => {
              article.remove();
              if (!document.querySelector('[data-item-id]')) {
                window.location.reload();
              }
            }, 1000);
          } catch (err) {
            const msg = err instanceof Error ? err.message : 'Unknown error';
            window.alert('Failed to restore: ' + msg);
          }
        });
      } catch (err) {
        loading.classList.add('hidden');
        errorBox.classList.remove('hidden');
        const p = errorBox.querySelector('p');
        const msg = err instanceof Error ? err.message : 'Failed to load rejected items';
        if (p) p.textContent = msg;
      }
    }

    loadRejected();
  </script>
</Base>
