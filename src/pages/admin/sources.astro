---
// Static page with client-side database interactions
export const prerender = true;

import AdminLayout from '../../layouts/AdminLayout.astro';
import SourceFormModal from '../../components/admin/SourceFormModal.astro';
---

<AdminLayout title="Sources" activeSection="sources">
  <!-- Page Header -->
  <header class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold">Source Management</h1>
      <p class="mt-1 text-sm text-neutral-500 dark:text-neutral-400">
        Configure discovery sources and priorities
      </p>
    </div>
    <button
      id="add-source-btn"
      class="rounded-lg bg-sky-600 px-4 py-2 text-sm font-medium text-white hover:bg-sky-500 transition-colors self-start sm:self-auto"
      type="button"
    >
      + Add Source
    </button>
  </header>

  <!-- Stats -->
  <div id="stats" class="mb-6 flex flex-wrap gap-3 text-sm"></div>

  <!-- Display Panel (Linear-style) -->
  <div
    class="mb-6 rounded-lg border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900/60 p-4"
  >
    <div class="flex items-center gap-2 mb-4">
      <svg class="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
        ></path>
      </svg>
      <span class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Display</span>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Grouping -->
      <div>
        <label class="block text-xs text-neutral-500 dark:text-neutral-400 mb-1.5">Grouping</label>
        <select
          id="grouping"
          class="w-full rounded-md border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 px-3 py-1.5 text-sm text-neutral-900 dark:text-neutral-200"
        >
          <option value="">No grouping</option>
          <option value="category">Category</option>
          <option value="tier">Tier</option>
        </select>
      </div>

      <!-- Ordering -->
      <div>
        <label class="block text-xs text-neutral-500 dark:text-neutral-400 mb-1.5">Ordering</label>
        <div class="flex gap-1">
          <select
            id="ordering"
            class="flex-1 rounded-md border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 px-3 py-1.5 text-sm text-neutral-900 dark:text-neutral-200"
          >
            <option value="sort_order">Priority</option>
            <option value="name">Name</option>
            <option value="category">Category</option>
            <option value="tier">Tier</option>
            <option value="enabled">Enabled</option>
            <option value="created_at">Created</option>
            <option value="updated_at">Updated</option>
          </select>
          <button
            id="order-direction"
            type="button"
            class="px-2 rounded-md border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 text-neutral-600 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-700"
            title="Toggle sort direction"
            data-direction="asc"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Filter: Category -->
      <div>
        <label class="block text-xs text-neutral-500 dark:text-neutral-400 mb-1.5">Category</label>
        <select
          id="filter-category"
          class="w-full rounded-md border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 px-3 py-1.5 text-sm text-neutral-900 dark:text-neutral-200"
        >
          <option value="">All Categories</option>
          <option value="strategy-consulting">Strategy Consulting</option>
          <option value="big4">Big 4</option>
          <option value="vendor">Vendors</option>
          <option value="research">Research</option>
          <option value="regulator">Regulators</option>
          <option value="publication">Publication</option>
        </select>
      </div>

      <!-- Filter: Tier & Enabled -->
      <div class="flex gap-2">
        <div class="flex-1">
          <label class="block text-xs text-neutral-500 dark:text-neutral-400 mb-1.5">Tier</label>
          <select
            id="filter-tier"
            class="w-full rounded-md border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 px-3 py-1.5 text-sm text-neutral-900 dark:text-neutral-200"
          >
            <option value="">All</option>
            <option value="standard">Standard</option>
            <option value="premium">Premium</option>
          </select>
        </div>
        <div class="flex-1">
          <label class="block text-xs text-neutral-500 dark:text-neutral-400 mb-1.5">Enabled</label>
          <select
            id="filter-enabled"
            class="w-full rounded-md border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 px-3 py-1.5 text-sm text-neutral-900 dark:text-neutral-200"
          >
            <option value="">All</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loading" class="rounded-xl border border-neutral-800 bg-neutral-900/60 p-12 text-center">
    <div class="text-4xl mb-3">‚è≥</div>
    <p class="text-neutral-400">Loading sources...</p>
  </div>

  <!-- Error State -->
  <div id="error" class="hidden rounded-xl border border-red-500/20 bg-red-500/5 p-8 text-center">
    <p class="text-red-300"></p>
  </div>

  <!-- Sources Table -->
  <div id="sources-table" class="hidden overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-neutral-700 text-left text-neutral-400">
          <th class="pb-3 pr-4 font-medium">Priority</th>
          <th class="pb-3 pr-4 font-medium">Name</th>
          <th class="pb-3 pr-4 font-medium">Category</th>
          <th class="pb-3 pr-4 font-medium">Tier</th>
          <th class="pb-3 pr-4 font-medium">Feed</th>
          <th class="pb-3 pr-4 font-medium">Enabled</th>
          <th class="pb-3 font-medium">Actions</th>
        </tr>
      </thead>
      <tbody id="sources-body" class="divide-y divide-neutral-800"></tbody>
    </table>
  </div>

  <SourceFormModal />
  <script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
    );

    // Elements
    const loading = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const sourcesTable = document.getElementById('sources-table');
    const sourcesBody = document.getElementById('sources-body');
    const statsEl = document.getElementById('stats');
    const modal = document.getElementById('source-modal');
    const modalTitle = document.getElementById('modal-title');
    const form = document.getElementById('source-form') as HTMLFormElement;
    const filterCategory = document.getElementById('filter-category') as HTMLSelectElement;
    const filterTier = document.getElementById('filter-tier') as HTMLSelectElement;
    const filterEnabled = document.getElementById('filter-enabled') as HTMLSelectElement;
    const groupingSelect = document.getElementById('grouping') as HTMLSelectElement;
    const orderingSelect = document.getElementById('ordering') as HTMLSelectElement;
    const orderDirectionBtn = document.getElementById('order-direction') as HTMLButtonElement;

    let sources: any[] = [];
    let orderDirection: 'asc' | 'desc' = 'asc';

    // Check authentication
    async function checkAuth() {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = '/admin/login';
        return false;
      }
      return true;
    }

    // Load sources
    async function loadSources() {
      try {
        const { data, error } = await supabase
          .from('kb_source')
          .select('*')
          .order('sort_order', { ascending: true });

        if (error) throw error;
        sources = data || [];
        renderSources();
        renderStats();
      } catch (err: any) {
        showError(err.message);
      }
    }

    // Render stats
    function renderStats() {
      const total = sources.length;
      const enabled = sources.filter((s) => s.enabled).length;
      const premium = sources.filter((s) => s.tier === 'premium').length;
      const withRss = sources.filter((s) => s.rss_feed).length;

      statsEl!.innerHTML = `
        <span class="rounded-full bg-neutral-800 px-3 py-1">${total} total</span>
        <span class="rounded-full bg-emerald-500/20 text-emerald-300 px-3 py-1">${enabled} enabled</span>
        <span class="rounded-full bg-amber-500/20 text-amber-300 px-3 py-1">${premium} premium</span>
        <span class="rounded-full bg-sky-500/20 text-sky-300 px-3 py-1">${withRss} with RSS</span>
      `;
    }

    // Render sources table
    function renderSources() {
      loading!.classList.add('hidden');
      sourcesTable!.classList.remove('hidden');

      let filtered = [...sources];

      // Apply filters
      if (filterCategory.value) {
        filtered = filtered.filter((s) => s.category === filterCategory.value);
      }
      if (filterTier.value) {
        filtered = filtered.filter((s) => s.tier === filterTier.value);
      }
      if (filterEnabled.value) {
        filtered = filtered.filter((s) => String(s.enabled) === filterEnabled.value);
      }

      // Apply ordering
      const orderField = orderingSelect?.value || 'sort_order';
      filtered.sort((a, b) => {
        let aVal = a[orderField];
        let bVal = b[orderField];

        // Handle nulls
        if (aVal == null) aVal = '';
        if (bVal == null) bVal = '';

        // String comparison
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = (bVal as string).toLowerCase();
        }

        let result = 0;
        if (aVal < bVal) result = -1;
        else if (aVal > bVal) result = 1;

        return orderDirection === 'desc' ? -result : result;
      });

      // Apply grouping
      const groupField = groupingSelect?.value;
      if (groupField) {
        const groups = new Map<string, any[]>();
        filtered.forEach((s) => {
          const key = s[groupField] || 'Other';
          if (!groups.has(key)) groups.set(key, []);
          groups.get(key)!.push(s);
        });

        let html = '';
        groups.forEach((items, groupName) => {
          html += `
            <tr class="bg-neutral-800/30">
              <td colspan="7" class="py-2 px-4 font-medium text-neutral-300 text-sm">
                ${groupName} (${items.length})
              </td>
            </tr>
          `;
          html += items.map((source) => renderSourceRow(source)).join('');
        });
        sourcesBody!.innerHTML = html;
      } else {
        sourcesBody!.innerHTML = filtered.map((source) => renderSourceRow(source)).join('');
      }

      // Bind event handlers
      document.querySelectorAll('.toggle-enabled').forEach((btn) => {
        btn.addEventListener('click', handleToggleEnabled);
      });
      document.querySelectorAll('.edit-btn').forEach((btn) => {
        btn.addEventListener('click', handleEdit);
      });
      document.querySelectorAll('.delete-btn').forEach((btn) => {
        btn.addEventListener('click', handleDelete);
      });
    }

    function renderSourceRow(source: any): string {
      return `
        <tr class="hover:bg-neutral-800/50">
          <td class="py-3 pr-4">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-neutral-700 text-xs font-medium">
              ${source.sort_order ? Math.ceil(source.sort_order / 100) : '-'}
            </span>
          </td>
          <td class="py-3 pr-4">
            <div class="font-medium text-white">${source.name}</div>
            <div class="text-xs text-neutral-500">${source.domain}</div>
          </td>
          <td class="py-3 pr-4">
            <span class="rounded-full px-2 py-0.5 text-xs ${getCategoryColor(source.category)}">
              ${source.category || '-'}
            </span>
          </td>
          <td class="py-3 pr-4">
            <span class="text-xs ${source.tier === 'premium' ? 'text-amber-400' : 'text-neutral-400'}">
              ${source.tier}
            </span>
          </td>
          <td class="py-3 pr-4">
            ${
              source.rss_feed
                ? '<span title="RSS Feed configured" class="cursor-help">üì°</span>'
                : source.sitemap_url
                  ? '<span title="Sitemap configured" class="cursor-help">üó∫Ô∏è</span>'
                  : source.scraper_config
                    ? '<span title="Web scraper configured" class="cursor-help">ü§ñ</span>'
                    : '<span title="No feed configured" class="cursor-help">‚ùå</span>'
            }
          </td>
          <td class="py-3 pr-4">
            <button
              class="toggle-enabled w-10 h-5 rounded-full transition-colors ${source.enabled ? 'bg-emerald-500' : 'bg-neutral-700'}"
              data-slug="${source.slug}"
              data-enabled="${source.enabled}"
            >
              <span class="block w-4 h-4 rounded-full bg-white transform transition-transform ${source.enabled ? 'translate-x-5' : 'translate-x-0.5'}"></span>
            </button>
          </td>
          <td class="py-3">
            <button
              class="edit-btn text-sky-400 hover:text-sky-300 text-sm mr-3"
              data-slug="${source.slug}"
            >
              Edit
            </button>
            <button
              class="delete-btn text-red-400 hover:text-red-300 text-sm"
              data-slug="${source.slug}"
              data-name="${source.name}"
            >
              Delete
            </button>
          </td>
        </tr>
      `;
    }

    function getCategoryColor(category: string): string {
      const colors: Record<string, string> = {
        'financial-media': 'bg-blue-500/20 text-blue-300',
        'ai-thought-leader': 'bg-purple-500/20 text-purple-300',
        'strategy-consulting': 'bg-emerald-500/20 text-emerald-300',
        big4: 'bg-emerald-500/20 text-emerald-300',
        consulting: 'bg-teal-500/20 text-teal-300',
        vendor: 'bg-orange-500/20 text-orange-300',
        research: 'bg-pink-500/20 text-pink-300',
        regulator: 'bg-red-500/20 text-red-300',
        publication: 'bg-sky-500/20 text-sky-300',
      };
      return colors[category] || 'bg-neutral-700 text-neutral-300';
    }

    // Toggle enabled
    async function handleToggleEnabled(e: Event) {
      const btn = e.currentTarget as HTMLButtonElement;
      const slug = btn.dataset.slug;
      const currentEnabled = btn.dataset.enabled === 'true';

      const { error } = await supabase
        .from('kb_source')
        .update({ enabled: !currentEnabled })
        .eq('slug', slug);

      if (error) {
        alert('Failed to update: ' + error.message);
      } else {
        loadSources();
      }
    }

    // Edit source
    function handleEdit(e: Event) {
      const btn = e.currentTarget as HTMLButtonElement;
      const slug = btn.dataset.slug;
      const source = sources.find((s) => s.slug === slug);
      if (!source) return;

      modalTitle!.textContent = 'Edit Source';
      (document.getElementById('edit-slug') as HTMLInputElement).value = source.slug;
      (document.getElementById('source-name') as HTMLInputElement).value = source.name;
      (document.getElementById('source-slug') as HTMLInputElement).value = source.slug;
      (document.getElementById('source-slug') as HTMLInputElement).disabled = true;
      (document.getElementById('source-domain') as HTMLInputElement).value = source.domain || '';
      (document.getElementById('source-priority') as HTMLSelectElement).value = String(
        Math.ceil((source.sort_order || 100) / 100),
      );
      (document.getElementById('source-category') as HTMLSelectElement).value =
        source.category || 'publication';
      (document.getElementById('source-tier') as HTMLSelectElement).value =
        source.tier || 'standard';
      (document.getElementById('source-description') as HTMLTextAreaElement).value =
        source.description || '';
      (document.getElementById('source-rss') as HTMLInputElement).value = source.rss_feed || '';
      (document.getElementById('source-sitemap') as HTMLInputElement).value =
        source.sitemap_url || '';
      (document.getElementById('source-enabled') as HTMLInputElement).checked = source.enabled;
      (document.getElementById('source-show-external') as HTMLInputElement).checked =
        source.show_on_external_page;

      modal!.classList.remove('hidden');
      modal!.classList.add('flex');
    }

    // Delete source
    async function handleDelete(e: Event) {
      const btn = e.currentTarget as HTMLButtonElement;
      const slug = btn.dataset.slug;
      const name = btn.dataset.name;

      if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;

      const { error } = await supabase.from('kb_source').delete().eq('slug', slug);

      if (error) {
        alert('Failed to delete: ' + error.message);
      } else {
        loadSources();
      }
    }

    // Open add modal
    document.getElementById('add-source-btn')?.addEventListener('click', () => {
      modalTitle!.textContent = 'Add Source';
      form.reset();
      (document.getElementById('edit-slug') as HTMLInputElement).value = '';
      (document.getElementById('source-slug') as HTMLInputElement).disabled = false;
      (document.getElementById('source-enabled') as HTMLInputElement).checked = true;
      modal!.classList.remove('hidden');
      modal!.classList.add('flex');
    });

    // Close modal
    function closeModal() {
      modal!.classList.add('hidden');
      modal!.classList.remove('flex');
    }
    document.getElementById('close-modal')?.addEventListener('click', closeModal);
    document.getElementById('cancel-btn')?.addEventListener('click', closeModal);
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    // Submit form
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const editSlug = (document.getElementById('edit-slug') as HTMLInputElement).value;
      const priority = parseInt(
        (document.getElementById('source-priority') as HTMLSelectElement).value,
      );

      const sourceData = {
        name: (document.getElementById('source-name') as HTMLInputElement).value,
        slug: (document.getElementById('source-slug') as HTMLInputElement).value,
        domain: (document.getElementById('source-domain') as HTMLInputElement).value,
        sort_order: priority * 100,
        category: (document.getElementById('source-category') as HTMLSelectElement).value,
        tier: (document.getElementById('source-tier') as HTMLSelectElement).value,
        description:
          (document.getElementById('source-description') as HTMLTextAreaElement).value || null,
        rss_feed: (document.getElementById('source-rss') as HTMLInputElement).value || null,
        sitemap_url: (document.getElementById('source-sitemap') as HTMLInputElement).value || null,
        enabled: (document.getElementById('source-enabled') as HTMLInputElement).checked,
        show_on_external_page: (document.getElementById('source-show-external') as HTMLInputElement)
          .checked,
      };

      let error;
      if (editSlug) {
        // Update
        const { error: updateError } = await supabase
          .from('kb_source')
          .update(sourceData)
          .eq('slug', editSlug);
        error = updateError;
      } else {
        // Insert
        const { error: insertError } = await supabase.from('kb_source').insert(sourceData);
        error = insertError;
      }

      if (error) {
        alert('Failed to save: ' + error.message);
      } else {
        closeModal();
        loadSources();
      }
    });

    // Filter handlers
    filterCategory?.addEventListener('change', renderSources);
    filterTier?.addEventListener('change', renderSources);
    filterEnabled?.addEventListener('change', renderSources);

    // Grouping and ordering handlers
    groupingSelect?.addEventListener('change', renderSources);
    orderingSelect?.addEventListener('change', renderSources);

    // Order direction toggle
    orderDirectionBtn?.addEventListener('click', () => {
      orderDirection = orderDirection === 'asc' ? 'desc' : 'asc';
      orderDirectionBtn.dataset.direction = orderDirection;
      // Update icon
      const svg = orderDirectionBtn.querySelector('svg');
      if (svg) {
        svg.innerHTML =
          orderDirection === 'asc'
            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"></path>'
            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h9m5-4v12m0 0l-4-4m4 4l4-4"></path>';
      }
      renderSources();
    });

    function showError(message: string) {
      loading!.classList.add('hidden');
      errorEl!.classList.remove('hidden');
      errorEl!.querySelector('p')!.textContent = message;
    }

    // Initialize
    async function init() {
      if (await checkAuth()) {
        loadSources();
      }
    }

    init();
  </script>
</AdminLayout>
