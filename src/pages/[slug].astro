---
import fs from 'node:fs';
import Base from '../layouts/Base.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import { marked } from 'marked';
import { fmt } from '../lib/fmt';
import { getAllPublications, getPublicationBySlug } from '../lib/supabase';

// ------------------------------------------------------------
// Static paths
// ------------------------------------------------------------
export async function getStaticPaths() {
  const publications = await getAllPublications();
  return publications.map((item) => ({ params: { slug: item.slug } }));
}

// ------------------------------------------------------------
// Load publication for this slug
// ------------------------------------------------------------
const { slug } = Astro.params;
if (!slug) {
  throw new Error('Missing slug param');
}

const item = await getPublicationBySlug(slug);
if (!item) {
  throw new Error(`Publication not found for slug: ${slug}`);
}

const title = item.title;
const description = (item.summary_medium || item.summary_short || '').slice(0, 220);

// ------------------------------------------------------------
// Thumbnail helpers
// ------------------------------------------------------------
const thumbsDirUrl = new URL('../../public/thumbs/', import.meta.url);
let thumbFiles: string[] = [];

try {
  const dirPath = thumbsDirUrl.pathname;
  thumbFiles = fs.readdirSync(dirPath).filter((f) => /\.(webp|png|jpe?g)$/i.test(f));
} catch {
  thumbFiles = [];
}

const findLocalThumbs = (slugValue?: string): string[] => {
  if (!slugValue) return [];
  const extPriority: Record<string, number> = { '.png': 0, '.webp': 1, '.jpg': 2, '.jpeg': 2 };
  const getExt = (f: string) => (f.match(/\.[^.]+$/)?.[0] || '').toLowerCase();

  const files = thumbFiles.filter((f) => f.includes(slugValue));
  files.sort((a, b) => {
    const pa = extPriority[getExt(a)] ?? 99;
    const pb = extPriority[getExt(b)] ?? 99;
    if (pa !== pb) return pa - pb;
    return a.localeCompare(b);
  });
  return files.map((f) => `/thumbs/${f}`);
};

const expandItemThumb = (t?: string): string[] => {
  if (!t) return [];
  if (/\.(webp|png|jpe?g)$/i.test(t)) return [t];
  if (t.startsWith('http://') || t.startsWith('https://')) return [t];
  return [`${t}.webp`, `${t}.png`, `${t}.jpg`];
};

const thumbCandidates = [...findLocalThumbs(item.slug), ...expandItemThumb(item.thumbnail)];
const ogImage = thumbCandidates[0];
---

<Base title={title} description={description}>
  {
    ogImage && (
      <Fragment slot="head">
        <meta property="og:image" content={ogImage} />
        <meta name="twitter:image" content={ogImage} />
        <link rel="preload" as="image" href={ogImage} />
      </Fragment>
    )
  }

  <article class="mx-auto max-w-3xl">
    <Breadcrumbs
      segments={[
        { label: 'Home', href: '/' },
        { label: 'Publications', href: '/publications' },
        { label: item.title },
      ]}
    />

    <header>
      <h1 class="text-3xl font-bold tracking-tight">{item.title}</h1>
      <div class="mt-2 text-sm text-neutral-300">
        {
          item.date_published && (
            <span title="Date published">
              <span class="text-neutral-400">Published</span> {fmt(item.date_published)}
            </span>
          )
        }
        {item.source_name && <span> · {item.source_name}</span>}
        {item.authors?.length ? <span> · {item.authors[0]}</span> : null}
      </div>
    </header>

    {
      thumbCandidates.length ? (
        <div class="mt-3 relative">
          <div style="aspect-ratio: 16 / 9" />
          <div
            id="skeleton"
            class="absolute inset-0 rounded-md border border-neutral-800 bg-neutral-800/40"
          />
          <img
            src={thumbCandidates[0]}
            data-next={thumbCandidates.slice(1).join('|')}
            alt={`${item.source_name || 'Source'} preview`}
            width="960"
            height="540"
            class="absolute inset-0 h-full w-full rounded-md border border-neutral-800 object-cover"
            loading="eager"
            onload="const s=document.getElementById('skeleton'); if(s) s.style.display='none'"
            onerror="const n=this.dataset.next||''; if(n){ const parts=n.split('|'); const nx=parts.shift(); this.dataset.next=parts.join('|'); if(nx){ this.src=nx; return; } } const s2=document.getElementById('skeleton'); if(s2) s2.style.display='none'; this.style.display='none'"
          />
        </div>
      ) : null
    }

    {
      item.summary_long && (
        <div
          class="mt-4 text-sm text-neutral-200 prose prose-invert prose-sm max-w-none"
          set:html={marked.parse(item.summary_long)}
        />
      )
    }

    <div class="mt-4 flex flex-wrap gap-2 text-xs">
      {
        item.role && (
          <span class="rounded-md border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-neutral-300">
            {item.role}
          </span>
        )
      }
      {
        item.content_type && (
          <span class="rounded-md border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-neutral-300">
            {item.content_type}
          </span>
        )
      }
      {
        item.industry && (
          <span class="rounded-md border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-neutral-300">
            {item.industry}
          </span>
        )
      }
      {
        item.topic && (
          <span class="rounded-md border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-neutral-300">
            {item.topic}
          </span>
        )
      }
      {
        item.geography && (
          <span class="rounded-md border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-neutral-300">
            {item.geography}
          </span>
        )
      }
    </div>

    <div class="mt-6">
      <a
        href={item.url}
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center gap-2 rounded-lg border border-sky-600 bg-sky-600/10 px-5 py-2.5 text-sm font-semibold text-sky-300 hover:bg-sky-600/20 transition-colors"
        aria-label={`Open original on ${item.source_name || 'source'} for ${item.title}`}
        title={`Opens ${item.source_name || 'the publisher'} in a new tab`}
      >
        Open on {item.source_name || 'original'}
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
        </svg>
      </a>
    </div>
  </article>
</Base>
