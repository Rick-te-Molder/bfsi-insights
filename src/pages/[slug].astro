---
import Base from '../layouts/Base.astro';
import fs from 'node:fs';

export async function getStaticPaths() {
  const mod = await import('../data/resources/resources.json');
  const items = (mod.default || mod) as any[];
  return items.map((it) => ({ params: { slug: it.slug } }));
}

const { slug } = Astro.params;
const mod = await import('../data/resources/resources.json');
const items = (mod.default || mod) as any[];
const item = items.find((it) => it.slug === slug);
if (!item) {
  throw new Error('Not found');
}

const fmt = (iso?: string) =>
  iso
    ? new Date(iso).toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' })
    : '';

const externalThumb = (u?: string) =>
  u ? `https://image.thum.io/get/nojs/width/960/crop/960/${encodeURIComponent(u)}` : null;

const thumbsDirUrl = new URL('../../public/thumbs/', import.meta.url);
let thumbFiles: string[] = [];
try {
  const dirPath = thumbsDirUrl.pathname;
  thumbFiles = fs.readdirSync(dirPath).filter((f) => /\.(webp|png|jpe?g)$/i.test(f));
} catch {
  thumbFiles = [];
}
const findLocalThumbs = (s?: string) => {
  if (!s) return [] as string[];
  const extPriority: Record<string, number> = { '.png': 0, '.webp': 1, '.jpg': 2, '.jpeg': 2 };
  const getExt = (f: string) => (f.match(/\.[^.]+$/)?.[0] || '').toLowerCase();
  const files = thumbFiles.filter((f) => f.includes(s));
  files.sort((a, b) => {
    const pa = extPriority[getExt(a)] ?? 99;
    const pb = extPriority[getExt(b)] ?? 99;
    if (pa !== pb) return pa - pb;
    return a.localeCompare(b);
  });
  return files.map((f) => `/thumbs/${f}`);
};
const expandItemThumb = (t?: string) => {
  if (!t) return [] as string[];
  return /\.(webp|png|jpe?g)$/i.test(t) ? [t] : [`${t}.webp`, `${t}.png`, `${t}.jpg`];
};

const title = item.title;
const description = (item.note || '').slice(0, 220);
const candidates = [
  ...findLocalThumbs(item.slug),
  ...expandItemThumb(item.thumbnail),
  ...(externalThumb(item.url) ? [externalThumb(item.url)!] : []),
];
const ogImage = candidates[0] || undefined;
---

<Base title={title} description={description}>
  {
    ogImage && (
      <Fragment slot="head">
        <meta property="og:image" content={ogImage} />
        <meta name="twitter:image" content={ogImage} />
        <link rel="preload" as="image" href={ogImage} />
      </Fragment>
    )
  }

  <article class="mx-auto max-w-3xl">
    <header>
      <h1 class="text-3xl font-bold tracking-tight">{item.title}</h1>
      <div class="mt-2 text-sm text-neutral-300">
        {
          item.date_published && (
            <span title="Date published">
              <span class="text-neutral-400">Published</span> {fmt(item.date_published)}
            </span>
          )
        }
        {item.source_name && <span> · {item.source_name}</span>}
        {item.authors?.length && <span> · {item.authors[0]}</span>}
      </div>
    </header>

    {
      candidates.length ? (
        <div class="mt-3 relative">
          <div style="aspect-ratio: 16 / 9" />
          <div
            id="skeleton"
            class="absolute inset-0 rounded-md border border-neutral-800 bg-neutral-800/40"
          />
          <img
            src={candidates[0]}
            data-next={candidates.slice(1).join('|')}
            alt={`${item.source_name || 'Source'} preview`}
            width="960"
            height="540"
            class="absolute inset-0 h-full w-full rounded-md border border-neutral-800 object-cover"
            loading="eager"
            onload="const sk=document.getElementById('skeleton'); if(sk) sk.style.display='none'"
            onerror="const n=this.dataset.next||''; if(n){ const parts=n.split('|'); const nx=parts.shift(); this.dataset.next=parts.join('|'); if(nx){ this.src=nx; return; } } const sk=document.getElementById('skeleton'); if(sk) sk.style.display='none'; this.style.display='none'"
          />
        </div>
      ) : null
    }

    {item.note && <div class="mt-4 text-sm text-neutral-200 whitespace-pre-wrap">{item.note}</div>}

    <div class="mt-4 flex flex-wrap gap-2 text-xs">
      {
        item.role && (
          <span class="rounded-md border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-neutral-300">
            {item.role}
          </span>
        )
      }
      {
        item.content_type && (
          <span class="rounded-md border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-neutral-300">
            {item.content_type}
          </span>
        )
      }
      {
        item.industry && (
          <span class="rounded-md border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-neutral-300">
            {item.industry}
          </span>
        )
      }
      {
        item.topic && (
          <span class="rounded-md border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-neutral-300">
            {item.topic}
          </span>
        )
      }
      {
        item.jurisdiction && (
          <span class="rounded-md border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-neutral-300">
            {item.jurisdiction}
          </span>
        )
      }
    </div>

    <div class="mt-6">
      <a
        href={item.url}
        target="_blank"
        rel="noopener"
        class="text-sky-300 underline underline-offset-2">Open source →</a
      >
    </div>
  </article>
</Base>
