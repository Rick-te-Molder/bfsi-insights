---
import Base from '../layouts/Base.astro';
import resources from '../data/resources/resources.json';
import fs from 'node:fs';

const fmt = (iso) =>
  iso
    ? new Date(iso).toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' })
    : '';

const values = {
  role: Array.from(new Set(resources.map((r) => r.role).filter(Boolean))).sort(),
  industry: Array.from(new Set(resources.map((r) => r.industry).filter(Boolean))).sort(),
  topic: Array.from(new Set(resources.map((r) => r.topic).filter(Boolean))).sort(),
  content_type: Array.from(new Set(resources.map((r) => r.content_type).filter(Boolean))).sort(),
  jurisdiction: Array.from(new Set(resources.map((r) => r.jurisdiction).filter(Boolean))).sort(),
};

const externalThumb = (u) =>
  u ? `https://image.thum.io/get/nojs/width/600/crop/600/${encodeURIComponent(u)}` : null;

const thumbsDirUrl = new URL('../../public/thumbs/', import.meta.url);
let thumbFiles = [];
try {
  const dirPath = thumbsDirUrl.pathname;
  thumbFiles = fs.readdirSync(dirPath).filter((f) => /\.(webp|png|jpe?g)$/i.test(f));
} catch {
  thumbFiles = [];
}
const findLocalThumbs = (slug) => {
  if (!slug) return [];
  const extPriority = { '.png': 0, '.webp': 1, '.jpg': 2, '.jpeg': 2 };
  const getExt = (f) => (f.match(/\.[^.]+$/)?.[0] || '').toLowerCase();
  const files = thumbFiles.filter((f) => f.includes(slug));
  files.sort((a, b) => {
    const pa = extPriority[getExt(a)] ?? 99;
    const pb = extPriority[getExt(b)] ?? 99;
    if (pa !== pb) return pa - pb;
    return a.localeCompare(b);
  });
  return files.map((f) => `/thumbs/${f}`);
};

const expandItemThumb = (t) => {
  if (!t) return [];
  return /\.(webp|png|jpe?g)$/i.test(t) ? [t] : [`${t}.png`, `${t}.webp`, `${t}.jpg`];
};
---

<Base title="Resources · BFSI Insights">
  <section class="mb-6">
    <div class="flex items-center justify-between">
      <h2 class="text-2xl font-semibold tracking-tight">Resources</h2>
      <div class="flex items-center gap-3">
        <button
          id="open-sheet"
          class="sm:hidden rounded-md border border-neutral-700 px-3 py-1 text-sm text-neutral-200 hover:bg-neutral-800"
          aria-haspopup="dialog"
          aria-controls="filter-sheet"
          >Filter <span
            id="filter-count"
            class="ml-1 inline-block rounded bg-neutral-800 px-1 text-xs text-neutral-300">0</span
          ></button
        >
        <a
          href="/"
          class="text-sm font-medium text-sky-400 underline-offset-2 hover:underline focus:outline-none focus:ring-2 focus:ring-sky-500"
          >Home</a
        >
      </div>
    </div>
    <p class="mt-1 text-sm text-neutral-300">Filter by attributes to find relevant items.</p>
    <p id="count" class="mt-1 text-xs text-neutral-300" aria-live="polite"></p>
    <div id="chips" class="mt-2 flex flex-wrap gap-2"></div>
  </section>

  <section class="mb-6 grid gap-3 sm:grid-cols-2 lg:grid-cols-5 sm:contents">
    <label class="hidden sm:col-span-2 lg:col-span-5 sm:flex flex-col gap-1 text-sm">
      <span class="text-neutral-300">Search</span>
      <input
        id="q"
        type="search"
        placeholder="Search title, note, source, authors"
        class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-1"
      />
    </label>
    <label class="flex flex-col gap-1 text-sm">
      <span class="text-neutral-300">Role</span>
      <select id="f-role" class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-1">
        <option value="">All</option>
        {values.role.map((v) => <option value={v}>{v}</option>)}
      </select>
    </label>
    <label class="flex flex-col gap-1 text-sm">
      <span class="text-neutral-300">Industry</span>
      <select id="f-industry" class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-1">
        <option value="">All</option>
        {values.industry.map((v) => <option value={v}>{v}</option>)}
      </select>
    </label>
    <label class="flex flex-col gap-1 text-sm">
      <span class="text-neutral-300">Topic</span>
      <select id="f-topic" class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-1">
        <option value="">All</option>
        {values.topic.map((v) => <option value={v}>{v}</option>)}
      </select>
    </label>
    <label class="flex flex-col gap-1 text-sm">
      <span class="text-neutral-300">Content type</span>
      <select
        id="f-content_type"
        class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-1"
      >
        <option value="">All</option>
        {values.content_type.map((v) => <option value={v}>{v}</option>)}
      </select>
    </label>
    <label class="flex flex-col gap-1 text-sm">
      <span class="text-neutral-300">Jurisdiction</span>
      <select
        id="f-jurisdiction"
        class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-1"
      >
        <option value="">All</option>
        {values.jurisdiction.map((v) => <option value={v}>{v}</option>)}
      </select>
    </label>
    <div class="sm:col-span-2 lg:col-span-5 flex justify-end">
      <button
        id="clear-filters"
        class="rounded-md border border-neutral-700 px-3 py-1 text-sm text-neutral-200 hover:bg-neutral-800"
        >Clear all</button
      >
    </div>
  </section>

  <!-- Mobile bottom-sheet for filters -->
  <div id="filter-sheet" class="fixed inset-0 z-50 hidden sm:hidden" aria-hidden="true">
    <div id="sheet-backdrop" class="absolute inset-0 bg-black/70"></div>
    <div
      role="dialog"
      aria-modal="true"
      aria-labelledby="sheet-title"
      class="absolute bottom-0 left-0 right-0 max-h-[85vh] overflow-auto rounded-t-2xl border border-neutral-800 bg-neutral-950 p-4"
    >
      <div class="mx-auto max-w-2xl">
        <div class="flex items-center justify-between">
          <h3 id="sheet-title" class="text-lg font-semibold">Filters</h3>
          <button
            id="close-sheet"
            aria-label="Close"
            class="rounded p-2 text-neutral-400 hover:text-white">✕</button
          >
        </div>
        <div class="mt-3 grid gap-3">
          <label class="flex flex-col gap-1 text-sm">
            <span class="text-neutral-300">Search</span>
            <input
              id="m-q"
              type="search"
              placeholder="Search title, note, source, authors"
              class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-2"
            />
          </label>
          <label class="flex flex-col gap-1 text-sm">
            <span class="text-neutral-300">Role</span>
            <select
              id="m-f-role"
              class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-2"
            >
              <option value="">All</option>
              {values.role.map((v) => <option value={v}>{v}</option>)}
            </select>
          </label>
          <label class="flex flex-col gap-1 text-sm">
            <span class="text-neutral-300">Industry</span>
            <select
              id="m-f-industry"
              class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-2"
            >
              <option value="">All</option>
              {values.industry.map((v) => <option value={v}>{v}</option>)}
            </select>
          </label>
          <label class="flex flex-col gap-1 text-sm">
            <span class="text-neutral-300">Topic</span>
            <select
              id="m-f-topic"
              class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-2"
            >
              <option value="">All</option>
              {values.topic.map((v) => <option value={v}>{v}</option>)}
            </select>
          </label>
          <label class="flex flex-col gap-1 text-sm">
            <span class="text-neutral-300">Content type</span>
            <select
              id="m-f-content_type"
              class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-2"
            >
              <option value="">All</option>
              {values.content_type.map((v) => <option value={v}>{v}</option>)}
            </select>
          </label>
          <label class="flex flex-col gap-1 text-sm">
            <span class="text-neutral-300">Jurisdiction</span>
            <select
              id="m-f-jurisdiction"
              class="rounded-md border border-neutral-700 bg-neutral-900 px-2 py-2"
            >
              <option value="">All</option>
              {values.jurisdiction.map((v) => <option value={v}>{v}</option>)}
            </select>
          </label>
        </div>
        <div class="mt-4 flex items-center justify-between">
          <button
            id="m-clear"
            class="rounded-md border border-neutral-700 px-3 py-2 text-sm text-neutral-200 hover:bg-neutral-800"
            >Clear all</button
          >
          <button
            id="m-apply"
            class="rounded-md bg-sky-600 px-4 py-2 text-sm font-medium text-white hover:bg-sky-500"
            >Apply</button
          >
        </div>
      </div>
    </div>
  </div>

  <section>
    <div
      id="empty"
      class="hidden rounded-md border border-neutral-800 bg-neutral-900/60 p-4 text-sm text-neutral-300"
      role="status"
      aria-live="polite"
    >
      No results match the selected filters.
    </div>
    <ul id="list" class="grid gap-6 sm:grid-cols-2">
      {
        resources.map((item) => {
          const role = item.role || '';
          const industry = item.industry || '';
          const topic = item.topic || '';
          const content_type = item.content_type || '';
          const jurisdiction = item.jurisdiction || '';
          return (
            <li
              class="group rounded-2xl border border-neutral-800 bg-neutral-900/60 p-5 shadow-sm ring-1 ring-neutral-800/40 transition hover:border-neutral-700 hover:ring-neutral-700 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-500"
              role="button"
              tabindex="0"
              aria-labelledby={`t-${item.slug}`}
              onclick="openModalFrom(this)"
              onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); openModalFrom(this)}"
              data-role={role}
              data-industry={industry}
              data-topic={topic}
              data-content_type={content_type}
              data-jurisdiction={jurisdiction}
              data-authors={
                Array.isArray(item.authors) ? item.authors.join(', ') : item.authors || ''
              }
            >
              <a
                id={`t-${item.slug}`}
                href={item.url}
                class="text-xl font-semibold text-sky-400 underline-offset-2 hover:underline focus:outline-none focus:ring-2 focus:ring-sky-500"
                onclick="event.stopPropagation()"
              >
                {item.title}
              </a>
              <div class="mt-1 text-sm text-neutral-200">
                {item.date_published && <span>{fmt(item.date_published)}</span>}
                {item.source_name && <span> · {item.source_name}</span>}
                {item.authors?.length && <span> · {item.authors[0]}</span>}
              </div>
              <div class="mt-2 text-xs text-neutral-200 flex flex-wrap gap-2">
                <span>{role}</span>
                {industry && <span>· {industry}</span>}
                {topic && <span>· {topic}</span>}
                {content_type && <span>· {content_type}</span>}
                {jurisdiction && <span>· {jurisdiction}</span>}
              </div>

              <div class="mt-3">
                <div class="relative">
                  {(() => {
                    const candidates = [
                      ...expandItemThumb(item.thumbnail),
                      ...findLocalThumbs(item.slug),
                      ...(externalThumb(item.url) ? [externalThumb(item.url)] : []),
                    ];
                    return (
                      <>
                        <div
                          class="w-full rounded-md border border-neutral-800 bg-neutral-800/40"
                          style="aspect-ratio: 16 / 9"
                        />
                        {candidates.length ? (
                          <img
                            src={candidates[0]}
                            data-next={candidates.slice(1).join('|')}
                            alt={`${item.source_name || 'Source'} preview`}
                            width="640"
                            height="360"
                            loading="lazy"
                            decoding="async"
                            referrerpolicy="no-referrer"
                            sizes="(min-width: 1024px) 560px, (min-width: 640px) 480px, 100vw"
                            class="w-full rounded-md border border-neutral-800 object-cover opacity-0"
                            style="aspect-ratio: 16 / 9"
                            onload="this.classList.remove('opacity-0'); this.previousElementSibling.style.display='none'"
                            onerror="const n=this.dataset.next||''; if(n){ const parts=n.split('|'); const nx=parts.shift(); this.dataset.next=parts.join('|'); if(nx){ this.src=nx; return; } } this.style.display='none'"
                          />
                        ) : null}
                      </>
                    );
                  })()}
                </div>
                {item.note && (
                  <p class="mt-3 text-sm text-neutral-300 line-clamp-2">
                    {item.note}{' '}
                    <button
                      class="text-sky-400 underline-offset-2 hover:underline align-baseline"
                      onclick="event.stopPropagation(); openModalFrom(this.closest('li'))"
                    >
                      (more)
                    </button>
                  </p>
                )}
              </div>
            </li>
          );
        })
      }
    </ul>
  </section>

  <div id="modal" class="fixed inset-0 z-50 hidden">
    <div id="modal-backdrop" class="absolute inset-0 bg-black/70"></div>
    <div
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title"
      class="absolute inset-0 flex items-start justify-center overflow-auto p-4"
    >
      <div
        class="relative mt-10 w-full max-w-3xl rounded-2xl border border-neutral-800 bg-neutral-950 shadow-xl"
      >
        <button
          id="modal-close"
          aria-label="Close"
          class="absolute right-3 top-3 rounded p-2 text-neutral-400 hover:text-white">✕</button
        >
        <div class="p-5">
          <h3 id="modal-title" class="text-xl font-semibold"></h3>
          <div class="mt-1 text-sm text-neutral-400" id="modal-meta"></div>
          <div class="mt-4">
            <div
              class="w-full rounded-md border border-neutral-800 bg-neutral-800/40"
              style="aspect-ratio: 16 / 9"
            >
            </div>
            <img
              id="modal-img"
              alt=""
              class="mt-0 w-full rounded-md border border-neutral-800 object-cover"
              width="960"
              height="540"
              loading="eager"
              style="aspect-ratio: 16 / 9"
            />
          </div>
          <div id="modal-tags" class="mt-4 flex flex-wrap gap-2 text-xs"></div>
          <p id="modal-note" class="mt-4 text-sm text-neutral-200"></p>
          <div class="mt-4">
            <a
              id="modal-link"
              class="text-sky-400 hover:underline"
              target="_blank"
              rel="noopener"
              href="#">Open source →</a
            >
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    window.addEventListener('DOMContentLoaded', async () => {
      // Load Fuse but don't abort if it fails
      let FuseCtor = null;
      try {
        const mod = await import('fuse.js');
        FuseCtor = mod?.default || null;
      } catch {
        void 0;
      }

      const $ = (id) => document.getElementById(id);
      const list = document.getElementById('list');
      const empty = document.getElementById('empty');
      const clearBtn = document.getElementById('clear-filters');
      const countEl = document.getElementById('count');
      const qEl = document.getElementById('q');
      const filters = ['role', 'industry', 'topic', 'content_type', 'jurisdiction'].map((f) => ({
        key: f,
        el: $(`f-${f}`),
      }));

      const STORAGE_KEY = 'resourcesFiltersV1';

      if (!list) return;
      // Build an index of items from the DOM data attributes
      const data = Array.from(list.children).map((li) => ({
        el: li,
        title: li.querySelector('a')?.textContent?.trim() || '',
        note: '',
        source_name: li.querySelector('.mt-1')?.textContent || '',
        authors: li.getAttribute('data-authors') || '',
        role: li.getAttribute('data-role') || '',
        industry: li.getAttribute('data-industry') || '',
        topic: li.getAttribute('data-topic') || '',
        content_type: li.getAttribute('data-content_type') || '',
        jurisdiction: li.getAttribute('data-jurisdiction') || '',
      }));

      const fuse = FuseCtor
        ? new FuseCtor(data, {
            includeScore: true,
            threshold: 0.35,
            keys: [
              { name: 'title', weight: 0.6 },
              { name: 'source_name', weight: 0.2 },
              { name: 'authors', weight: 0.2 },
            ],
          })
        : null;

      function getVals() {
        const sel = Object.fromEntries(filters.map(({ key, el }) => [key, el.value]));
        const q = qEl.value.trim();
        return { ...sel, q };
      }
      function setVals(vals) {
        filters.forEach(({ key, el }) => {
          el.value = vals[key] ?? '';
        });
        qEl.value = vals.q ?? '';
      }
      function updateQuery(vals) {
        const params = new URLSearchParams();
        for (const [k, v] of Object.entries(vals)) if (v && k !== 'q') params.set(k, v);
        if (vals.q) params.set('q', vals.q);
        const qs = params.toString();
        const url = qs ? `${location.pathname}?${qs}` : location.pathname;
        history.replaceState(null, '', url);
      }
      function readFromQuery() {
        const params = new URLSearchParams(location.search);
        const vals = Object.fromEntries([
          ...filters.map(({ key }) => [key, params.get(key) || '']),
          ['q', params.get('q') || ''],
        ]);
        const hasAnyParam = Object.values(vals).some((v) => v);
        if (!hasAnyParam) {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              const parsed = JSON.parse(saved);
              setVals(parsed);
              return parsed;
            }
          } catch {
            void 0;
          }
        }
        setVals(vals);
        return vals;
      }
      function apply(vals = getVals()) {
        let visible = 0;
        let allowed = new Set(data.map((d, i) => i));
        // dropdown filters
        for (const { key } of filters) {
          const v = vals[key];
          if (!v) continue;
          const next = new Set();
          allowed.forEach((idx) => {
            if (data[idx][key] === v) next.add(idx);
          });
          allowed = next;
        }
        // text search
        if (vals.q) {
          if (fuse) {
            const res = fuse.search(vals.q);
            const ids = new Set(res.map((r) => r.refIndex));
            allowed = new Set([...allowed].filter((i) => ids.has(i)));
          } else {
            const q = vals.q.toLowerCase();
            const match = (d) =>
              d.title.toLowerCase().includes(q) ||
              d.source_name.toLowerCase().includes(q) ||
              d.authors.toLowerCase().includes(q);
            allowed = new Set([...allowed].filter((i) => match(data[i])));
          }
        }
        // render
        data.forEach((d, i) => {
          const ok = allowed.has(i);
          d.el.classList.toggle('hidden', !ok);
          if (ok) visible++;
        });
        empty.classList.toggle('hidden', visible !== 0);
        if (countEl) countEl.textContent = `Showing ${visible} of ${list.children.length}`;
        return visible;
      }

      // init from query
      const initVals = readFromQuery();
      apply(initVals);
      // events
      filters.forEach(({ el }) =>
        el.addEventListener('change', () => {
          const vals = getVals();
          updateQuery(vals);
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(vals));
          } catch {
            void 0;
          }
          apply(vals);
        }),
      );
      const debounced = (() => {
        let t;
        return (fn) => {
          clearTimeout(t);
          t = setTimeout(fn, 250);
        };
      })();
      qEl.addEventListener('input', () =>
        debounced(() => {
          const vals = getVals();
          updateQuery(vals);
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(vals));
          } catch {
            void 0;
          }
          apply(vals);
        }),
      );
      clearBtn?.addEventListener('click', () => {
        setVals({ role: '', industry: '', topic: '', content_type: '', jurisdiction: '', q: '' });
        updateQuery(getVals());
        try {
          localStorage.removeItem(STORAGE_KEY);
        } catch {
          void 0;
        }
        apply();
      });
    });
  </script>

  <script type="module">
    function nextSrc(el) {
      const n = el.dataset.next || '';
      if (n) {
        const parts = n.split('|');
        const nx = parts.shift();
        el.dataset.next = parts.join('|');
        return nx || null;
      }
      return null;
    }
    let lastFocus = null;
    let focusTrapHandler = null;
    function openModalFrom(li) {
      const title = li.querySelector('a')?.textContent?.trim() || '';
      const meta = li.querySelector('.mt-1')?.textContent?.trim() || '';
      const note = li.querySelector('p')?.textContent || '';
      const img = li.querySelector('img');
      const link = li.querySelector('a')?.href || '#';
      const tags = Array.from(li.querySelectorAll('.flex.flex-wrap span')).map((s) =>
        s.textContent.trim(),
      );
      const m = document.getElementById('modal');
      lastFocus = document.activeElement;
      m.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-meta').textContent = meta;
      document.getElementById('modal-note').textContent = note.replace(/\(more\)\s*$/, '');
      const tagsEl = document.getElementById('modal-tags');
      tagsEl.innerHTML = '';
      tags.forEach((t) => {
        const b = document.createElement('span');
        b.className =
          'rounded-md border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-xs text-neutral-300';
        b.textContent = t;
        tagsEl.appendChild(b);
      });
      const a = document.getElementById('modal-link');
      a.href = link;
      const mi = document.getElementById('modal-img');
      if (img) {
        mi.src = img.currentSrc || img.src;
        mi.dataset.next = img.dataset.next || '';
        mi.onerror = () => {
          const nx = nextSrc(mi);
          if (nx) {
            mi.src = nx;
          }
        };
      }
      const closeBtn = document.getElementById('modal-close');
      closeBtn.focus();
      focusTrapHandler = (e) => {
        if (!m.contains(e.target)) {
          e.stopPropagation();
          closeBtn.focus();
        }
      };
      window.addEventListener('focusin', focusTrapHandler);
    }
    function closeModal() {
      const m = document.getElementById('modal');
      m.classList.add('hidden');
      document.body.style.overflow = '';
      if (focusTrapHandler) window.removeEventListener('focusin', focusTrapHandler);
      if (lastFocus && typeof lastFocus.focus === 'function') lastFocus.focus();
    }
    // expose
    window.openModalFrom = openModalFrom;
    // listeners
    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('modal-backdrop').addEventListener('click', closeModal);
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    // delegated listeners to ensure cards are clickable
    window.addEventListener('DOMContentLoaded', () => {
      document.addEventListener('click', (e) => {
        const li = e.target.closest('li[role="button"]');
        if (!li) return;
        if (e.target.closest('a,button')) return; // let explicit links/buttons work
        openModalFrom(li);
      });
      document.addEventListener('keydown', (e) => {
        const li = e.target.closest('li[role="button"]');
        if (!li) return;
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openModalFrom(li);
        }
      });
    });
  </script>
  <script type="module">
    // Mobile bottom-sheet filters: sync with desktop controls and main filtering script
    window.addEventListener('DOMContentLoaded', () => {
      const openBtn = document.getElementById('open-sheet');
      const sheet = document.getElementById('filter-sheet');
      const sheetPanel = sheet?.querySelector('[role="dialog"]');
      const backdrop = document.getElementById('sheet-backdrop');
      const closeBtn = document.getElementById('close-sheet');
      const countBadge = document.getElementById('filter-count');
      const chips = document.getElementById('chips');
      if (!openBtn || !sheet) return;

      const desktop = {
        q: document.getElementById('q'),
        role: document.getElementById('f-role'),
        industry: document.getElementById('f-industry'),
        topic: document.getElementById('f-topic'),
        content_type: document.getElementById('f-content_type'),
        jurisdiction: document.getElementById('f-jurisdiction'),
      };
      const mobile = {
        q: document.getElementById('m-q'),
        role: document.getElementById('m-f-role'),
        industry: document.getElementById('m-f-industry'),
        topic: document.getElementById('m-f-topic'),
        content_type: document.getElementById('m-f-content_type'),
        jurisdiction: document.getElementById('m-f-jurisdiction'),
      };

      function getDesktopVals() {
        return {
          role: desktop.role?.value || '',
          industry: desktop.industry?.value || '',
          topic: desktop.topic?.value || '',
          content_type: desktop.content_type?.value || '',
          jurisdiction: desktop.jurisdiction?.value || '',
          q: desktop.q?.value?.trim() || '',
        };
      }
      function setDesktopVals(vals) {
        if (desktop.role) desktop.role.value = vals.role || '';
        if (desktop.industry) desktop.industry.value = vals.industry || '';
        if (desktop.topic) desktop.topic.value = vals.topic || '';
        if (desktop.content_type) desktop.content_type.value = vals.content_type || '';
        if (desktop.jurisdiction) desktop.jurisdiction.value = vals.jurisdiction || '';
        if (desktop.q) desktop.q.value = vals.q || '';
      }
      function renderChips(vals) {
        if (!chips) return;
        chips.innerHTML = '';
        const entries = Object.entries(vals).filter(([k, v]) => k !== 'q' && v);
        entries.forEach(([k, v]) => {
          const b = document.createElement('button');
          b.className =
            'rounded-full border border-neutral-700 px-2 py-0.5 text-xs text-neutral-200 hover:bg-neutral-800';
          b.textContent = `${k.replace('_', ' ')}: ${v} ✕`;
          b.addEventListener('click', () => {
            const cur = getDesktopVals();
            cur[k] = '';
            setDesktopVals(cur);
            applyFromDesktop();
          });
          chips.appendChild(b);
        });
        // update count badge
        const active = entries.length + (vals.q && vals.q.trim() ? 1 : 0);
        if (countBadge) countBadge.textContent = String(active);
      }
      function applyFromDesktop() {
        // Dispatch change events to let the existing script handle apply+URL+storage
        ['role', 'industry', 'topic', 'content_type', 'jurisdiction'].forEach((k) => {
          const el = desktop[k];
          if (el) el.dispatchEvent(new Event('change', { bubbles: true }));
        });
        // trigger input debounce by dispatching input once
        if (desktop.q) desktop.q.dispatchEvent(new Event('input', { bubbles: true }));
        renderChips(getDesktopVals());
      }
      function openSheet() {
        syncToMobile();
        sheet.classList.remove('hidden');
        sheet.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        mobile.role?.focus();
      }
      function closeSheet() {
        sheet.classList.add('hidden');
        sheet.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        openBtn.focus();
      }
      function syncToMobile() {
        const v = getDesktopVals();
        if (mobile.role) mobile.role.value = v.role;
        if (mobile.industry) mobile.industry.value = v.industry;
        if (mobile.topic) mobile.topic.value = v.topic;
        if (mobile.content_type) mobile.content_type.value = v.content_type;
        if (mobile.jurisdiction) mobile.jurisdiction.value = v.jurisdiction;
        if (mobile.q) mobile.q.value = v.q;
      }

      openBtn.addEventListener('click', openSheet);
      closeBtn?.addEventListener('click', closeSheet);
      backdrop?.addEventListener('click', closeSheet);
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && sheet && !sheet.classList.contains('hidden')) closeSheet();
      });

      document.getElementById('m-clear')?.addEventListener('click', () => {
        const empty = {
          role: '',
          industry: '',
          topic: '',
          content_type: '',
          jurisdiction: '',
          q: '',
        };
        setDesktopVals(empty);
        applyFromDesktop();
        closeSheet();
      });
      document.getElementById('m-apply')?.addEventListener('click', () => {
        const vals = {
          role: mobile.role?.value || '',
          industry: mobile.industry?.value || '',
          topic: mobile.topic?.value || '',
          content_type: mobile.content_type?.value || '',
          jurisdiction: mobile.jurisdiction?.value || '',
          q: mobile.q?.value?.trim() || '',
        };
        setDesktopVals(vals);
        applyFromDesktop();
        closeSheet();
      });

      // initial chips render
      renderChips(getDesktopVals());
    });
  </script>
</Base>
