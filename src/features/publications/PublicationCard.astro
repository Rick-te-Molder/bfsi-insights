---
import fs from 'node:fs';

interface Props {
  item: any;
  index?: number;
  mode?: string;
}

const { item, index = 0, mode } = Astro.props as Props;
const isHome = mode === 'home';
const isFirst = Number(index) === 0;

const fmt = (iso?: string) =>
  iso
    ? new Date(iso).toLocaleDateString('en-GB', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      })
    : '';

const asArr = (v: any) => (Array.isArray(v) ? v : v ? [v] : []);

// Thumbnail helpers
const expandItemThumb = (t?: string) => {
  if (!t) return [];
  if (/\.(webp|png|jpe?g)$/i.test(t)) return [t];
  if (t.startsWith('http://') || t.startsWith('https://')) return [t];
  return [`${t}.webp`, `${t}.png`, `${t}.jpg`];
};

let thumbFiles: string[] = [];
try {
  const thumbsDirUrl = new URL('../../../public/thumbs/', import.meta.url);
  const dirPath = thumbsDirUrl.pathname;
  thumbFiles = fs.readdirSync(dirPath).filter((f) => /\.(webp|png|jpe?g)$/i.test(f));
} catch {
  thumbFiles = [];
}

const findLocalThumbs = (slug?: string) => {
  if (!slug) return [] as string[];

  // If we couldn't read the directory, fall back to generic guesses
  if (!thumbFiles.length) {
    return [`/thumbs/${slug}.webp`, `/thumbs/${slug}.png`, `/thumbs/${slug}.jpg`];
  }

  const extPriority: Record<string, number> = { '.png': 0, '.webp': 1, '.jpg': 2, '.jpeg': 2 };
  const getExt = (f: string) => (f.match(/\.[^.]+$/)?.[0] || '').toLowerCase();

  const files = thumbFiles.filter((f) => f.includes(slug));
  files.sort((a, b) => {
    const pa = extPriority[getExt(a)] ?? 99;
    const pb = extPriority[getExt(b)] ?? 99;
    if (pa !== pb) return pa - pb;
    return a.localeCompare(b);
  });

  return files.map((f) => `/thumbs/${f}`);
};

const topic = asArr(item.topic);
const content_type = asArr(item.content_type);
const role = item.role || '';
const industry = item.industry || '';
const geography = item.geography || '';

const isNew =
  isHome && item.date_added
    ? (() => {
        const date = new Date(item.date_added);
        return !isNaN(date.getTime()) && (Date.now() - date.getTime()) / 86400000 <= 7;
      })()
    : false;

const isUpdated =
  isHome && item.last_edited && !isNew
    ? (() => {
        const date = new Date(item.last_edited);
        return !isNaN(date.getTime()) && (Date.now() - date.getTime()) / 86400000 <= 7;
      })()
    : false;

const candidates = [...findLocalThumbs(item.slug), ...expandItemThumb(item.thumbnail)];
const hasImage = candidates.length > 0;
---

<li
  class="group rounded-2xl border border-neutral-800 bg-neutral-900/60 p-5 shadow-sm ring-1 ring-neutral-800/40 transition-all hover:border-neutral-700 hover:ring-neutral-700 hover:bg-neutral-900 relative"
  aria-labelledby={`t-${item.slug}`}
  data-role={role}
  data-industry={industry}
  data-topic={topic[0] || ''}
  data-content_type={content_type[0] || ''}
  data-geography={geography}
  data-authors={Array.isArray(item.authors) ? item.authors.join(', ') : item.authors || ''}
  data-slug={item.slug}
  data-url={item.url}
  data-source_name={item.source_name || ''}
  data-thumbnail={item.thumbnail || ''}
  data-summary-medium={item.summary_medium || ''}
>
  <a
    href={`/${item.slug}`}
    class="absolute inset-0 rounded-2xl focus:outline-none focus:ring-2 focus:ring-sky-500 z-10"
    aria-label={`View details for ${item.title}`}
    tabindex="0"
    data-card-link></a>

  <div class="relative z-20 pointer-events-none">
    <div class="flex items-center gap-2">
      <h3 id={`t-${item.slug}`} class="text-xl font-semibold text-sky-200">
        {item.title}
      </h3>
      {
        isHome && isNew && (
          <span class="ml-1 align-middle rounded-full bg-emerald-400/10 px-2 py-0.5 text-xs font-semibold text-emerald-300 ring-1 ring-inset ring-emerald-400/30">
            New
          </span>
        )
      }
      {
        isHome && isUpdated && (
          <span class="ml-1 align-middle rounded-full bg-amber-400/10 px-2 py-0.5 text-xs font-semibold text-amber-300 ring-1 ring-inset ring-amber-400/30">
            Updated
          </span>
        )
      }
    </div>

    <div class="relative mt-1 text-sm text-neutral-200">
      {
        item.date_published && (
          <span title="Date published">
            <span class="text-neutral-400">Published</span> {fmt(item.date_published)}
          </span>
        )
      }
      {item.source_name && <span> 路 {item.source_name}</span>}
      {item.authors?.length && <span> 路 {item.authors[0]}</span>}
    </div>

    <div class="relative mt-2">
      {
        hasImage ? (
          <div
            class="relative w-full rounded-md border border-neutral-800 bg-neutral-800/40"
            style="aspect-ratio: 16 / 9; overflow: hidden;"
          >
            <img
              src={candidates[0]}
              data-next={candidates.slice(1).join('|')}
              alt={`${item.source_name || 'Source'} preview`}
              width={isFirst ? 960 : 640}
              height={isFirst ? 540 : 360}
              loading={isFirst ? 'eager' : 'lazy'}
              fetchpriority={isFirst ? 'high' : 'auto'}
              decoding="async"
              referrerpolicy="no-referrer"
              sizes="(min-width: 1024px) 560px, (min-width: 640px) 480px, 100vw"
              class="absolute inset-0 w-full h-full object-cover"
            />
          </div>
        ) : (
          <div class="relative w-full rounded-md border border-neutral-800 bg-neutral-900/80 px-4 py-10 flex items-center justify-center">
            <p class="text-xs text-neutral-500 text-center">
              Thumbnail not available yet. Full publication preview below.
            </p>
          </div>
        )
      }

      {
        item.summary_short && (
          <div class="relative mt-3">
            <p class="text-sm text-neutral-300 line-clamp-3">{item.summary_short}</p>
            <div class="mt-2 flex justify-end">
              <button
                class="relative z-30 inline-flex items-center gap-1 text-sm text-sky-300 hover:text-sky-200 transition-colors px-2 py-1 rounded hover:bg-neutral-800/50 pointer-events-auto"
                type="button"
                data-open-modal="true"
                aria-label="Preview summary"
              >
                <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                  />
                </svg>
                Preview
              </button>
            </div>
          </div>
        )
      }

      <div class="mt-3 text-xs text-neutral-200 flex flex-wrap gap-2">
        {role && <span>{role}</span>}
        {content_type.length ? <span>路 {content_type[0]}</span> : null}
        {geography && <span>路 {geography}</span>}
      </div>
    </div>
  </div>
</li>
