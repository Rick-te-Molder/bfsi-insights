---
import type { Publication } from '../../lib/supabase';

interface Props {
  item: Publication;
  index?: number;
  mode?: string;
}

const { item, index = 0, mode } = Astro.props as Props;
const isHome = mode === 'home';
const isFirst = Number(index) === 0;

const fmt = (iso?: string) =>
  iso
    ? new Date(iso).toLocaleDateString('en-GB', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      })
    : '';

const asArr = (v: any) => (Array.isArray(v) ? v : v ? [v] : []);

const expandItemThumb = (t?: string) => {
  if (!t) return [];
  if (/\.(webp|png|jpe?g)$/i.test(t)) return [t];
  if (t.startsWith('http://') || t.startsWith('https://')) return [t];
  return [`${t}.webp`, `${t}.png`, `${t}.jpg`];
};

const topic = asArr(item.topic);
const content_type = asArr(item.content_type);
const role = item.role || '';
const industry = item.industry || '';
const geography = item.geography || '';
const regulators = item.regulators || [];
const regulations = item.regulations || [];
const obligations = item.obligations || [];
const processes = item.processes || [];

const isNew =
  isHome && item.date_added
    ? (() => {
        const date = new Date(item.date_added);
        return !isNaN(date.getTime()) && (Date.now() - date.getTime()) / 86400000 <= 7;
      })()
    : false;

const isUpdated =
  isHome && item.last_edited && !isNew
    ? (() => {
        const date = new Date(item.last_edited);
        return !isNaN(date.getTime()) && (Date.now() - date.getTime()) / 86400000 <= 7;
      })()
    : false;

// Only use thumbnails if explicitly set in database
const hasImage = !!item.thumbnail || !!item.thumbnail_path;

let itemThumbs: string[] = [];
if (item.thumbnail_path && item.thumbnail_bucket) {
  const url = `${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/${item.thumbnail_bucket}/${item.thumbnail_path}`;
  itemThumbs = [url];
} else if (item.thumbnail) {
  itemThumbs = expandItemThumb(item.thumbnail);
}

// Put database thumbnail first
const candidates = [...itemThumbs];
---

<li
  class="group rounded-2xl border border-neutral-800 bg-neutral-900/60 p-5 shadow-sm ring-1 ring-neutral-800/40 transition-all hover:border-neutral-700 hover:ring-neutral-700 hover:bg-neutral-900 relative"
  aria-labelledby={`t-${item.slug}`}
  data-role={role}
  data-industry={industry}
  data-topic={topic[0] || ''}
  data-content_type={content_type[0] || ''}
  data-geography={geography}
  data-regulator={regulators.join(',') || ''}
  data-regulation={regulations.join(',') || ''}
  data-obligation={obligations.join(',') || ''}
  data-process={processes.join(',') || ''}
  data-authors={Array.isArray(item.authors) ? item.authors.join(', ') : item.authors || ''}
  data-slug={item.slug}
  data-url={item.url}
  data-source_name={item.source_name || ''}
  data-title={item.title}
  data-thumbnail={item.thumbnail || ''}
  data-summary-medium={item.summary_medium || ''}
  data-date_published={item.date_published || ''}
>
  <a
    href={`/${item.slug}`}
    class="absolute inset-0 rounded-2xl focus:outline-none focus:ring-2 focus:ring-sky-500 z-10"
    aria-label={`View details for ${item.title}`}
    tabindex="0"
    data-card-link></a>

  <div class="relative z-20 pointer-events-none flex flex-col h-full">
    <div class="flex items-center gap-2">
      <h3
        id={`t-${item.slug}`}
        class="text-xl font-semibold text-sky-200 line-clamp-2"
        title={item.title}
      >
        {item.title}
      </h3>
      {
        isHome && isNew && (
          <span class="ml-1 align-middle rounded-full bg-emerald-400/10 px-2 py-0.5 text-xs font-semibold text-emerald-300 ring-1 ring-inset ring-emerald-400/30">
            New
          </span>
        )
      }
      {
        isHome && isUpdated && (
          <span class="ml-1 align-middle rounded-full bg-amber-400/10 px-2 py-0.5 text-xs font-semibold text-amber-300 ring-1 ring-inset ring-amber-400/30">
            Updated
          </span>
        )
      }
    </div>

    <div class="relative mt-1 text-sm text-neutral-200">
      {
        item.date_published && (
          <span title="Date published">
            <span class="text-neutral-400">Published</span> {fmt(item.date_published)}
          </span>
        )
      }
      {item.source_name && <span> · {item.source_name}</span>}
      {item.authors?.length && <span> · {item.authors[0]}</span>}
    </div>

    <!-- Thumbnail area (fixed height) -->
    <div
      class="relative mt-2 w-full rounded-md border border-neutral-800 bg-neutral-800/40"
      style="aspect-ratio: 16 / 9; overflow: hidden;"
    >
      {
        hasImage ? (
          <>
            <div class="absolute inset-0 rounded-md bg-neutral-800/40" />
            <img
              src={candidates[0]}
              data-next={candidates.slice(1).join('|')}
              alt={`${item.source_name || 'Source'} preview`}
              width={isFirst ? 960 : 640}
              height={isFirst ? 540 : 360}
              loading={isFirst ? 'eager' : 'lazy'}
              fetchpriority={isFirst ? 'high' : 'auto'}
              decoding="async"
              referrerpolicy="no-referrer"
              sizes="(min-width: 1024px) 560px, (min-width: 640px) 480px, 100vw"
              class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-300"
            />
          </>
        ) : (
          <div class="absolute inset-0 flex items-center justify-center">
            <svg
              class="h-10 w-10 text-neutral-700"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
              />
            </svg>
          </div>
        )
      }
    </div>

    {
      item.summary_short && (
        <p class="mt-2 text-sm text-neutral-300 line-clamp-2">{item.summary_short}</p>
      )
    }

    <!-- Tags row with Preview button aligned - pushed to bottom -->
    <div class="mt-auto pt-3 flex items-start justify-between gap-2">
      <div class="flex flex-wrap items-center gap-1.5 flex-1 min-w-0">
        {/* Core metadata */}
        {
          role && (
            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-500/10 text-amber-300 ring-1 ring-inset ring-amber-500/20">
              <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                />
              </svg>
              {role}
            </span>
          )
        }
        {
          content_type.length > 0 && (
            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-neutral-500/10 text-neutral-300 ring-1 ring-inset ring-neutral-500/20">
              <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                />
              </svg>
              {content_type[0]}
            </span>
          )
        }
        {
          geography && (
            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-teal-500/10 text-teal-300 ring-1 ring-inset ring-teal-500/20">
              <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              {geography}
            </span>
          )
        }
        {/* Regulatory tags */}
        {
          regulators.length > 0 &&
            regulators.slice(0, 2).map((reg: string) => (
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-rose-500/10 text-rose-300 ring-1 ring-inset ring-rose-500/20">
                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"
                  />
                </svg>
                {reg}
              </span>
            ))
        }
        {
          regulations.length > 0 &&
            regulations.slice(0, 2).map((reg: string) => (
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-orange-500/10 text-orange-300 ring-1 ring-inset ring-orange-500/20">
                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                  />
                </svg>
                {reg}
              </span>
            ))
        }
        {/* Overflow indicator - opens modal */}
        {
          (regulators.length > 2 || regulations.length > 2) && (
            <button
              type="button"
              data-open-modal="true"
              class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-neutral-700/50 text-neutral-400 ring-1 ring-inset ring-neutral-600/30 hover:bg-neutral-600/50 hover:text-neutral-300 transition-colors pointer-events-auto"
            >
              +{Math.max(0, regulators.length - 2) + Math.max(0, regulations.length - 2)} more
            </button>
          )
        }
      </div>

      <!-- Preview button -->
      <button
        class="relative z-30 flex-shrink-0 inline-flex items-center gap-1 text-xs text-sky-300 hover:text-sky-200 transition-colors px-2 py-0.5 rounded hover:bg-neutral-800/50 pointer-events-auto"
        type="button"
        data-open-modal="true"
        aria-label="Preview summary"
      >
        <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
          ></path>
        </svg>
        Preview
      </button>
    </div>
  </div>
</li>
