---
import type { Publication } from '../../lib/supabase';

interface Props {
  item: Publication;
  index?: number;
  mode?: string;
}

const { item, index = 0, mode } = Astro.props as Props;
const isHome = mode === 'home';
const isFirst = Number(index) === 0;

const fmt = (iso?: string) =>
  iso
    ? new Date(iso).toLocaleDateString('en-GB', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      })
    : '';

const asArr = (v: any) => (Array.isArray(v) ? v : v ? [v] : []);

const expandItemThumb = (t?: string) => {
  if (!t) return [];
  if (/\.(webp|png|jpe?g)$/i.test(t)) return [t];
  if (t.startsWith('http://') || t.startsWith('https://')) return [t];
  return [`${t}.webp`, `${t}.png`, `${t}.jpg`];
};

const topics = item.topics?.length ? item.topics : asArr(item.topic);
const industries = item.industries?.length ? item.industries : asArr(item.industry);
const content_type = asArr(item.content_type);
const role = item.role || '';
const geography = item.geography || '';
const regulators = item.regulators || [];
const regulations = item.regulations || [];

// Build tags array with type info for color coding
type TagInfo = {
  label: string;
  type: 'industry' | 'topic' | 'geography' | 'role' | 'content' | 'regulator' | 'regulation';
};
const allTags: TagInfo[] = [];

// Add industry tags (primary importance)
industries.filter(Boolean).forEach((ind: string) => allTags.push({ label: ind, type: 'industry' }));
// Add topic tags
topics.filter(Boolean).forEach((t: string) => allTags.push({ label: t, type: 'topic' }));
// Add geography
if (geography) allTags.push({ label: geography, type: 'geography' });
// Add role/persona
if (role) allTags.push({ label: role, type: 'role' });
// Add content type
content_type.filter(Boolean).forEach((ct: string) => allTags.push({ label: ct, type: 'content' }));
// Add regulators
regulators.filter(Boolean).forEach((r: string) => allTags.push({ label: r, type: 'regulator' }));
// Add regulations
regulations.filter(Boolean).forEach((r: string) => allTags.push({ label: r, type: 'regulation' }));

// Show max 5 tags, with overflow indicator
const MAX_VISIBLE_TAGS = 5;
const visibleTags = allTags.slice(0, MAX_VISIBLE_TAGS);
const overflowCount = Math.max(0, allTags.length - MAX_VISIBLE_TAGS);

const isNew =
  isHome && item.date_added
    ? (() => {
        const date = new Date(item.date_added);
        return !isNaN(date.getTime()) && (Date.now() - date.getTime()) / 86400000 <= 7;
      })()
    : false;

const isUpdated =
  isHome && item.last_edited && !isNew
    ? (() => {
        const date = new Date(item.last_edited);
        return !isNaN(date.getTime()) && (Date.now() - date.getTime()) / 86400000 <= 7;
      })()
    : false;

// Only use thumbnails if explicitly set in database
const hasImage = !!item.thumbnail || !!item.thumbnail_path;

let itemThumbs: string[] = [];
if (item.thumbnail_path && item.thumbnail_bucket) {
  const url = `${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/${item.thumbnail_bucket}/${item.thumbnail_path}`;
  itemThumbs = [url];
} else if (item.thumbnail) {
  itemThumbs = expandItemThumb(item.thumbnail);
}

// Put database thumbnail first
const candidates = [...itemThumbs];
---

<li
  class="group rounded-2xl border border-neutral-800 bg-neutral-900/60 p-5 shadow-sm ring-1 ring-neutral-800/40 transition-all hover:border-neutral-700 hover:ring-neutral-700 hover:bg-neutral-900 relative"
  aria-labelledby={`t-${item.slug}`}
  data-role={role}
  data-industry={industries[0] || ''}
  data-topic={topics[0] || ''}
  data-content_type={content_type[0] || ''}
  data-geography={geography}
  data-regulator={regulators.join(',') || ''}
  data-regulation={regulations.join(',') || ''}
  data-authors={Array.isArray(item.authors) ? item.authors.join(', ') : item.authors || ''}
  data-slug={item.slug}
  data-url={item.url}
  data-source_name={item.source_name || ''}
  data-thumbnail={item.thumbnail || ''}
  data-summary-medium={item.summary_medium || ''}
  data-date_published={item.date_published || ''}
>
  <a
    href={`/${item.slug}`}
    class="absolute inset-0 rounded-2xl focus:outline-none focus:ring-2 focus:ring-sky-500 z-10"
    aria-label={`View details for ${item.title}`}
    tabindex="0"
    data-card-link
    data-open-modal="true"></a>

  <div class="relative z-20 pointer-events-none">
    <div class="flex items-center gap-2">
      <h3 id={`t-${item.slug}`} class="text-xl font-semibold text-sky-200">
        {item.title}
      </h3>
      {
        isHome && isNew && (
          <span class="ml-1 align-middle rounded-full bg-emerald-400/10 px-2 py-0.5 text-xs font-semibold text-emerald-300 ring-1 ring-inset ring-emerald-400/30">
            New
          </span>
        )
      }
      {
        isHome && isUpdated && (
          <span class="ml-1 align-middle rounded-full bg-amber-400/10 px-2 py-0.5 text-xs font-semibold text-amber-300 ring-1 ring-inset ring-amber-400/30">
            Updated
          </span>
        )
      }
    </div>

    <div class="relative mt-1 text-sm text-neutral-200">
      {
        item.date_published && (
          <span title="Date published">
            <span class="text-neutral-400">Published</span> {fmt(item.date_published)}
          </span>
        )
      }
      {item.source_name && <span> · {item.source_name}</span>}
      {item.authors?.length && <span> · {item.authors[0]}</span>}
    </div>

    <div class="relative mt-2">
      {
        hasImage ? (
          <div
            class="relative w-full rounded-md border border-neutral-800 bg-neutral-800/40"
            style="aspect-ratio: 16 / 9; overflow: hidden;"
          >
            <div class="absolute inset-0 rounded-md bg-neutral-800/40" />
            <img
              src={candidates[0]}
              data-next={candidates.slice(1).join('|')}
              alt={`${item.source_name || 'Source'} preview`}
              width={isFirst ? 960 : 640}
              height={isFirst ? 540 : 360}
              loading={isFirst ? 'eager' : 'lazy'}
              fetchpriority={isFirst ? 'high' : 'auto'}
              decoding="async"
              referrerpolicy="no-referrer"
              sizes="(min-width: 1024px) 560px, (min-width: 640px) 480px, 100vw"
              class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-300"
            />
          </div>
        ) : (
          <div class="relative w-full rounded-md border border-neutral-800 bg-neutral-900/80 px-4 py-10 flex items-center justify-center">
            <p class="text-xs text-neutral-500 text-center">
              Thumbnail not available yet. Full publication preview below.
            </p>
          </div>
        )
      }

      {
        item.summary_short && (
          <div class="relative mt-3">
            <p class="text-sm text-neutral-300 line-clamp-3">{item.summary_short}</p>
            <div class="mt-2 flex justify-end">
              <button
                class="relative z-30 inline-flex items-center gap-1 text-sm text-sky-300 hover:text-sky-200 transition-colors px-2 py-1 rounded hover:bg-neutral-800/50 pointer-events-auto"
                type="button"
                data-open-modal="true"
                aria-label="Preview summary"
              >
                <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                  />
                </svg>
                Preview
              </button>
            </div>
          </div>
        )
      }

      {/* Enhanced Tags Section with color coding and icons */}
      <div class="mt-3 flex flex-wrap gap-1.5">
        {
          visibleTags.map((tag) => (
            <span
              class:list={[
                'inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium',
                {
                  'bg-cyan-500/10 text-cyan-300 ring-1 ring-inset ring-cyan-500/20':
                    tag.type === 'industry',
                  'bg-violet-500/10 text-violet-300 ring-1 ring-inset ring-violet-500/20':
                    tag.type === 'topic',
                  'bg-teal-500/10 text-teal-300 ring-1 ring-inset ring-teal-500/20':
                    tag.type === 'geography',
                  'bg-amber-500/10 text-amber-300 ring-1 ring-inset ring-amber-500/20':
                    tag.type === 'role',
                  'bg-neutral-500/10 text-neutral-300 ring-1 ring-inset ring-neutral-500/20':
                    tag.type === 'content',
                  'bg-rose-500/10 text-rose-300 ring-1 ring-inset ring-rose-500/20':
                    tag.type === 'regulator',
                  'bg-orange-500/10 text-orange-300 ring-1 ring-inset ring-orange-500/20':
                    tag.type === 'regulation',
                },
              ]}
            >
              {/* Icons for each tag type */}
              {tag.type === 'industry' && (
                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                  />
                </svg>
              )}
              {tag.type === 'topic' && (
                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
                  />
                </svg>
              )}
              {tag.type === 'geography' && (
                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              )}
              {tag.type === 'role' && (
                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                  />
                </svg>
              )}
              {tag.type === 'content' && (
                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  />
                </svg>
              )}
              {tag.type === 'regulator' && (
                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"
                  />
                </svg>
              )}
              {tag.type === 'regulation' && (
                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                  />
                </svg>
              )}
              {tag.label}
            </span>
          ))
        }
        {
          overflowCount > 0 && (
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-neutral-700/50 text-neutral-400 ring-1 ring-inset ring-neutral-600/30">
              +{overflowCount} more
            </span>
          )
        }
      </div>
    </div>
  </div>
</li>
