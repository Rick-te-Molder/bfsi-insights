---
import type { Publication } from '../../lib/supabase';

interface Props {
  item: Publication;
  index?: number;
  mode?: string;
}

const { item, index = 0, mode } = Astro.props as Props;
const isHome = mode === 'home';
const isFirst = Number(index) === 0;

const fmt = (iso?: string) =>
  iso
    ? new Date(iso).toLocaleDateString('en-GB', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      })
    : '';

const asArr = (v: any) => (Array.isArray(v) ? v : v ? [v] : []);

// Strip redundant source suffix from title (e.g., "Article Title | FDIC.gov" → "Article Title")
const stripSourceFromTitle = (title: string, sourceName?: string | null): string => {
  if (!sourceName) return title;
  // Match common separators: |, -, —, –, :
  const separators = ['|', '-', '—', '–', ':'];
  for (const sep of separators) {
    const suffix = `${sep} ${sourceName}`;
    if (title.endsWith(suffix)) {
      return title.slice(0, -suffix.length).trim();
    }
    // Also try without space: "Title|Source"
    const suffixNoSpace = `${sep}${sourceName}`;
    if (title.endsWith(suffixNoSpace)) {
      return title.slice(0, -suffixNoSpace.length).trim();
    }
  }
  return title;
};

const displayTitle = stripSourceFromTitle(item.title, item.source_name);

const expandItemThumb = (t?: string) => {
  if (!t) return [];
  if (/\.(webp|png|jpe?g)$/i.test(t)) return [t];
  if (t.startsWith('http://') || t.startsWith('https://')) return [t];
  return [`${t}.webp`, `${t}.png`, `${t}.jpg`];
};

const topic = asArr(item.topic);
const content_type = asArr(item.content_type);
const audience = item.audience || (item as any).role || '';
const audiences = item.audiences || [];
const industry = item.industry || '';
const industries = item.industries || [];
const geography = item.geography || '';
const geographies = item.geographies || [];
const regulators = item.regulators || [];
const regulations = item.regulations || [];
const obligations = item.obligations || [];
const processes = item.processes || [];

// Count extra tags (everything except first audience and first geography shown on card)
// Extra audiences (beyond first), extra geographies (beyond first), plus all other tags
const extraTagCount =
  Math.max(0, audiences.length - 1) +
  Math.max(0, geographies.length - 1) +
  industries.length +
  topic.length +
  content_type.length +
  regulators.length +
  regulations.length +
  obligations.length +
  processes.length;

const isNew =
  isHome && item.date_added
    ? (() => {
        const date = new Date(item.date_added);
        return !isNaN(date.getTime()) && (Date.now() - date.getTime()) / 86400000 <= 7;
      })()
    : false;

const isUpdated =
  isHome && item.last_edited && !isNew
    ? (() => {
        const date = new Date(item.last_edited);
        return !isNaN(date.getTime()) && (Date.now() - date.getTime()) / 86400000 <= 7;
      })()
    : false;

// Only use thumbnails if explicitly set in database
const hasImage = !!item.thumbnail || !!item.thumbnail_path;

let itemThumbs: string[] = [];
if (item.thumbnail_path && item.thumbnail_bucket) {
  const url = `${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/${item.thumbnail_bucket}/${item.thumbnail_path}`;
  itemThumbs = [url];
} else if (item.thumbnail) {
  itemThumbs = expandItemThumb(item.thumbnail);
}

// Put database thumbnail first
const candidates = [...itemThumbs];
---

<li
  class="group rounded-2xl border border-neutral-800 bg-neutral-900/60 p-5 shadow-sm ring-1 ring-neutral-800/40 transition-all hover:border-neutral-700 hover:ring-neutral-700 hover:bg-neutral-900 relative"
  aria-labelledby={`t-${item.slug}`}
  data-audience={audience}
  data-audiences={audiences.join(',') || ''}
  data-industry={industry}
  data-industries={industries.join(',') || ''}
  data-topic={topic[0] || ''}
  data-topics={(item.topics || []).join(',') || ''}
  data-content_type={content_type[0] || ''}
  data-geography={geography}
  data-geographies={geographies.join(',') || ''}
  data-regulator={regulators.join(',') || ''}
  data-regulation={regulations.join(',') || ''}
  data-obligation={obligations.join(',') || ''}
  data-process={processes.join(',') || ''}
  data-authors={Array.isArray(item.authors) ? item.authors.join(', ') : item.authors || ''}
  data-slug={item.slug}
  data-url={item.url}
  data-source_name={item.source_name || ''}
  data-title={item.title}
  data-thumbnail={item.thumbnail || ''}
  data-summary-medium={item.summary_medium || ''}
  data-date_published={item.date_published || ''}
  data-date_added={item.date_added || ''}
>
  <a
    href={`/${item.slug}`}
    class="absolute inset-0 rounded-2xl focus:outline-none focus:ring-2 focus:ring-sky-500 z-10"
    aria-label={`View details for ${item.title}`}
    tabindex="0"
    data-card-link></a>

  <div class="relative z-20 pointer-events-none flex flex-col h-full">
    <div class="flex items-center gap-2">
      <h3
        id={`t-${item.slug}`}
        class="text-xl font-semibold text-sky-200 line-clamp-2"
        title={displayTitle}
      >
        {displayTitle}
      </h3>
      {
        isHome && isNew && (
          <span class="ml-1 align-middle rounded-full bg-emerald-400/10 px-2 py-0.5 text-xs font-semibold text-emerald-300 ring-1 ring-inset ring-emerald-400/30">
            New
          </span>
        )
      }
      {
        isHome && isUpdated && (
          <span class="ml-1 align-middle rounded-full bg-amber-400/10 px-2 py-0.5 text-xs font-semibold text-amber-300 ring-1 ring-inset ring-amber-400/30">
            Updated
          </span>
        )
      }
    </div>

    <div class="relative mt-1 text-sm text-neutral-200">
      <span
        class="date-display"
        data-published={fmt(item.date_published ?? undefined)}
        data-added={fmt(item.date_added ?? undefined)}
      >
        <span class="date-label text-neutral-400">Published</span>
        <span class="date-value">{fmt(item.date_published ?? undefined)}</span>
      </span>
      {item.source_name && <span> · {item.source_name}</span>}
      {item.authors?.length > 0 && <span> · {item.authors[0]}</span>}
    </div>

    <!-- Collapsed view: Thumbnail + short summary -->
    <div class="card-collapsed">
      <!-- Thumbnail area (fixed height) -->
      <div
        class="relative mt-2 w-full rounded-md border border-neutral-800 bg-neutral-800/40"
        style="aspect-ratio: 16 / 9; overflow: hidden;"
      >
        {
          hasImage ? (
            <>
              <div class="absolute inset-0 rounded-md bg-neutral-800/40" />
              <img
                src={candidates[0]}
                data-next={candidates.slice(1).join('|')}
                alt={`${item.source_name || 'Source'} preview`}
                width={isFirst ? 960 : 640}
                height={isFirst ? 540 : 360}
                loading={isFirst ? 'eager' : 'lazy'}
                fetchpriority={isFirst ? 'high' : 'auto'}
                decoding="async"
                referrerpolicy="no-referrer"
                sizes="(min-width: 1024px) 560px, (min-width: 640px) 480px, 100vw"
                class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-300"
              />
            </>
          ) : (
            <div class="absolute inset-0 flex items-center justify-center">
              <svg
                class="h-10 w-10 text-neutral-700"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                />
              </svg>
            </div>
          )
        }
      </div>

      {
        item.summary_short && (
          <p class="mt-2 text-sm text-neutral-300 line-clamp-2">{item.summary_short}</p>
        )
      }
    </div>

    <!-- Expanded view: Medium summary + all tags -->
    <div class="card-expanded hidden">
      <div
        class="mt-2 max-h-48 overflow-y-auto rounded-md border border-neutral-800 bg-neutral-800/40 p-3"
      >
        {
          item.summary_medium ? (
            <p class="text-sm text-neutral-300">{item.summary_medium}</p>
          ) : (
            <p class="text-sm text-neutral-500 italic">No summary available</p>
          )
        }
      </div>

      <!-- All tags when expanded -->
      <div class="mt-3 flex flex-wrap gap-1.5">
        {
          audiences.map((a: string) => (
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-amber-500/10 text-amber-300 ring-1 ring-inset ring-amber-500/20">
              {a}
            </span>
          ))
        }
        {
          geographies.map((g: string) => (
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-teal-500/10 text-teal-300 ring-1 ring-inset ring-teal-500/20">
              {g}
            </span>
          ))
        }
        {
          industries.map((i: string) => (
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-500/10 text-blue-300 ring-1 ring-inset ring-blue-500/20">
              {i}
            </span>
          ))
        }
        {
          topic.map((t: string) => (
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-violet-500/10 text-violet-300 ring-1 ring-inset ring-violet-500/20">
              {t}
            </span>
          ))
        }
        {
          regulators.map((r: string) => (
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-rose-500/10 text-rose-300 ring-1 ring-inset ring-rose-500/20">
              {r}
            </span>
          ))
        }
        {
          regulations.map((r: string) => (
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-orange-500/10 text-orange-300 ring-1 ring-inset ring-orange-500/20">
              {r}
            </span>
          ))
        }
        {
          processes.map((p: string) => (
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-cyan-500/10 text-cyan-300 ring-1 ring-inset ring-cyan-500/20">
              {p}
            </span>
          ))
        }
      </div>
    </div>

    <!-- Tags row with Preview button aligned - pushed to bottom -->
    <div class="mt-auto pt-3 flex items-start justify-between gap-2">
      <div class="flex flex-wrap items-center gap-1.5 flex-1 min-w-0">
        {/* Card view: audience + geography only */}
        {
          audience && (
            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-500/10 text-amber-300 ring-1 ring-inset ring-amber-500/20">
              <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                />
              </svg>
              {audience}
            </span>
          )
        }
        {
          geography && (
            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-teal-500/10 text-teal-300 ring-1 ring-inset ring-teal-500/20">
              <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              {geography}
            </span>
          )
        }
        {/* +X indicator for extra tags - expands card */}
        {
          extraTagCount > 0 && (
            <button
              type="button"
              data-expand-card="true"
              class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-neutral-700/50 text-neutral-400 ring-1 ring-inset ring-neutral-600/30 hover:bg-neutral-600/50 hover:text-neutral-300 transition-colors pointer-events-auto"
            >
              +{extraTagCount} more
            </button>
          )
        }
      </div>

      <!-- Expand/Collapse button -->
      <button
        class="relative z-30 flex-shrink-0 inline-flex items-center gap-1 text-xs text-sky-300 hover:text-sky-200 transition-colors px-2 py-0.5 rounded hover:bg-neutral-800/50 pointer-events-auto"
        type="button"
        data-expand-card="true"
        aria-label="Expand card"
      >
        <span class="expand-label">Expand</span>
        <span class="collapse-label hidden">Collapse</span>
      </button>
    </div>
  </div>
</li>
