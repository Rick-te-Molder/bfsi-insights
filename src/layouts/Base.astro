---
import ResourceModal from '../features/resources/ResourceModal.astro';

const {
  title = 'BFSI Insights',
  description = 'Agentic AI insights for executives and professionals in banking, financial services and insurance.',
} = Astro.props;
const origin = Astro.site?.origin ?? '';
const canonical = origin + Astro.url.pathname;
---

<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <link rel="alternate" type="application/rss+xml" title="BFSI Insights RSS" href="/feed.xml" />
    <link
      rel="icon"
      type="image/svg+xml"
      sizes="any"
      href="/favicon-light.svg?v=2"
      media="(prefers-color-scheme: light)"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      sizes="any"
      href="/favicon-dark.svg?v=2"
      media="(prefers-color-scheme: dark)"
    />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#111111" />
    <slot name="head" />
  </head>
  <body class="min-h-screen bg-neutral-950 text-neutral-200 antialiased">
    <header class="border-b border-neutral-800">
      <div class="mx-auto max-w-5xl px-4 py-4 flex items-center justify-between">
        <a
          href="/"
          aria-label="BFSI Insights home"
          class="group inline-flex flex-col items-center leading-none"
        >
          <span class="text-xl font-normal tracking-tight text-neutral-900 dark:text-white"
            >BFSI</span
          >
          <span class="-mt-0.5 text-sm font-bold uppercase text-sky-400">insights</span>
        </a>
        <nav class="text-sm">
          <a href="/" class="text-neutral-300 hover:text-white hover:underline">Home</a>
          <span class="mx-2 text-neutral-600">·</span>
          <a href="/resources" class="text-neutral-300 hover:text-white hover:underline"
            >Resources</a
          >
          <span class="mx-2 text-neutral-600">·</span>
          <a href="/external-resources" class="text-neutral-300 hover:text-white hover:underline"
            >External</a
          >
        </nav>
      </div>
    </header>
    <main class="mx-auto max-w-5xl px-4 py-8">
      <slot />
    </main>
    <footer class="border-t border-neutral-800">
      <div
        class="mx-auto max-w-5xl px-4 py-6 text-xs text-neutral-400 flex items-center justify-between"
      >
        <a
          href="https://www.rtminnovations.com/"
          target="_blank"
          rel="noopener"
          class="hover:underline">&copy; {2025} RTM INNOVATIONS</a
        >
        <nav class="space-x-4">
          <a href="/feed.xml" class="hover:underline">RSS feed</a>
          <a href="/updates.json" class="hover:underline">Updates JSON</a>
        </nav>
      </div>
    </footer>
    <ResourceModal />
    <script type="module">
      import { marked } from 'https://cdn.jsdelivr.net/npm/marked@11/+esm';

      (function () {
        marked.setOptions({
          breaks: true,
          gfm: true,
        });

        const parseNote = (text) => {
          if (!text) return '';
          return marked.parse(text.replace(/\(more\)\s*$/, ''));
        };

        let lastFocus = null;
        const openModal = (li) => {
          const modal = document.getElementById('modal');
          if (!modal) return;

          lastFocus = document.activeElement;
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';

          const title = li.querySelector('a')?.textContent || '';
          const detailHref = li.querySelector('a')?.href || '#';

          const titleText = document.getElementById('modal-title-text');
          if (titleText) titleText.textContent = title;

          // Populate metadata
          const authors = li.getAttribute('data-authors') || '';
          const sourceName = li.getAttribute('data-source_name') || '';
          const metaEl = document.getElementById('modal-meta');
          if (metaEl) {
            const parts = [];
            if (authors) parts.push(authors);
            if (sourceName) parts.push(sourceName);
            metaEl.textContent = parts.join(' • ');
          }

          // Populate tags
          const tagsEl = document.getElementById('modal-tags');
          if (tagsEl) {
            tagsEl.innerHTML = '';
            const role = li.getAttribute('data-role');
            const industry = li.getAttribute('data-industry');
            const topic = li.getAttribute('data-topic');
            const contentType = li.getAttribute('data-content_type');
            const jurisdiction = li.getAttribute('data-jurisdiction');

            const addTag = (text) => {
              if (text) {
                const tag = document.createElement('span');
                tag.className =
                  'rounded-md border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-neutral-300';
                tag.textContent = text;
                tagsEl.appendChild(tag);
              }
            };

            addTag(role);
            addTag(industry);
            addTag(topic);
            addTag(contentType);
            addTag(jurisdiction);
          }

          const summaryMedium = li.getAttribute('data-summary-medium') || '';
          const noteEl = document.getElementById('modal-note');
          if (noteEl) noteEl.innerHTML = parseNote(summaryMedium);

          // Update view details link
          const viewDetailsBtn = document.getElementById('modal-view-details');
          if (viewDetailsBtn) viewDetailsBtn.href = detailHref;
        };

        const closeModal = () => {
          const modal = document.getElementById('modal');
          if (modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            if (lastFocus) lastFocus.focus();
          }
        };

        document.getElementById('modal-close')?.addEventListener('click', closeModal);
        document.getElementById('modal-backdrop')?.addEventListener('click', closeModal);
        window.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeModal();
        });

        document.addEventListener('click', (e) => {
          // Handle Preview button clicks
          const btn = e.target.closest('[data-open-modal]');
          if (btn) {
            e.preventDefault();
            e.stopPropagation();
            const card = btn.closest('li');
            if (card) openModal(card);
            return;
          }
        });
      })();
    </script>
  </body>
</html>
