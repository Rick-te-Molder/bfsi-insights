---
import ResourceModal from '../features/resources/ResourceModal.astro';

const {
  title = 'BFSI Insights',
  description = 'Agentic AI insights for executives and professionals in banking, financial services and insurance.',
} = Astro.props;
const origin = Astro.site?.origin ?? '';
const canonical = origin + Astro.url.pathname;
const pathname = Astro.url.pathname;

// Navigation items
const navItems = [
  { href: '/', label: 'Home' },
  { href: '/resources', label: 'Resources' },
  { href: '/external-resources', label: 'External' },
];

const isActive = (href: string) => {
  if (href === '/') return pathname === '/';
  return pathname.startsWith(href);
};
---

<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <link rel="alternate" type="application/rss+xml" title="BFSI Insights RSS" href="/feed.xml" />
    <link
      rel="icon"
      type="image/svg+xml"
      sizes="any"
      href="/favicon-light.svg?v=2"
      media="(prefers-color-scheme: light)"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      sizes="any"
      href="/favicon-dark.svg?v=2"
      media="(prefers-color-scheme: dark)"
    />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#111111" />
    <slot name="head" />
  </head>
  <body class="min-h-screen bg-neutral-950 text-neutral-200 antialiased">
    <header class="border-b border-neutral-800">
      <div class="mx-auto max-w-5xl px-4 py-4 flex items-center justify-between">
        <a
          href="/"
          aria-label="BFSI Insights home"
          class="group inline-flex flex-col items-center leading-none"
        >
          <span class="text-xl font-normal tracking-tight text-neutral-900 dark:text-white"
            >BFSI</span
          >
          <span class="-mt-0.5 text-sm font-bold uppercase text-sky-400">insights</span>
        </a>

        <!-- Desktop Navigation -->
        <nav class="hidden sm:flex items-center gap-1 text-sm" aria-label="Main navigation">
          {
            navItems.map((item, idx) => (
              <>
                {idx > 0 && (
                  <span class="mx-2 text-neutral-700" aria-hidden="true">
                    |
                  </span>
                )}
                <a
                  href={item.href}
                  class:list={[
                    'px-3 py-1.5 rounded-md transition-colors',
                    isActive(item.href)
                      ? 'text-sky-400 font-medium border-b-2 border-sky-400'
                      : 'text-neutral-300 hover:text-white hover:bg-neutral-800',
                  ]}
                  aria-current={isActive(item.href) ? 'page' : undefined}
                >
                  {item.label}
                </a>
              </>
            ))
          }
        </nav>

        <!-- Mobile Menu Button -->
        <button
          id="mobile-menu-btn"
          type="button"
          class="sm:hidden flex items-center justify-center w-10 h-10 rounded-md text-neutral-300 hover:text-white hover:bg-neutral-800 transition-colors"
          aria-expanded="false"
          aria-controls="mobile-menu"
          aria-label="Open menu"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>

      <!-- Mobile Menu Overlay -->
      <div
        id="mobile-menu-overlay"
        class="fixed inset-0 bg-black/60 z-40 hidden sm:hidden"
        aria-hidden="true"
      >
      </div>

      <!-- Mobile Menu Panel -->
      <nav
        id="mobile-menu"
        class="fixed top-0 right-0 bottom-0 w-64 bg-neutral-900 border-l border-neutral-800 z-50 transform translate-x-full transition-transform duration-300 ease-in-out sm:hidden"
        aria-label="Mobile navigation"
      >
        <div class="flex items-center justify-between p-4 border-b border-neutral-800">
          <span class="text-sm font-medium text-neutral-200">Menu</span>
          <button
            id="mobile-menu-close"
            type="button"
            class="flex items-center justify-center w-8 h-8 rounded-md text-neutral-400 hover:text-white hover:bg-neutral-800 transition-colors"
            aria-label="Close menu"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="flex flex-col p-4 space-y-1">
          {
            navItems.map((item) => (
              <a
                href={item.href}
                class:list={[
                  'px-4 py-3 rounded-md text-sm transition-colors',
                  isActive(item.href)
                    ? 'bg-sky-400/10 text-sky-400 font-medium'
                    : 'text-neutral-300 hover:bg-neutral-800 hover:text-white',
                ]}
                aria-current={isActive(item.href) ? 'page' : undefined}
              >
                {item.label}
              </a>
            ))
          }
        </div>
      </nav>
    </header>
    <main class="mx-auto max-w-5xl px-4 py-8">
      <slot />
    </main>
    <footer class="border-t border-neutral-800">
      <div
        class="mx-auto max-w-5xl px-4 py-6 text-xs text-neutral-400 flex items-center justify-between"
      >
        <a
          href="https://www.rtminnovations.com/"
          target="_blank"
          rel="noopener"
          class="hover:underline">&copy; {2025} RTM INNOVATIONS</a
        >
        <nav class="space-x-4">
          <a href="/feed.xml" class="hover:underline">RSS feed</a>
          <a href="/updates.json" class="hover:underline">Updates JSON</a>
        </nav>
      </div>
    </footer>
    <ResourceModal />
    <script type="module">
      import { marked } from 'https://cdn.jsdelivr.net/npm/marked@11/+esm';

      (function () {
        marked.setOptions({
          breaks: true,
          gfm: true,
        });

        const parseNote = (text) => {
          if (!text) return '';
          return marked.parse(text.replace(/\(more\)\s*$/, ''));
        };

        let lastFocus = null;
        const openModal = (li) => {
          const modal = document.getElementById('modal');
          if (!modal) return;

          lastFocus = document.activeElement;
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';

          const title = li.querySelector('a')?.textContent || '';
          const detailHref = li.querySelector('a')?.href || '#';

          const titleText = document.getElementById('modal-title-text');
          if (titleText) titleText.textContent = title;

          // Populate metadata
          const authors = li.getAttribute('data-authors') || '';
          const sourceName = li.getAttribute('data-source_name') || '';
          const metaEl = document.getElementById('modal-meta');
          if (metaEl) {
            const parts = [];
            if (authors) parts.push(authors);
            if (sourceName) parts.push(sourceName);
            metaEl.textContent = parts.join(' â€¢ ');
          }

          // Populate tags
          const tagsEl = document.getElementById('modal-tags');
          if (tagsEl) {
            tagsEl.innerHTML = '';
            const role = li.getAttribute('data-role');
            const industry = li.getAttribute('data-industry');
            const topic = li.getAttribute('data-topic');
            const contentType = li.getAttribute('data-content_type');
            const jurisdiction = li.getAttribute('data-jurisdiction');

            const addTag = (text) => {
              if (text) {
                const tag = document.createElement('span');
                tag.className =
                  'rounded-md border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-neutral-300';
                tag.textContent = text;
                tagsEl.appendChild(tag);
              }
            };

            addTag(role);
            addTag(industry);
            addTag(topic);
            addTag(contentType);
            addTag(jurisdiction);
          }

          const summaryMedium = li.getAttribute('data-summary-medium') || '';
          const noteEl = document.getElementById('modal-note');
          if (noteEl) noteEl.innerHTML = parseNote(summaryMedium);

          // Update view details link
          const viewDetailsBtn = document.getElementById('modal-view-details');
          if (viewDetailsBtn) viewDetailsBtn.href = detailHref;
        };

        const closeModal = () => {
          const modal = document.getElementById('modal');
          if (modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            if (lastFocus) lastFocus.focus();
          }
        };

        document.getElementById('modal-close')?.addEventListener('click', closeModal);
        document.getElementById('modal-backdrop')?.addEventListener('click', closeModal);
        window.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeModal();
        });

        document.addEventListener('click', (e) => {
          // Handle Preview button clicks
          const btn = e.target.closest('[data-open-modal]');
          if (btn) {
            e.preventDefault();
            e.stopPropagation();
            const card = btn.closest('li');
            if (card) openModal(card);
            return;
          }
        });

        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuClose = document.getElementById('mobile-menu-close');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');

        const openMobileMenu = () => {
          if (!mobileMenu || !mobileMenuOverlay || !mobileMenuBtn) return;
          mobileMenu.classList.remove('translate-x-full');
          mobileMenuOverlay.classList.remove('hidden');
          mobileMenuBtn.setAttribute('aria-expanded', 'true');
          mobileMenuBtn.setAttribute('aria-label', 'Close menu');
          document.body.style.overflow = 'hidden';
          // Focus first link
          const firstLink = mobileMenu.querySelector('a');
          if (firstLink) setTimeout(() => firstLink.focus(), 100);
        };

        const closeMobileMenu = () => {
          if (!mobileMenu || !mobileMenuOverlay || !mobileMenuBtn) return;
          mobileMenu.classList.add('translate-x-full');
          mobileMenuOverlay.classList.add('hidden');
          mobileMenuBtn.setAttribute('aria-expanded', 'false');
          mobileMenuBtn.setAttribute('aria-label', 'Open menu');
          document.body.style.overflow = '';
          // Return focus to button
          mobileMenuBtn.focus();
        };

        mobileMenuBtn?.addEventListener('click', () => {
          const isOpen = mobileMenuBtn.getAttribute('aria-expanded') === 'true';
          if (isOpen) closeMobileMenu();
          else openMobileMenu();
        });

        mobileMenuClose?.addEventListener('click', closeMobileMenu);
        mobileMenuOverlay?.addEventListener('click', closeMobileMenu);

        // Close menu on Escape
        window.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            closeModal();
            closeMobileMenu();
          }
        });

        // Close mobile menu on navigation
        mobileMenu?.addEventListener('click', (e) => {
          if (e.target.tagName === 'A') {
            closeMobileMenu();
          }
        });
      })();
    </script>
  </body>
</html>
